<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>HEARTBEAT™ - Cardiac Surgery Recovery Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/10.6.4/math.min.js"></script> <!-- Added for enhanced analytics -->
    <style>
        :root {
            --bg: #0a0e1a;
            --card: #111827;
            --card-light: #1a2332;
            --ink: #e5e7eb;
            --muted: #9ca3af;
            --accent: #60a5fa;
            --good: #22c55e;
            --warn: #f59e0b;
            --bad: #ef4444;
            --purple: #a78bfa;
            --cyan: #06b6d4;
            --pink: #ec4899;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0
        }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg), #0d1420 50%, #060812);
            color: var(--ink);
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px
        }

        header {
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.2), rgba(96, 165, 250, 0.2));
            border: 2px solid rgba(236, 72, 153, 0.3);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(236, 72, 153, 0.3);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '💓';
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 6rem;
            opacity: 0.15;
            animation: heartbeat 1.5s ease-in-out infinite;
        }

        @keyframes heartbeat {
            0%,
            100% {
                transform: translateY(-50%) scale(1);
            }

            25% {
                transform: translateY(-50%) scale(1.1);
            }

            50% {
                transform: translateY(-50%) scale(1);
            }
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            position: relative;
            z-index: 1
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px
        }

        .heart-icon {
            font-size: 3.5rem;
            animation: heartbeat 1.5s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(236, 72, 153, 0.6));
        }

        h1 {
            margin: 0;
            font-size: clamp(24px, 3.5vw, 32px);
            font-weight: 800;
            letter-spacing: 0.5px;
            background: linear-gradient(135deg, var(--pink), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text
        }

        .app-subtitle {
            color: var(--cyan);
            font-size: 0.95rem;
            font-weight: 600;
            margin-top: 6px;
            letter-spacing: 0.3px
        }

        .patient-info {
            color: var(--muted);
            font-size: 0.95rem;
            margin-top: 4px
        }

        .date-display {
            background: rgba(255, 255, 255, 0.06);
            padding: 10px 18px;
            border-radius: 10px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button,
        select {
            appearance: none;
            background: rgba(96, 165, 250, 0.15);
            border: 1px solid rgba(96, 165, 250, 0.3);
            color: var(--ink);
            padding: 10px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        button:hover {
            background: rgba(96, 165, 250, 0.25);
            transform: translateY(-1px)
        }

        button:active {
            transform: translateY(0)
        }

        select {
            background: rgba(255, 255, 255, 0.08);
            color: #ffffff;
        }

        select option {
            background: #1f2937;
            color: #ffffff;
            padding: 8px;
        }

        .legend {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-left: auto;
        }

        .pill {
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .pill.good {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.4)
        }

        .pill.warn {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid rgba(245, 158, 11, 0.4)
        }

        .pill.bad {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4)
        }

        .pill.active {
            box-shadow: 0 0 10px currentColor;
            animation: glow 2s infinite
        }

        @keyframes glow {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0.7
            }
        }

        .entry-form {
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .section {
            margin-bottom: 28px;
            padding-bottom: 28px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            color: var(--accent);
            font-weight: 700;
            font-size: 1.1rem;
            letter-spacing: 0.3px;
        }

        .section-icon {
            font-size: 1.3rem
        }

        .section-badge {
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: auto;
        }

        .section-badge.good {
            background: var(--good);
            color: #fff
        }

        .section-badge.warn {
            background: var(--warn);
            color: #000
        }

        .section-badge.bad {
            background: var(--bad);
            color: #fff
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .form-grid.cols-2 {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr))
        }

        .form-grid.cols-3 {
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr))
        }

        .form-grid.cols-4 {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr))
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px
        }

        .field label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .field input,
        .field select,
        .field textarea {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: var(--ink);
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.2s;
        }

        .field input:focus,
        .field select:focus,
        .field textarea:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.06);
        }

        .field textarea {
            resize: vertical;
            min-height: 80px
        }

        .field input::placeholder {
            color: #6b7280
        }

        .pain-scale,
        .wellbeing-scale,
        .adl-scale {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .pain-btn,
        .wellbeing-btn,
        .adl-btn {
            flex: 1;
            min-width: 45px;
            padding: 10px 8px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.2s;
        }

        .pain-btn:hover,
        .wellbeing-btn:hover,
        .adl-btn:hover {
            background: rgba(255, 255, 255, 0.08)
        }

        .pain-btn.selected,
        .wellbeing-btn.selected,
        .adl-btn.selected {
            background: var(--accent);
            border-color: var(--accent);
            color: #000;
        }

        .pain-btn.selected.high {
            background: var(--bad);
            border-color: var(--bad);
            color: #fff
        }

        .wellbeing-btn.selected.high,
        .adl-btn.selected.high {
            background: var(--good);
            border-color: var(--good);
            color: #fff
        }

        .wellbeing-btn.selected.low,
        .adl-btn.selected.low {
            background: var(--bad);
            border-color: var(--bad);
            color: #fff
        }

        .submit-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 2px solid rgba(236, 72, 153, 0.3);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--pink), var(--purple));
            border: none;
            padding: 12px 32px;
            font-size: 1rem;
            font-weight: 700;
            color: #fff;
        }

        .btn-primary:hover {
            box-shadow: 0 4px 20px rgba(236, 72, 153, 0.5);
        }

        .history {
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .history h2 {
            margin: 0;
            font-size: 1.4rem;
            color: var(--pink)
        }

        .entries {
            max-height: 600px;
            overflow-y: auto;
            margin-top: 16px
        }

        .entry-card {
            background: var(--card-light);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .entry-card:hover {
            border-color: rgba(236, 72, 153, 0.4);
            transform: translateX(2px);
        }

        .entry-card.pinned {
            border-color: var(--accent);
            background: var(--card-light)
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .entry-date {
            font-weight: 700;
            color: var(--pink);
            font-size: 1rem
        }

        .entry-time {
            color: var(--muted);
            font-size: 0.9rem
        }

        .entry-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            font-size: 0.9rem;
        }

        .data-point {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .data-label {
            color: var(--muted);
            font-size: 0.85rem;
            font-weight: 500
        }

        .data-value {
            font-weight: 600;
            font-size: 0.95rem
        }

        .alert-summary {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            color: var(--bad);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .recovery-score-display {
            background: linear-gradient(135deg, rgba(96, 165, 250, 0.2), rgba(167, 139, 250, 0.2));
            border: 2px solid rgba(96, 165, 250, 0.4);
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .recovery-score-display.excellent {
            border-color: var(--good);
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(6, 182, 212, 0.15))
        }

        .recovery-score-display.good {
            border-color: var(--cyan);
            background: rgba(6, 182, 212, 0.15)
        }

        .recovery-score-display.fair {
            border-color: var(--warn);
            background: rgba(245, 158, 11, 0.15)
        }

        .recovery-score-display.poor {
            border-color: var(--bad);
            background: rgba(239, 68, 68, 0.15)
        }

        .recovery-score-display.critical {
            border-color: #dc2626;
            background: rgba(220, 38, 38, 0.2);
            animation: pulse 2s infinite
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .score-number {
            font-size: 3rem;
            font-weight: 800;
            line-height: 1;
        }

        .score-grade {
            font-size: 1.2rem;
            font-weight: 700;
            margin-top: 4px;
        }

        .score-label {
            font-size: 0.9rem;
            color: var(--muted);
            margin-top: 2px;
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--muted);
        }

        .helper-text {
            font-size: 0.85rem;
            color: var(--muted);
            margin-top: 4px;
            font-style: italic;
        }

        .error-text {
            font-size: 0.85rem;
            color: var(--bad);
            margin-top: 4px;
        }

        .medication-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 12px;
            align-items: end;
        }

        .walking-session {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }

        .walking-session input {
            flex: 1;
        }

        .add-session-btn {
            padding: 8px 12px;
            font-size: 0.85rem;
        }

        .footer-brand {
            text-align: center;
            margin-top: 40px;
            padding: 24px;
            border-top: 2px solid rgba(236, 72, 153, 0.3);
            color: var(--muted);
        }

        .brand-name {
            font-size: 1.2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--pink), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
        }

        .brand-tagline {
            font-size: 0.9rem;
            color: var(--cyan);
            font-weight: 600;
        }

        @media print {

            body {
                background: #fff;
                color: #000
            }

            .controls,
            .submit-section {
                display: none
            }

            .entry-form {
                border: 1px solid #ccc
            }
        }

        @media (max-width:768px) {

            .form-grid {
                grid-template-columns: 1fr
            }

            .form-grid.cols-2,
            .form-grid.cols-3,
            .form-grid.cols-4 {
                grid-template-columns: 1fr
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start
            }

            header::before {
                font-size: 4rem;
                right: 10px
            }
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .checkbox-item:hover {
            background: rgba(255, 255, 255, 0.08)
        }

        .checkbox-item input[type="checkbox"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .checkbox-item.checked {
            background: rgba(96, 165, 250, 0.2);
            border-color: var(--accent);
        }

        .cycle-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            background: rgba(167, 139, 250, 0.2);
            border: 1px solid rgba(167, 139, 250, 0.4);
        }

        .adl-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .adl-item-header {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--cyan);
            margin-bottom: 10px;
        }

        .med-adherence-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .med-adherence-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .med-name {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--cyan);
        }

        .adherence-status {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .adherence-status.compliant {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.4);
            color: var(--good);
        }

        .adherence-status.missed {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid rgba(245, 158, 11, 0.4);
            color: var(--warn);
        }

        .adherence-status.skipped {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: var(--bad);
        }

        .dose-tracker {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .dose-slot {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dose-slot:hover {
            background: rgba(255, 255, 255, 0.08)
        }

        .dose-slot.taken {
            background: rgba(34, 197, 94, 0.2);
            border-color: var(--good);
            color: var(--good);
        }

        .dose-slot.missed {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--bad);
            color: var(--bad);
        }

        .vitamin-k-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .vitamin-k-food {
            font-weight: 600;
            color: var(--cyan);
        }

        .vitamin-k-level {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .vitamin-k-level.high {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--bad);
            color: var(--bad);
        }

        .vitamin-k-level.moderate {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid var(--warn);
            color: var(--warn);
        }

        .vitamin-k-level.low {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid var(--good);
            color: var(--good);
        }

        .wound-photo-upload {
            margin-top: 12px;
            padding: 16px;
            background: rgba(96, 165, 250, 0.05);
            border: 2px dashed rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            text-align: center;
        }

        .wound-photo-upload input[type="file"] {
            display: none;
        }

        .upload-btn {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .photo-preview {
            margin-top: 12px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .photo-preview img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .complication-warning {
            background: rgba(239, 68, 68, 0.15);
            border: 2px solid var(--bad);
            border-radius: 10px;
            padding: 16px;
            margin-top: 12px;
            font-weight: 600;
        }

        .side-effect-tracker {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .side-effect-header {
            font-weight: 600;
            color: var(--cyan);
            margin-bottom: 8px;
        }

        .severity-scale {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .severity-btn {
            flex: 1;
            padding: 6px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 6px;
            font-size: 0.8rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .severity-btn:hover {
            background: rgba(255, 255, 255, 0.08)
        }

        .severity-btn.selected {
            background: var(--warn);
            border-color: var(--warn);
            color: #000;
            font-weight: 700;
        }

        .severity-btn.selected.severe {
            background: var(--bad);
            border-color: var(--bad);
            color: #fff;
        }

        .phq9-question {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .phq9-question-text {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--ink);
            margin-bottom: 10px;
        }

        .phq9-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .phq9-option {
            flex: 1;
            min-width: 120px;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .phq9-option:hover {
            background: rgba(255, 255, 255, 0.08)
        }

        .phq9-option.selected {
            background: var(--accent);
            border-color: var(--accent);
            color: #000;
            font-weight: 600;
        }

        .phq9-score-display {
            background: linear-gradient(135deg, rgba(96, 165, 250, 0.2), rgba(167, 139, 250, 0.2));
            border: 2px solid rgba(96, 165, 250, 0.4);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            text-align: center;
        }

        .phq9-score-display.minimal {
            border-color: var(--good);
            background: rgba(34, 197, 94, 0.15)
        }

        .phq9-score-display.mild {
            border-color: var(--cyan);
            background: rgba(6, 182, 212, 0.15)
        }

        .phq9-score-display.moderate {
            border-color: var(--warn);
            background: rgba(245, 158, 11, 0.15)
        }

        .phq9-score-display.moderately-severe {
            border-color: var(--bad);
            background: rgba(239, 68, 68, 0.15)
        }

        .phq9-score-display.severe {
            border-color: #dc2626;
            background: rgba(220, 38, 38, 0.2);
            animation: pulse 2s infinite
        }

        .phq9-score-number {
            font-size: 2.5rem;
            font-weight: 800;
            line-height: 1;
        }

        .phq9-score-severity {
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: 8px;
        }

        .phq9-crisis-box {
            background: rgba(220, 38, 38, 0.2);
            border: 3px solid var(--bad);
            border-radius: 12px;
            padding: 20px;
            margin-top: 16px;
            text-align: center;
        }

        .phq9-crisis-title {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--bad);
            margin-bottom: 12px;
        }

        .phq9-crisis-number {
            font-size: 2rem;
            font-weight: 800;
            color: #fff;
            margin: 12px 0;
            padding: 12px;
            background: var(--bad);
            border-radius: 8px;
        }

        .exercise-comparison {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .exercise-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .exercise-metric:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0
        }

        .exercise-metric-name {
            font-weight: 600;
            color: var(--cyan);
        }

        .exercise-values {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .exercise-value {
            text-align: center;
        }

        .exercise-value-label {
            font-size: 0.75rem;
            color: var(--muted);
            text-transform: uppercase;
        }

        .exercise-value-number {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .exercise-achievement {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .exercise-achievement.exceeded {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid var(--good);
            color: var(--good);
        }

        .exercise-achievement.met {
            background: rgba(6, 182, 212, 0.2);
            border: 1px solid var(--cyan);
            color: var(--cyan);
        }

        .exercise-achievement.below {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid var(--warn);
            color: var(--warn);
        }

        .provider-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .provider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .provider-name {
            font-size: 1rem;
            font-weight: 700;
            color: var(--cyan);
        }

        .provider-status {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .provider-status.current {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid var(--good);
            color: var(--good);
        }

        .provider-status.upcoming {
            background: rgba(6, 182, 212, 0.2);
            border: 1px solid var(--cyan);
            color: var(--cyan);
        }

        .provider-status.overdue {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--bad);
            color: var(--bad);
        }

        .inr-history-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .inr-date {
            font-weight: 600;
            color: var(--cyan);
        }

        .inr-details {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .inr-value {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .inr-dose {
            font-size: 0.9rem;
            color: var(--muted);
        }

        .inr-status {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .inr-status.therapeutic {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid var(--good);
            color: var(--good);
        }

        .inr-status.subtherapeutic {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid var(--warn);
            color: var(--warn);
        }

        .inr-status.supratherapeutic {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--bad);
            color: var(--bad);
        }

        .device-reading {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .device-name {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--cyan);
        }

        .device-timestamp {
            font-size: 0.8rem;
            color: var(--muted);
        }

        .device-metrics {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .device-metric {
            flex: 1;
            min-width: 120px;
        }

        .device-metric-label {
            font-size: 0.8rem;
            color: var(--muted);
        }

        .device-metric-value {
            font-size: 1.2rem;
            font-weight: 700;
        }

        /* Tab Styles */

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: rgba(96, 165, 250, 0.15);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            color: var(--ink);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
        }

        .tab-btn:hover {
            background: rgba(96, 165, 250, 0.25);
        }

        .tab-btn:focus {
            outline: 2px solid var(--accent);
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* History Controls */

        .history-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Charts */

        .charts {
            margin-bottom: 24px;
        }

        .charts canvas {
            max-height: 300px;
            margin-bottom: 24px;
        }

        /* SR-only for accessibility */

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Modal Styles */

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5)
        }

        .modal-content {
            background: var(--card);
            margin: 5% auto;
            padding: 32px;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5)
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            color: var(--muted);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer
        }

        .close:hover {
            color: var(--ink)
        }

        .scoring-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px
        }

        .scoring-table th,
        .scoring-table td {
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px;
            text-align: left
        }

        .scoring-table th {
            background: rgba(96, 165, 250, 0.1);
            color: var(--accent)
        }

        .accordion details {
            margin-bottom: 12px
        }

        .accordion summary {
            cursor: pointer;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px
        }

        .accordion input[type=range] {
            width: 100%;
            margin: 8px 0
        }

        .review-context-btn {
            margin-bottom: 12px;
            padding: 8px 16px;
            background: var(--accent);
            color: #000;
            border: none;
            border-radius: 8px;
            cursor: pointer
        }

        .context-pill {
            display: inline-block;
            background: rgba(96, 165, 250, 0.2);
            padding: 4px 8px;
            border-radius: 999px;
            margin: 2px;
            font-size: 0.85rem
        }

        .saved-indicator {
            display: inline-block;
            margin-left: 8px;
            color: var(--good);
            font-size: 0.8rem
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--good);
            color: #fff;
            padding: 16px 20px;
            border-radius: 8px;
            z-index: 1001;
            animation: fadeInOut 3s forwards
        }

        @keyframes fadeInOut {

            0% {
                opacity: 0;
                transform: translateY(20px)
            }

            10% {
                opacity: 1;
                transform: translateY(0)
            }

            90% {
                opacity: 1;
                transform: translateY(0)
            }

            100% {
                opacity: 0;
                transform: translateY(20px)
            }
        }

        .dashboard-pills {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap
        }

        .dashboard-pill {
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600
        }

        .dashboard-pill.good {
            background: var(--good);
            color: #fff
        }

        .dashboard-pill.warn {
            background: var(--warn);
            color: #000
        }

        .dashboard-pill.bad {
            background: var(--bad);
            color: #fff
        }

        .post-surgical-collapsible {
            margin-top: 12px
        }

        .post-surgical-content {
            display: none;
            padding: 16px;
            background: var(--card-light);
            border-radius: 8px
        }

        .post-surgical-content.open {
            display: block
        }

        .toggle-collapse {
            padding: 4px 8px;
            background: var(--accent);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 8px
        }

        .info-icon {
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--accent);
            margin-left: 16px
        }

        .why-status {
            display: none;
            padding: 12px;
            background: rgba(96, 165, 250, 0.1);
            border-radius: 8px;
            margin-top: 8px
        }

        .why-status.open {
            display: block
        }

        /* Added for enhanced analytics */

        .analytics-section {
            background: var(--card-light);
            border-radius: 12px;
            padding: 16px;
            margin-top: 24px;
        }

        .correlation-matrix {
            margin-top: 16px;
        }

        .trend-alert {
            color: var(--warn);
            font-weight: 600;
            margin-top: 12px;
        }

        /* Device integration styles */

        .device-connect-btn {
            background: var(--cyan);
            color: #000;
            padding: 8px 16px;
            border-radius: 8px;
            margin-left: 8px;
        }

        .device-status {
            font-size: 0.85rem;
            color: var(--muted);
            margin-top: 4px;
        }
    </style>
    <!-- Firebase SDK for Backend Integration (Session 4 Feature 14) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-left">
                    <div class="heart-icon">💓</div>
                    <div>
                        <h1>HEARTBEAT™</h1>
                        <div class="app-subtitle">Healing Evaluation & Assessment for Recovery Tracking</div>
                        <div class="patient-info" id="patientInfo">Cardiac Surgery Recovery Tracker</div>
                        <div class="field" style="margin-top:8px">
                            <label for="customCondition" class="sr-only">Custom Patient Condition</label>
                            <input type="text" id="customCondition" placeholder="Enter your condition (e.g., Valve Surgery, Pacemaker)" style="width:100%;max-width:400px">
                        </div>
                    </div>
                </div>
                <div style="display:flex;align-items:center;gap:8px">
                    <div class="date-display" id="currentDate"></div>
                    <span class="info-icon" onclick="openScoringModal()" title="Scoring Guide">ℹ️</span>
                </div>
            </div>
        </header>
        <div class="controls">
            <button id="newEntry" class="btn-primary">➕ New Entry</button>
            <button id="exportCsv">⬇️ Export CSV</button>
            <button id="exportPdf">📄 Print/PDF</button>
            <div class="legend">
                <span class="pill good active" id="normalPill" title="Normal (A/B Score)">✓ Normal</span>
                <span class="pill warn" id="watchPill" title="Watch (C Score)">⚠ Watch</span>
                <span class="pill bad" id="alertPill" title="Alert (D/F Score)">🚨 Alert</span>
            </div>
        </div>
        <div class="entry-form" id="entryForm">
            <div class="tabs" role="tablist">
                <button class="tab-btn active" data-tab="patient-input" role="tab" aria-selected="true" aria-controls="patient-input-panel">Patient Input</button>
                <button class="tab-btn" data-tab="physician-review" role="tab" aria-selected="false" aria-controls="physician-review-panel">Physician Review</button>
            </div>
            <form id="dataForm" action="#" method="post">
                <div class="tab-panel active" id="patient-input-panel" role="tabpanel" aria-labelledby="patient-input">
                    <!-- Initial Recovery Context -->
                    <div class="section" id="contextSection">
                        <div class="section-header">
                            <span class="section-icon">🏥</span>
                            <span>Initial Recovery Context</span>
                        </div>
                        <button type="button" class="review-context-btn" id="reviewContextBtn">Review Context</button>
                        <div style="color:var(--muted);font-size:0.9rem;margin-bottom:16px"> Set up your recovery context. Select your original symptoms, procedures, and hospital stay details. </div>
                        <div id="contextSummary" style="display:none;margin-bottom:16px"></div>
                        <div class="form-grid cols-3">
                            <div class="field">
                                <label>Original Symptoms</label>
                                <div class="checkbox-group" id="originalSymptomsGroup">
                                    <div style="font-weight:600;color:var(--cyan);margin-bottom:8px">Cardiac Symptoms</div>
                                    <label class="checkbox-item">
                                        <input type="checkbox" value="chest-pain">
                                        <span>Chest Pain</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" value="palpitations">
                                        <span>Palpitations</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" value="fatigue">
                                        <span>Fatigue</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" value="dizziness">
                                        <span>Dizziness</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" value="syncope">
                                        <span>Fainting (Syncope)</span>
                                    </label>
                                    <div style="font-weight:600;color:var(--cyan);margin-top:12px;margin-bottom:8px">Respiratory Symptoms</div>
                                    <label class="checkbox-item">
                                        <input type="checkbox" value="shortness-of-breath">
                                        <span>Shortness of Breath</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" value="swelling">
                                        <span>Swelling/Edema</span>
                                    </label>
                                </div>
                                <span class="saved-indicator" id="symptomsSaved"></span>
                            </div>
                            <div class="field">
                                <label for="procedures">Procedures Performed</label>
                                <select id="procedures" multiple>
                                    <option value="cabg">CABG (Coronary Artery Bypass Graft)</option>
                                    <option value="valve-replacement">Valve Replacement</option>
                                    <option value="valve-repair">Valve Repair</option>
                                    <option value="pacemaker">Pacemaker Implantation</option>
                                    <option value="afib-ablation">AFib Ablation</option>
                                    <option value="stent">Coronary Stent</option>
                                    <option value="other">Other</option>
                                </select>
                                <span class="helper-text">Select all that apply (Ctrl+click for multiple)</span>
                            </div>
                            <div class="field">
                                <label for="hospitalStay">Hospital Stay (days)</label>
                                <input type="number" id="hospitalStay" min="0" placeholder="e.g., 7">
                                <label for="hospitalComplications">Hospital Complications</label>
                                <select id="hospitalComplications">
                                    <option value="">Select...</option>
                                    <option value="none">None</option>
                                    <option value="infection">Infection</option>
                                    <option value="bleeding">Bleeding</option>
                                    <option value="arrhythmia">Arrhythmia</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <span class="section-badge" id="contextBadge"></span>
                    </div>
                    <!-- BASIC INFO -->
                    <div class="section" id="basicSection">
                        <div class="section-header">
                            <span class="section-icon">📅</span>
                            <span>Date & Time</span>
                        </div>
                        <div class="form-grid cols-3">
                            <div class="field">
                                <label for="entryDate">Date</label>
                                <input type="date" id="entryDate" required>
                            </div>
                            <div class="field">
                                <label for="entryTime">Time</label>
                                <input type="time" id="entryTime" required>
                            </div>
                            <div class="field">
                                <label for="surgeryDate">Surgery Date (set once)</label>
                                <input type="date" id="surgeryDate" placeholder="Your surgery date">
                                <span class="helper-text">Days post-op will auto-calculate</span>
                            </div>
                        </div>
                        <div class="form-grid cols-3" style="margin-top:12px">
                            <div class="field">
                                <label for="daysPostOp">Days Post-Surgery</label>
                                <input type="number" id="daysPostOp" min="0" placeholder="Auto-calculated" readonly>
                            </div>
                            <div class="field">
                                <label for="baselineWeight">Baseline/Dry Weight (lbs or kg)</label>
                                <input type="number" id="baselineWeight" step="0.1" placeholder="Your target weight">
                                <span class="helper-text">Set your post-surgery target weight</span>
                            </div>
                            <div class="field">
                                <label for="weightDeviation">Weight Deviation</label>
                                <input type="text" id="weightDeviation" placeholder="Auto-calculated" readonly style="background:rgba(255,255,255,0.02)">
                                <span class="helper-text">Difference from baseline</span>
                            </div>
                        </div>
                        <span class="section-badge" id="basicBadge"></span>
                    </div>
                    <!-- VITAL SIGNS -->
                    <div class="section" id="vitalsSection">
                        <div class="section-header">
                            <span class="section-icon">❤️</span>
                            <span>Vital Signs</span>
                        </div>
                        <div class="form-grid cols-3">
                            <div class="field">
                                <label for="weight">Weight (lbs or kg)</label>
                                <input type="number" id="weight" step="0.1" placeholder="e.g., 165.5">
                                <span class="helper-text">Morning weight before eating</span>
                                <span class="error-text" id="weightError" style="display:none"></span>
                            </div>
                            <div class="field">
                                <label for="bloodPressure">Blood Pressure (mmHg)</label>
                                <input type="text" id="bloodPressure" placeholder="e.g., 120/75" pattern="[0-9]{2,3}/[0-9]{2,3}">
                                <span class="helper-text">Target: 90-140/50-90 (post-surgery)</span>
                                <span class="error-text" id="bloodPressureError" style="display:none"></span>
                                <button class="device-connect-btn" onclick="connectBPDevice()">Connect BP Device</button>
                            </div>
                            <div class="field">
                                <label for="heartRate">Heart Rate (bpm)</label>
                                <input type="number" id="heartRate" min="30" max="200" placeholder="e.g., 72">
                                <span class="helper-text">Target: 55-100 bpm (on beta blockers)</span>
                                <span class="error-text" id="heartRateError" style="display:none"></span>
                            </div>
                            <div class="field">
                                <label for="oxygenSat">O₂ Saturation (%)</label>
                                <input type="number" id="oxygenSat" min="70" max="100" placeholder="e.g., 97">
                                <span class="helper-text">Target: ≥94% (alert if <92%)</span>
                                <span class="error-text" id="oxygenSatError" style="display:none"></span>
                                <button class="device-connect-btn" onclick="connectPulseOxDevice()">Connect Pulse Ox</button>
                            </div>
                            <div class="field">
                                <label for="temperature">Temperature (°F)</label>
                                <input type="number" id="temperature" step="0.1" min="95" max="105" placeholder="e.g., 98.6">
                                <span class="helper-text">Normal: 97.0-99.5°F (alert if >100.4°F)</span>
                                <span class="error-text" id="temperatureError" style="display:none"></span>
                            </div>
                            <div class="field">
                                <label for="respRate">Respiratory Rate (breaths/min)</label>
                                <input type="number" id="respRate" min="8" max="40" placeholder="e.g., 16">
                                <span class="helper-text">Normal: 12-20 breaths/min</span>
                            </div>
                        </div>
                        <span class="section-badge" id="vitalsBadge"></span>
                    </div>
                    <!-- CARDIAC RHYTHM & PACEMAKER -->
                    <div class="section" id="rhythmSection">
                        <div class="section-header">
                            <span class="section-icon">⚡</span>
                            <span>Cardiac Rhythm & Pacemaker</span>
                        </div>
                        <div class="form-grid cols-3">
                            <div class="field">
                                <label for="rhythm">Heart Rhythm</label>
                                <select id="rhythm">
                                    <option value="">Select...</option>
                                    <option value="regular">Regular/Normal Sinus</option>
                                    <option value="irregular">Irregular (AFib)</option>
                                    <option value="paced">Paced Rhythm</option>
                                    <option value="intermittent-afib">Intermittent AFib</option>
                                    <option value="atrial-flutter">Atrial Flutter</option>
                                    <option value="pvcs">PVCs (Premature Ventricular Contractions)</option>
                                    <option value="pacs">PACs (Premature Atrial Contractions)</option>
                                    <option value="bigeminy">Bigeminy</option>
                                    <option value="trigeminy">Trigeminy</option>
                                    <option value="svt">SVT (Supraventricular Tachycardia)</option>
                                    <option value="vtach">Ventricular Tachycardia</option>
                                    <option value="heart-block-1st">First Degree Heart Block</option>
                                    <option value="heart-block-2nd">Second Degree Heart Block</option>
                                    <option value="heart-block-3rd">Third Degree Heart Block</option>
                                    <option value="bradycardia">Bradycardia (pacemaker not capturing)</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="palpitations">Palpitations Frequency</label>
                                <select id="palpitations">
                                    <option value="">Select...</option>
                                    <option value="none">None</option>
                                    <option value="rare">Rare (1-2/day)</option>
                                    <option value="occasional">Occasional (several/day)</option>
                                    <option value="frequent">Frequent (many/hour)</option>
                                    <option value="constant">Constant</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="pacemakerIssues">Pacemaker Concerns</label>
                                <select id="pacemakerIssues">
                                    <option value="">Select...</option>
                                    <option value="none">None - functioning normally</option>
                                    <option value="hiccups">Hiccups/twitching</option>
                                    <option value="pocket-discomfort">Pocket discomfort</option>
                                    <option value="unusual-sensations">Unusual sensations</option>
                                    <option value="other">Other (note below)</option>
                                </select>
                            </div>
                        </div>
                        <span class="section-badge" id="rhythmBadge"></span>
                    </div>
                    <!-- PAIN ASSESSMENT WITH POSITION/CONTEXT -->
                    <div class="section" id="painSection">
                        <div class="section-header">
                            <span class="section-icon">🩹</span>
                            <span>Pain Assessment (0 = No Pain, 10 = Worst Pain)</span>
                        </div>
                        <div class="form-grid cols-2">
                            <div class="field">
                                <label>Surgical/Chest Pain (0-10)</label>
                                <div class="pain-scale" id="chestPainScale" role="radiogroup" aria-label="Chest pain scale"></div>
                            </div>
                            <div class="field">
                                <label>General Body Pain (0-10)</label>
                                <div class="pain-scale" id="bodyPainScale" role="radiogroup" aria-label="Body pain scale"></div>
                            </div>
                        </div>
                        <div class="form-grid cols-2" style="margin-top:16px">
                            <div class="field">
                                <label for="chestPainTrend">Chest Pain Trend vs Yesterday</label>
                                <select id="chestPainTrend">
                                    <option value="">Select...</option>
                                    <option value="better">Better</option>
                                    <option value="same">Same</option>
                                    <option value="worse">Worse</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="bodyPainTrend">Body Pain Trend vs Yesterday</label>
                                <select id="bodyPainTrend">
                                    <option value="">Select...</option>
                                    <option value="better">Better</option>
                                    <option value="same">Same</option>
                                    <option value="worse">Worse</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-grid cols-3" style="margin-top:16px">
                            <div class="field">
                                <label for="painLocation">Pain Location</label>
                                <input type="text" id="painLocation" placeholder="e.g., sternum, left shoulder">
                            </div>
                            <div class="field">
                                <label for="painType">Pain Type</label>
                                <select id="painType">
                                    <option value="">Select...</option>
                                    <option value="none">No pain</option>
                                    <option value="sharp">Sharp/stabbing</option>
                                    <option value="dull">Dull ache</option>
                                    <option value="burning">Burning</option>
                                    <option value="pressure">Pressure/tightness</option>
                                    <option value="shooting">Shooting</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="incisionStatus">Incision Status</label>
                                <select id="incisionStatus">
                                    <option value="">Select...</option>
                                    <option value="healing-well">Healing well</option>
                                    <option value="some-redness">Some redness</option>
                                    <option value="drainage">Drainage present</option>
                                    <option value="swelling">Swelling</option>
                                    <option value="separation">Wound separation</option>
                                    <option value="concerning">Concerning - call doctor</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top:20px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.06)">
                            <div style="font-weight:600;color:var(--cyan);margin-bottom:12px">Pain Position & Context</div>
                            <div class="form-grid cols-3">
                                <div class="field">
                                    <label for="painPosition">Position When Pain Worst</label>
                                    <select id="painPosition">
                                        <option value="">Select...</option>
                                        <option value="lying-flat">Lying flat on back</option>
                                        <option value="lying-side">Lying on side</option>
                                        <option value="leaning-back">Leaning back</option>
                                        <option value="sitting-upright">Sitting upright</option>
                                        <option value="standing">Standing</option>
                                        <option value="bending-forward">Bending forward</option>
                                        <option value="no-specific">No specific position</option>
                                    </select>
                                </div>
                                <div class="field">
                                    <label for="painTrigger">What Makes Pain Worse</label>
                                    <select id="painTrigger">
                                        <option value="">Select...</option>
                                        <option value="deep-breathing">Deep breathing</option>
                                        <option value="twisting">Twisting/rotating</option>
                                        <option value="reaching">Reaching overhead</option>
                                        <option value="coughing">Coughing/sneezing</option>
                                        <option value="movement">Any movement</option>
                                        <option value="showering">Showering/personal care</option>
                                        <option value="dressing">Getting dressed</option>
                                        <option value="nothing">Nothing makes it worse</option>
                                    </select>
                                </div>
                                <div class="field">
                                    <label for="painActivity">Activity When Pain Occurred</label>
                                    <select id="painActivity">
                                        <option value="">Select...</option>
                                        <option value="resting">Resting/no activity</option>
                                        <option value="walking">Walking</option>
                                        <option value="household">Household tasks</option>
                                        <option value="personal-care">Personal care (shower/dressing)</option>
                                        <option value="working">Working at desk</option>
                                        <option value="sleeping">Trying to sleep</option>
                                        <option value="exercise">Exercise/rehab</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <span class="section-badge" id="painBadge"></span>
                    </div>
                    <!-- DETAILED WOUND ASSESSMENT -->
                    <div class="section" id="woundSection">
                        <div class="section-header">
                            <span class="section-icon">🔬</span>
                            <span>Detailed Wound Assessment</span>
                        </div>
                        <div class="form-grid cols-3">
                            <div class="field">
                                <label for="drainageAmount">Drainage Amount</label>
                                <select id="drainageAmount">
                                    <option value="">Select...</option>
                                    <option value="none">None - completely dry</option>
                                    <option value="minimal">Minimal (small spot on dressing)</option>
                                    <option value="small">Small amount (quarter-size)</option>
                                    <option value="moderate">Moderate (half-dollar size)</option>
                                    <option value="large">Large (soaking through dressing)</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="drainageColor">Drainage Color</label>
                                <select id="drainageColor">
                                    <option value="">Select...</option>
                                    <option value="none">No drainage</option>
                                    <option value="clear">Clear/serous</option>
                                    <option value="blood-tinged">Blood-tinged/pink</option>
                                    <option value="yellow">Yellow/serosanguinous</option>
                                    <option value="green-yellow">Green-yellow (purulent - call doctor!)</option>
                                    <option value="brown">Brown/foul-smelling (infection - call doctor!)</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="woundWarmth">Wound Warmth</label>
                                <select id="woundWarmth">
                                    <option value="">Select...</option>
                                    <option value="normal">Normal temperature</option>
                                    <option value="slightly-warm">Slightly warmer than surrounding skin</option>
                                    <option value="warm">Noticeably warm</option>
                                    <option value="hot">Hot to touch (concerning!)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-grid cols-3" style="margin-top:12px">
                            <div class="field">
                                <label for="rednessExtent">Redness Extent</label>
                                <select id="rednessExtent">
                                    <option value="">Select...</option>
                                    <option value="none">No redness</option>
                                    <option value="incision-line">At incision line only</option>
                                    <option value="1cm">Extends 1cm from incision</option>
                                    <option value="2cm">Extends 2cm from incision</option>
                                    <option value="spreading">Spreading/worsening (call doctor!)</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="woundEdges">Wound Edges</label>
                                <select id="woundEdges">
                                    <option value="">Select...</option>
                                    <option value="well-approximated">Well-approximated (closed)</option>
                                    <option value="slightly-separated">Slightly separated (<5mm)</option>
                                    <option value="gaping">Gaping (>5mm - call doctor!)</option>
                                    <option value="dehiscence">Wound dehiscence (EMERGENCY!)</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="surroundingSkin">Surrounding Skin</label>
                                <select id="surroundingSkin">
                                    <option value="">Select...</option>
                                    <option value="normal">Normal appearance</option>
                                    <option value="dry">Dry/flaky</option>
                                    <option value="irritated">Irritated from dressing</option>
                                    <option value="bruised">Bruising (normal healing)</option>
                                    <option value="blistering">Blistering (notify doctor)</option>
                                </select>
                            </div>
                        </div>
                        <div class="wound-photo-upload">
                            <label for="woundPhotos" class="upload-btn">📸 Upload Wound Photos</label>
                            <input type="file" id="woundPhotos" name="woundPhotos" accept="image/*" multiple>
                            <div style="margin-top:8px;font-size:0.85rem;color:var(--muted)"> Take photos in good lighting. Helpful for tracking healing progress. </div>
                            <div class="photo-preview" id="photoPreview"></div>
                        </div>
                        <span class="section-badge" id="woundBadge"></span>
                    </div>
                    <!-- SYMPTOMS -->
                    <div class="section" id="symptomsSection">
                        <div class="section-header">
                            <span class="section-icon">🫁</span>
                            <span>Symptoms</span>
                        </div>
                        <div class="form-grid cols-3">
                            <div class="field">
                                <label for="shortnessOfBreath">Shortness of Breath</label>
                                <select id="shortnessOfBreath">
                                    <option value="">Select...</option>
                                    <option value="none">None</option>
                                    <option value="mild-exertion">Only with significant exertion</option>
                                    <option value="moderate-exertion">With moderate activity</option>
                                    <option value="minimal-exertion">With minimal activity</option>
                                    <option value="at-rest">At rest</option>
                                    <option value="lying-down">When lying down</option>
                                    <option value="night">Waking up at night</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="fatigue">Fatigue Level</label>
                                <select id="fatigue">
                                    <option value="">Select...</option>
                                    <option value="none">None - normal energy</option>
                                    <option value="mild">Mild - slightly tired</option>
                                    <option value="moderate">Moderate - limited activity</option>
                                    <option value="severe">Severe - exhausted most of day</option>
                                    <option value="extreme">Extreme - can barely function</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="dizziness">Dizziness/Lightheadedness</label>
                                <select id="dizziness">
                                    <option value="">Select...</option>
                                    <option value="none">None</option>
                                    <option value="occasional">Occasional when standing</option>
                                    <option value="frequent">Frequent</option>
                                    <option value="severe">Severe/near fainting</option>
                                    <option value="syncope">Actual fainting</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-grid cols-3" style="margin-top:12px">
                            <div class="field">
                                <label for="swelling">Swelling/Edema</label>
                                <select id="swelling">
                                    <option value="">Select...</option>
                                    <option value="none">None</option>
                                    <option value="ankle">Ankle only</option>
                                    <option value="leg">Leg swelling</option>
                                    <option value="bilateral">Both legs</option>
                                    <option value="abdomen">Abdominal distension</option>
                                    <option value="generalized">Generalized</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="nausea">Nausea/Appetite</label>
                                <select id="nausea">
                                    <option value="">Select...</option>
                                    <option value="good-appetite">Good appetite</option>
                                    <option value="decreased-appetite">Decreased appetite</option>
                                    <option value="mild-nausea">Mild nausea</option>
                                    <option value="moderate-nausea">Moderate nausea</option>
                                    <option value="severe-nausea">Severe nausea/vomiting</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="sleepHours">Sleep Quality (hours)</label>
                                <input type="number" id="sleepHours" step="0.5" min="0" max="24" placeholder="e.g., 6.5">
                            </div>
                            <div class="field">
                                <label for="sleepPosition">Sleep Position</label>
                                <select id="sleepPosition">
                                    <option value="">Select...</option>
                                    <option value="flat">Completely flat on back</option>
                                    <option value="1-2-pillows">Elevated 1-2 pillows</option>
                                    <option value="3-plus-pillows">Elevated 3+ pillows</option>
                                    <option value="recliner">Sleeping in recliner/chair</option>
                                    <option value="cannot-lie-flat">Cannot lie flat (orthopnea)</option>
                                </select>
                                <span class="helper-text">Track breathing difficulty when lying down</span>
                            </div>
                            <div class="field">
                                <label for="wakingSOB">Waking Due to Breathing</label>
                                <select id="wakingSOB">
                                    <option value="">Select...</option>
                                    <option value="no">No - slept through</option>
                                    <option value="once">Once during night</option>
                                    <option value="multiple">Multiple times (concerning)</option>
                                    <option value="unable-to-sleep">Unable to sleep due to SOB</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-grid cols-3" style="margin-top:12px">
                            <div class="field">
                                <label for="cough">Cough</label>
                                <select id="cough">
                                    <option value="">Select...</option>
                                    <option value="none">None</option>
                                    <option value="occasional-dry">Occasional dry cough</option>
                                    <option value="frequent-dry">Frequent dry cough</option>
                                    <option value="productive">Productive cough</option>
                                    <option value="bloody">Coughing blood (call doctor!)</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="mood">Anxiety/Mood</label>
                                <select id="mood">
                                    <option value="">Select...</option>
                                    <option value="good">Good/positive</option>
                                    <option value="neutral">Neutral</option>
                                    <option value="anxious">Anxious/worried</option>
                                    <option value="depressed">Depressed/down</option>
                                    <option value="severe-anxiety">Severe anxiety/panic</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="sternumClicking">Sternum Clicking/Popping</label>
                                <select id="sternumClicking">
                                    <option value="">Select...</option>
                                    <option value="none">None</option>
                                    <option value="mild">Mild clicking occasionally</option>
                                    <option value="moderate">Moderate clicking</option>
                                    <option value="painful">Painful clicking</option>
                                    <option value="concerning">Very concerning</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-grid cols-3" style="margin-top:12px">
                            <div class="field">
                                <label for="bowelMovement">Last Bowel Movement</label>
                                <select id="bowelMovement">
                                    <option value="">Select...</option>
                                    <option value="today">Today</option>
                                    <option value="yesterday">Yesterday (1 day ago)</option>
                                    <option value="2-days">2 days ago</option>
                                    <option value="3-days">3 days ago (concerning)</option>
                                    <option value="4-plus-days">4+ days ago (alert doctor)</option>
                                </select>
                                <span class="helper-text">Constipation risk with pain meds</span>
                            </div>
                            <div class="field">
                                <label for="stoolConsistency">Stool Consistency</label>
                                <select id="stoolConsistency">
                                    <option value="">Select...</option>
                                    <option value="normal">Normal/soft</option>
                                    <option value="hard">Hard/difficult to pass</option>
                                    <option value="loose">Loose/diarrhea</option>
                                    <option value="bloody">Bloody stool (call doctor)</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="bmStraining">Straining During BM</label>
                                <select id="bmStraining">
                                    <option value="">Select...</option>
                                    <option value="none">No straining</option>
                                    <option value="mild">Mild straining</option>
                                    <option value="moderate">Moderate straining</option>
                                    <option value="severe">Severe straining (dangerous for sternum)</option>
                                </select>
                            </div>
                        </div>
                        <span class="section-badge" id="symptomsBadge"></span>
                    </div>
                    <!-- POST-OP COMPLICATION SCREENING -->
                    <div class="section" id="complicationsSection">
                        <div class="section-header">
                            <span class="section-icon">🚨</span>
                            <span>Post-Operative Complication Screening</span>
                        </div>
                        <div style="color:var(--muted);font-size:0.9rem;margin-bottom:16px"> Screen for common post-cardiac surgery complications. Check any symptoms present. </div>
                        <div style="margin-bottom:20px">
                            <div style="font-weight:600;color:var(--cyan);margin-bottom:12px">Post-Pericardiotomy Syndrome (Dressler's Syndrome)</div>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="pericardiotomy" value="chest-pain-worse-breathing">
                                    <span>Chest pain worse with breathing/lying flat</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="pericardiotomy" value="fever-postop">
                                    <span>Low-grade fever (weeks after surgery)</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="pericardiotomy" value="pericardial-rub">
                                    <span>Pericardial friction rub (scratchy sound)</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="pericardiotomy" value="malaise">
                                    <span>General malaise/feeling unwell</span>
                                </label>
                            </div>
                        </div>
                        <div style="margin-bottom:20px">
                            <div style="font-weight:600;color:var(--cyan);margin-bottom:12px">Pleural Effusion (Fluid Around Lungs)</div>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="pleural" value="sob-progressive">
                                    <span>Progressive shortness of breath</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="pleural" value="decreased-breath-sounds">
                                    <span>Decreased breath sounds on one side</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="pleural" value="dullness-percussion">
                                    <span>Dullness to percussion (if checked)</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="pleural" value="pleuritic-pain">
                                    <span>Sharp pain with deep breathing</span>
                                </label>
                            </div>
                        </div>
                        <div style="margin-bottom:20px">
                            <div style="font-weight:600;color:var(--cyan);margin-bottom:12px">Pericardial Effusion (Fluid Around Heart)</div>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="pericardial" value="muffled-heart-sounds">
                                    <span>Muffled heart sounds (if assessed)</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="pericardial" value="jvd">
                                    <span>Jugular venous distension (bulging neck veins)</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="pericardial" value="hypotension">
                                    <span>Low blood pressure</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="pericardial" value="pulsus-paradoxus">
                                    <span>Pulsus paradoxus (BP drop with inspiration)</span>
                                </label>
                            </div>
                        </div>
                        <div style="margin-bottom:20px">
                            <div style="font-weight:600;color:var(--cyan);margin-bottom:12px">Cardiac Tamponade (EMERGENCY)</div>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="tamponade" value="becks-triad">
                                    <span>Beck's Triad: Low BP + Muffled sounds + JVD</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="tamponade" value="severe-sob">
                                    <span>Severe shortness of breath</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="tamponade" value="tachycardia-severe">
                                    <span>Severe tachycardia</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="tamponade" value="altered-consciousness">
                                    <span>Altered consciousness/confusion</span>
                                </label>
                            </div>
                        </div>
                        <div id="complicationAlert" style="display:none" class="complication-warning" aria-live="assertive"> ⚠️ WARNING: You've indicated symptoms concerning for serious post-operative complications. Contact your cardiac surgeon or cardiologist TODAY. If symptoms are severe, go to the emergency room. </div>
                        <span class="section-badge" id="complicationsBadge"></span>
                    </div>
                    <!-- STERNAL PRECAUTIONS COMPLIANCE -->
                    <div class="section">
                        <div class="section-header">
                            <span class="section-icon">🛡️</span>
                            <span>Sternal Precautions Compliance (Post-Sternotomy)</span>
                        </div>
                        <div style="color:var(--muted);font-size:0.9rem;margin-bottom:16px"> Following these precautions is CRITICAL for sternum healing (typically 6-8 weeks minimum) </div>
                        <div class="form-grid cols-3">
                            <div class="field">
                                <label for="liftingCompliance">Lifting Restriction Compliance</label>
                                <select id="liftingCompliance">
                                    <option value="">Select...</option>
                                    <option value="compliant">Compliant - No lifting >5-10 lbs</option>
                                    <option value="minor-violation">Minor violation (lifted 10-15 lbs)</option>
                                    <option value="moderate-violation">Moderate violation (lifted 15-25 lbs)</option>
                                    <option value="major-violation">Major violation (lifted >25 lbs)</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="pushPullCompliance">Pushing/Pulling Activities</label>
                                <select id="pushPullCompliance">
                                    <option value="">Select...</option>
                                    <option value="avoided">Avoided all pushing/pulling</option>
                                    <option value="light">Light pushing/pulling only</option>
                                    <option value="moderate">Moderate pushing/pulling</option>
                                    <option value="heavy">Heavy pushing/pulling (concerning)</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="armMovement">Arm Movement Restrictions</label>
                                <select id="armMovement">
                                    <option value="">Select...</option>
                                    <option value="compliant">Compliant - No reaching overhead</option>
                                    <option value="occasional">Occasional overhead reaching</option>
                                    <option value="frequent">Frequent overhead reaching</option>
                                    <option value="unrestricted">Unrestricted movement (too soon)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-grid cols-3" style="margin-top:12px">
                            <div class="field">
                                <label for="drivingStatus">Driving Status</label>
                                <select id="drivingStatus">
                                    <option value="">Select...</option>
                                    <option value="not-driving">Not driving (compliant)</option>
                                    <option value="passenger">Passenger only</option>
                                    <option value="short-trips">Driving short trips (check clearance)</option>
                                    <option value="regular-driving">Regular driving (check clearance)</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="coughSplinting">Cough Splinting with Pillow</label>
                                <select id="coughSplinting">
                                    <option value="">Select...</option>
                                    <option value="always">Always use pillow to splint</option>
                                    <option value="usually">Usually remember</option>
                                    <option value="sometimes">Sometimes forget</option>
                                    <option value="never">Not using pillow (risky)</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="sternumShift">Felt Sternum "Give" or Shift Today</label>
                                <select id="sternumShift">
                                    <option value="">Select...</option>
                                    <option value="no">No - sternum feels stable</option>
                                    <option value="minor">Minor sensation of movement</option>
                                    <option value="significant">Significant shifting (call doctor)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <!-- FUNCTIONAL ABILITIES (ADLs) -->
                    <div class="section" id="activitySection">
                        <div class="section-header">
                            <span class="section-icon">💪</span>
                            <span>Functional Abilities Assessment (Activities of Daily Living)</span>
                        </div>
                        <div style="color:var(--muted);font-size:0.9rem;margin-bottom:16px"> Rate your ability to perform each activity independently (1 = Unable, 10 = No difficulty) </div>
                        <div class="adl-item">
                            <div class="adl-item-header">⬆️ Climbing Stairs (full flight without stopping)</div>
                            <div class="adl-scale" data-adl="stairs" role="radiogroup" aria-label="Stairs ADL scale"></div>
                        </div>
                        <div class="adl-item">
                            <div class="adl-item-header">🚿 Showering Independently (washing, reaching, balance)</div>
                            <div class="adl-scale" data-adl="showering" role="radiogroup" aria-label="Showering ADL scale"></div>
                        </div>
                        <div class="adl-item">
                            <div class="adl-item-header">👔 Dressing Independently (buttons, socks, overhead)</div>
                            <div class="adl-scale" data-adl="dressing" role="radiogroup" aria-label="Dressing ADL scale"></div>
                        </div>
                        <div class="adl-item">
                            <div class="adl-item-header">🍽️ Light Household Tasks (dishes, tidying)</div>
                            <div class="adl-scale" data-adl="household" role="radiogroup" aria-label="Household ADL scale"></div>
                        </div>
                        <div class="adl-item">
                            <div class="adl-item-header">💼 Working at Desk (concentration, sitting upright)</div>
                            <div class="adl-scale" data-adl="desk" role="radiogroup" aria-label="Desk ADL scale"></div>
                        </div>
                        <div class="adl-item">
                            <div class="adl-item-header">🍳 Meal Preparation (standing, reaching, carrying)</div>
                            <div class="adl-scale" data-adl="cooking" role="radiogroup" aria-label="Cooking ADL scale"></div>
                        </div>
                        <div class="adl-item">
                            <div class="adl-item-header">💇 Personal Grooming (brushing teeth/hair independently)</div>
                            <div class="adl-scale" data-adl="grooming" role="radiogroup" aria-label="Grooming ADL scale"></div>
                        </div>
                        <div class="adl-item">
                            <div class="adl-item-header">🚶 Walking Around Home (room to room without SOB)</div>
                            <div class="adl-scale" data-adl="walking" role="radiogroup" aria-label="Walking ADL scale"></div>
                        </div>
                        <div class="adl-item">
                            <div class="adl-item-header">🛏️ Getting In/Out of Bed Independently</div>
                            <div class="adl-scale" data-adl="bed" role="radiogroup" aria-label="Bed ADL scale"></div>
                        </div>
                        <span class="section-badge" id="activityBadge"></span>
                    </div>
                    <!-- FLUID MANAGEMENT -->
                    <div class="section">
                        <div class="section-header">
                            <span class="section-icon">💧</span>
                            <span>Fluid Management</span>
                        </div>
                        <div class="form-grid cols-3">
                            <div class="field">
                                <label for="fluidRestriction">Daily Fluid Restriction (mL or oz)</label>
                                <input type="number" id="fluidRestriction" placeholder="e.g., 2000 (2 liters)">
                                <span class="helper-text">Your prescribed daily limit (if any)</span>
                            </div>
                            <div class="field">
                                <label for="fluidIntake">Fluid Intake (mL or oz)</label>
                                <input type="number" id="fluidIntake" placeholder="e.g., 1500">
                                <span class="helper-text">Total for 24 hours</span>
                            </div>
                            <div class="field">
                                <label for="fluidBalance">Fluid Balance Status</label>
                                <input type="text" id="fluidBalance" placeholder="Auto-calculated" readonly style="background:rgba(255,255,255,0.02)">
                                <span class="helper-text">Over/under restriction</span>
                            </div>
                        </div>
                        <div class="form-grid cols-3" style="margin-top:12px">
                            <div class="field">
                                <label for="urineOutput">Urine Output</label>
                                <select id="urineOutput">
                                    <option value="">Select...</option>
                                    <option value="normal">Normal/adequate</option>
                                    <option value="decreased">Decreased</option>
                                    <option value="very-low">Very low</option>
                                    <option value="increased">Increased (frequent)</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="urineColor">Urine Color</label>
                                <select id="urineColor">
                                    <option value="">Select...</option>
                                    <option value="pale-yellow">Pale yellow (well hydrated)</option>
                                    <option value="yellow">Yellow (normal)</option>
                                    <option value="dark-yellow">Dark yellow</option>
                                    <option value="amber">Amber/concentrated</option>
                                    <option value="abnormal">Abnormal color (red/brown)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <!-- MEDICATIONS WITH FREQUENCY -->
                    <div class="section" id="medsSection">
                        <div class="section-header">
                            <span class="section-icon">💊</span>
                            <span>Medications Taken Today</span>
                        </div>
                        <div class="form-grid cols-2">
                            <div class="field">
                                <label>Diuretic (Furosemide/Lasix)</label>
                                <div class="medication-row">
                                    <input type="text" id="diuretic" placeholder="e.g., 40mg">
                                    <input type="text" id="diureticFreq" placeholder="Times taken (e.g., 2x - 8am, 2pm)">
                                </div>
                            </div>
                            <div class="field">
                                <label>Anticoagulant</label>
                                <div class="form-grid cols-2" style="gap:8px">
                                    <select id="anticoagType">
                                        <option value="">Select Type...</option>
                                        <option value="warfarin">Warfarin</option>
                                        <option value="rivaroxaban">Rivaroxaban (Xarelto)</option>
                                        <option value="apixaban">Apixaban (Eliquis)</option>
                                        <option value="dabigatran">Dabigatran (Pradaxa)</option>
                                        <option value="edoxaban">Edoxaban (Savaysa)</option>
                                        <option value="other">Other</option>
                                    </select>
                                    <input type="text" id="anticoagDose" placeholder="Dose e.g., 20 mg">
                                </div>
                                <input type="text" id="anticoagulantFreq" placeholder="Times taken (e.g., 1x - 6pm)">
                                <div id="doacNotes" style="display:none;font-size:0.85rem;color:var(--warn);margin-top:4px">Monitor for bleeding; no routine labs needed.</div>
                            </div>
                            <div class="field">
                                <label>Beta Blocker (Metoprolol/Carvedilol)</label>
                                <div class="medication-row">
                                    <input type="text" id="betaBlocker" placeholder="e.g., Metoprolol 25mg">
                                    <input type="text" id="betaBlockerFreq" placeholder="Times taken (e.g., 2x - 8am, 8pm)">
                                </div>
                            </div>
                            <div class="field">
                                <label>Antiarrhythmic (Amiodarone/others)</label>
                                <div class="medication-row">
                                    <input type="text" id="antiarrhythmic" placeholder="e.g., Amiodarone 200mg">
                                    <input type="text" id="antiarrhythmicFreq" placeholder="Times taken">
                                </div>
                            </div>
                            <div class="field">
                                <label>ACE Inhibitor / ARB</label>
                                <div class="medication-row">
                                    <input type="text" id="aceInhibitor" placeholder="e.g., Lisinopril 10mg">
                                    <input type="text" id="aceInhibitorFreq" placeholder="Times taken">
                                </div>
                            </div>
                            <div class="field">
                                <label>Pain Medication</label>
                                <div class="medication-row">
                                    <input type="text" id="painMed" placeholder="e.g., Tylenol 500mg">
                                    <input type="text" id="painMedFreq" placeholder="Times taken">
                                </div>
                            </div>
                            <div class="field">
                                <label>Potassium Supplement</label>
                                <div class="medication-row">
                                    <input type="text" id="potassium" placeholder="e.g., K-Dur 20mEq">
                                    <input type="text" id="potassiumFreq" placeholder="Times taken">
                                </div>
                            </div>
                            <div class="field">
                                <label>Other Cardiac Meds</label>
                                <div class="medication-row">
                                    <input type="text" id="otherCardiacMeds" placeholder="e.g., Spironolactone 25mg">
                                    <input type="text" id="otherCardiacMedsFreq" placeholder="Times taken">
                                </div>
                            </div>
                        </div>
                        <span class="section-badge" id="medsBadge"></span>
                    </div>
                    <!-- MEDICATION ADHERENCE TRACKING -->
                    <div class="section">
                        <div class="section-header">
                            <span class="section-icon">✅</span>
                            <span>Medication Adherence Tracking</span>
                        </div>
                        <div style="color:var(--muted);font-size:0.9rem;margin-bottom:16px"> Track prescribed schedule vs actual doses taken. Click each dose slot to mark as taken or missed. </div>
                        <div class="med-adherence-item">
                            <div class="med-adherence-header">
                                <span class="med-name">💊 Beta Blocker (Metoprolol/Carvedilol)</span>
                                <span class="adherence-status" id="betaBlockerAdherenceStatus">Not Set</span>
                            </div>
                            <div class="form-grid cols-2" style="margin-bottom:10px">
                                <div class="field">
                                    <label for="betaBlockerSchedule">Prescribed Schedule</label>
                                    <input type="text" id="betaBlockerSchedule" placeholder="e.g., 2x daily - 8am, 8pm">
                                </div>
                                <div class="field">
                                    <label for="betaBlockerDoses">Number of Daily Doses</label>
                                    <input type="number" id="betaBlockerDoses" min="1" max="4" placeholder="e.g., 2" value="2">
                                </div>
                            </div>
                            <div class="dose-tracker" id="betaBlockerDoseTracker"></div>
                        </div>
                        <div class="med-adherence-item">
                            <div class="med-adherence-header">
                                <span class="med-name">💧 Diuretic (Furosemide/Lasix)</span>
                                <span class="adherence-status" id="diureticAdherenceStatus">Not Set</span>
                            </div>
                            <div class="form-grid cols-2" style="margin-bottom:10px">
                                <div class="field">
                                    <label for="diureticSchedule">Prescribed Schedule</label>
                                    <input type="text" id="diureticSchedule" placeholder="e.g., 2x daily - 8am, 2pm">
                                </div>
                                <div class="field">
                                    <label for="diureticDoses">Number of Daily Doses</label>
                                    <input type="number" id="diureticDoses" min="1" max="4" placeholder="e.g., 2" value="2">
                                </div>
                            </div>
                            <div class="dose-tracker" id="diureticDoseTracker"></div>
                        </div>
                        <div class="med-adherence-item">
                            <div class="med-adherence-header">
                                <span class="med-name">🩸 Anticoagulant (Warfarin/Eliquis/Xarelto)</span>
                                <span class="adherence-status" id="anticoagulantAdherenceStatus">Not Set</span>
                            </div>
                            <div class="form-grid cols-2" style="margin-bottom:10px">
                                <div class="field">
                                    <label for="anticoagulantSchedule">Prescribed Schedule</label>
                                    <input type="text" id="anticoagulantSchedule" placeholder="e.g., 1x daily - 6pm">
                                </div>
                                <div class="field">
                                    <label for="anticoagulantDoses">Number of Daily Doses</label>
                                    <input type="number" id="anticoagulantDoses" min="1" max="2" placeholder="e.g., 1" value="1">
                                </div>
                            </div>
                            <div class="dose-tracker" id="anticoagulantDoseTracker"></div>
                        </div>
                        <div class="med-adherence-item">
                            <div class="med-adherence-header">
                                <span class="med-name">⚡ Antiarrhythmic (Amiodarone/others)</span>
                                <span class="adherence-status" id="antiarrhythmicAdherenceStatus">Not Set</span>
                            </div>
                            <div class="form-grid cols-2" style="margin-bottom:10px">
                                <div class="field">
                                    <label for="antiarrhythmicSchedule">Prescribed Schedule</label>
                                    <input type="text" id="antiarrhythmicSchedule" placeholder="e.g., 1x daily - 9am">
                                </div>
                                <div class="field">
                                    <label for="antiarrhythmicDoses">Number of Daily Doses</label>
                                    <input type="number" id="antiarrhythmicDoses" min="1" max="3" placeholder="e.g., 1" value="1">
                                </div>
                            </div>
                            <div class="dose-tracker" id="antiarrhythmicDoseTracker"></div>
                        </div>
                        <div class="field" style="margin-top:16px">
                            <label for="missedDoseReasons">Reasons for Missed Doses (if any)</label>
                            <textarea id="missedDoseReasons" placeholder="e.g., forgot morning dose, ran out of medication, experienced side effects..."></textarea>
                        </div>
                    </div>
                    <!-- MEDICATION SIDE EFFECTS TRACKING -->
                    <div class="section">
                        <div class="section-header">
                            <span class="section-icon">⚠️</span>
                            <span>Medication Side Effects Tracking</span>
                        </div>
                        <div style="color:var(--muted);font-size:0.9rem;margin-bottom:16px"> Track medication-specific side effects. Rate severity: None (0) → Mild (1) → Moderate (2) → Severe (3) </div>
                        <div class="side-effect-tracker">
                            <div class="side-effect-header">Amiodarone Side Effects</div>
                            <div class="form-grid cols-2">
                                <div class="field">
                                    <label>Thyroid Symptoms (fatigue, weight changes, palpitations)</label>
                                    <div class="severity-scale" data-effect="amio-thyroid" role="radiogroup" aria-label="Amio thyroid severity">
                                        <div class="severity-btn" data-value="0" role="radio" aria-checked="false">None</div>
                                        <div class="severity-btn" data-value="1" role="radio" aria-checked="false">Mild</div>
                                        <div class="severity-btn" data-value="2" role="radio" aria-checked="false">Moderate</div>
                                        <div class="severity-btn severe" data-value="3" role="radio" aria-checked="false">Severe</div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Lung Symptoms (cough, SOB, wheezing)</label>
                                    <div class="severity-scale" data-effect="amio-lung" role="radiogroup" aria-label="Amio lung severity">
                                        <div class="severity-btn" data-value="0" role="radio" aria-checked="false">None</div>
                                        <div class="severity-btn" data-value="1" role="radio" aria-checked="false">Mild</div>
                                        <div class="severity-btn" data-value="2" role="radio" aria-checked="false">Moderate</div>
                                        <div class="severity-btn severe" data-value="3" role="radio" aria-checked="false">Severe</div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Skin Changes (blue-gray discoloration, sun sensitivity)</label>
                                    <div class="severity-scale" data-effect="amio-skin" role="radiogroup" aria-label="Amio skin severity">
                                        <div class="severity-btn" data-value="0" role="radio" aria-checked="false">None</div>
                                        <div class="severity-btn" data-value="1" role="radio" aria-checked="false">Mild</div>
                                        <div class="severity-btn" data-value="2" role="radio" aria-checked="false">Moderate</div>
                                        <div class="severity-btn severe" data-value="3" role="radio" aria-checked="false">Severe</div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Vision Changes (halos, blurred vision)</label>
                                    <div class="severity-scale" data-effect="amio-vision" role="radiogroup" aria-label="Amio vision severity">
                                        <div class="severity-btn" data-value="0" role="radio" aria-checked="false">None</div>
                                        <div class="severity-btn" data-value="1" role="radio" aria-checked="false">Mild</div>
                                        <div class="severity-btn" data-value="2" role="radio" aria-checked="false">Moderate</div>
                                        <div class="severity-btn severe" data-value="3" role="radio" aria-checked="false">Severe</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="side-effect-tracker">
                            <div class="side-effect-header">Beta Blocker Side Effects</div>
                            <div class="form-grid cols-2">
                                <div class="field">
                                    <label>Fatigue/Exercise Intolerance</label>
                                    <div class="severity-scale" data-effect="bb-fatigue" role="radiogroup" aria-label="BB fatigue severity">
                                        <div class="severity-btn" data-value="0" role="radio" aria-checked="false">None</div>
                                        <div class="severity-btn" data-value="1" role="radio" aria-checked="false">Mild</div>
                                        <div class="severity-btn" data-value="2" role="radio" aria-checked="false">Moderate</div>
                                        <div class="severity-btn severe" data-value="3" role="radio" aria-checked="false">Severe</div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Dizziness/Lightheadedness</label>
                                    <div class="severity-scale" data-effect="bb-dizziness" role="radiogroup" aria-label="BB dizziness severity">
                                        <div class="severity-btn" data-value="0" role="radio" aria-checked="false">None</div>
                                        <div class="severity-btn" data-value="1" role="radio" aria-checked="false">Mild</div>
                                        <div class="severity-btn" data-value="2" role="radio" aria-checked="false">Moderate</div>
                                        <div class="severity-btn severe" data-value="3" role="radio" aria-checked="false">Severe</div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Cold Hands/Feet</label>
                                    <div class="severity-scale" data-effect="bb-cold-extremities" role="radiogroup" aria-label="BB cold extremities severity">
                                        <div class="severity-btn" data-value="0" role="radio" aria-checked="false">None</div>
                                        <div class="severity-btn" data-value="1" role="radio" aria-checked="false">Mild</div>
                                        <div class="severity-btn" data-value="2" role="radio" aria-checked="false">Moderate</div>
                                        <div class="severity-btn severe" data-value="3" role="radio" aria-checked="false">Severe</div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Depression/Mood Changes</label>
                                    <div class="severity-scale" data-effect="bb-mood" role="radiogroup" aria-label="BB mood severity">
                                        <div class="severity-btn" data-value="0" role="radio" aria-checked="false">None</div>
                                        <div class="severity-btn" data-value="1" role="radio" aria-checked="false">Mild</div>
                                        <div class="severity-btn" data-value="2" role="radio" aria-checked="false">Moderate</div>
                                        <div class="severity-btn severe" data-value="3" role="radio" aria-checked="false">Severe</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="side-effect-tracker">
                            <div class="side-effect-header">Diuretic Side Effects</div>
                            <div class="form-grid cols-2">
                                <div class="field">
                                    <label>Frequent Urination/Urgency</label>
                                    <div class="severity-scale" data-effect="diuretic-urination" role="radiogroup" aria-label="Diuretic urination severity">
                                        <div class="severity-btn" data-value="0" role="radio" aria-checked="false">None</div>
                                        <div class="severity-btn" data-value="1" role="radio" aria-checked="false">Mild</div>
                                        <div class="severity-btn" data-value="2" role="radio" aria-checked="false">Moderate</div>
                                        <div class="severity-btn severe" data-value="3" role="radio" aria-checked="false">Severe</div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Muscle Cramps</label>
                                    <div class="severity-scale" data-effect="diuretic-cramps" role="radiogroup" aria-label="Diuretic cramps severity">
                                        <div class="severity-btn" data-value="0" role="radio" aria-checked="false">None</div>
                                        <div class="severity-btn" data-value="1" role="radio" aria-checked="false">Mild</div>
                                        <div class="severity-btn" data-value="2" role="radio" aria-checked="false">Moderate</div>
                                        <div class="severity-btn severe" data-value="3" role="radio" aria-checked="false">Severe</div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Dizziness/Dehydration</label>
                                    <div class="severity-scale" data-effect="diuretic-dizziness" role="radiogroup" aria-label="Diuretic dizziness severity">
                                        <div class="severity-btn" data-value="0" role="radio" aria-checked="false">None</div>
                                        <div class="severity-btn" data-value="1" role="radio" aria-checked="false">Mild</div>
                                        <div class="severity-btn" data-value="2" role="radio" aria-checked="false">Moderate</div>
                                        <div class="severity-btn severe" data-value="3" role="radio" aria-checked="false">Severe</div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Weakness/Fatigue</label>
                                    <div class="severity-scale" data-effect="diuretic-weakness" role="radiogroup" aria-label="Diuretic weakness severity">
                                        <div class="severity-btn" data-value="0" role="radio" aria-checked="false">None</div>
                                        <div class="severity-btn" data-value="1" role="radio" aria-checked="false">Mild</div>
                                        <div class="severity-btn" data-value="2" role="radio" aria-checked="false">Moderate</div>
                                        <div class="severity-btn severe" data-value="3" role="radio" aria-checked="false">Severe</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="side-effect-tracker">
                            <div class="side-effect-header">Anticoagulant Side Effects (Warfarin/DOAC)</div>
                            <div class="form-grid cols-2">
                                <div class="field">
                                    <label>Easy Bruising</label>
                                    <div class="severity-scale" data-effect="anticoag-bruising" role="radiogroup" aria-label="Anticoag bruising severity">
                                        <div class="severity-btn" data-value="0" role="radio" aria-checked="false">None</div>
                                        <div class="severity-btn" data-value="1" role="radio" aria-checked="false">Mild</div>
                                        <div class="severity-btn" data-value="2" role="radio" aria-checked="false">Moderate</div>
                                        <div class="severity-btn severe" data-value="3" role="radio" aria-checked="false">Severe</div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Bleeding (gums, nosebleeds)</label>
                                    <div class="severity-scale" data-effect="anticoag-bleeding" role="radiogroup" aria-label="Anticoag bleeding severity">
                                        <div class="severity-btn" data-value="0" role="radio" aria-checked="false">None</div>
                                        <div class="severity-btn" data-value="1" role="radio" aria-checked="false">Mild</div>
                                        <div class="severity-btn" data-value="2" role="radio" aria-checked="false">Moderate</div>
                                        <div class="severity-btn severe" data-value="3" role="radio" aria-checked="false">Severe</div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>GI Upset/Nausea</label>
                                    <div class="severity-scale" data-effect="anticoag-gi" role="radiogroup" aria-label="Anticoag GI severity">
                                        <div class="severity-btn" data-value="0" role="radio" aria-checked="false">None</div>
                                        <div class="severity-btn" data-value="1" role="radio" aria-checked="false">Mild</div>
                                        <div class="severity-btn" data-value="2" role="radio" aria-checked="false">Moderate</div>
                                        <div class="severity-btn severe" data-value="3" role="radio" aria-checked="false">Severe</div>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Hair Loss (Warfarin)</label>
                                    <div class="severity-scale" data-effect="anticoag-hairloss" role="radiogroup" aria-label="Anticoag hairloss severity">
                                        <div class="severity-btn" data-value="0" role="radio" aria-checked="false">None</div>
                                        <div class="severity-btn" data-value="1" role="radio" aria-checked="false">Mild</div>
                                        <div class="severity-btn" data-value="2" role="radio" aria-checked="false">Moderate</div>
                                        <div class="severity-btn severe" data-value="3" role="radio" aria-checked="false">Severe</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="field" style="margin-top:16px">
                            <label for="otherSideEffects">Other Side Effects or Concerns</label>
                            <textarea id="otherSideEffects" placeholder="Describe any other medication side effects you're experiencing..."></textarea>
                        </div>
                    </div>
                    <!-- VITAMIN K INTAKE TRACKING -->
                    <div class="section">
                        <div class="section-header">
                            <span class="section-icon">🥬</span>
                            <span>Vitamin K Intake Tracking (Critical for Warfarin Patients)</span>
                        </div>
                        <div style="color:var(--muted);font-size:0.9rem;margin-bottom:16px"> If you take Warfarin, track your Vitamin K intake. Consistency is key - sudden increases or decreases affect INR. Mark foods consumed today. </div>
                        <div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;padding:12px;margin-bottom:16px"> <strong>⚠️ For Warfarin Patients:</strong> Don't avoid Vitamin K foods completely - maintain CONSISTENT intake. Sudden changes (eating lots of greens one day, none the next) destabilize your INR. </div>
                        <div class="form-grid cols-2">
                            <div class="field">
                                <label for="onWarfarin">Currently Taking Warfarin?</label>
                                <select id="onWarfarin">
                                    <option value="">Select...</option>
                                    <option value="yes">Yes - actively taking Warfarin</option>
                                    <option value="no">No - on different anticoagulant</option>
                                    <option value="not-anticoag">No anticoagulant</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="vitaminKConsistency">Dietary Vitamin K Consistency</label>
                                <select id="vitaminKConsistency">
                                    <option value="">Select...</option>
                                    <option value="consistent">Consistent - eat similar amounts daily</option>
                                    <option value="variable">Variable - intake changes day to day</option>
                                    <option value="increased">Significantly increased today</option>
                                    <option value="decreased">Significantly decreased today</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top:16px;margin-bottom:12px;font-weight:600;color:var(--cyan)">Foods Consumed Today (Check all that apply)</div>
                        <div style="margin-bottom:16px">
                            <div style="font-weight:600;color:var(--warn);margin-bottom:8px">🔴 Very High Vitamin K (>200 mcg per serving)</div>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="vitaminK" value="kale" data-level="high">
                                    <span>Kale (530 mcg/cup)</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="vitaminK" value="spinach" data-level="high">
                                    <span>Spinach (145-888 mcg/cup)</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="vitaminK" value="collard-greens" data-level="high">
                                    <span>Collard Greens (836 mcg/cup)</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="vitaminK" value="turnip-greens" data-level="high">
                                    <span>Turnip Greens (529 mcg/cup)</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="vitaminK" value="mustard-greens" data-level="high">
                                    <span>Mustard Greens (419 mcg/cup)</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="vitaminK" value="swiss-chard" data-level="high">
                                    <span>Swiss Chard (299 mcg/cup)</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="vitaminK" value="parsley" data-level="high">
                                    <span>Parsley (246 mcg/1/4 cup)</span>
                                </label>
                            </div>
                        </div>
                        <div style="margin-bottom:16px">
                            <div style="font-weight:600;color:var(--warn);margin-bottom:8px">🟡 High Vitamin K (50-200 mcg per serving)</div>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="vitaminK" value="broccoli" data-level="moderate">
                                    <span>Broccoli (220 mcg/cup)</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="vitaminK" value="brussels-sprouts" data-level="moderate">
                                    <span>Brussels Sprouts (218 mcg/cup)</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="vitaminK" value="cabbage" data-level="moderate">
                                    <span>Cabbage (163 mcg/cup)</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="vitaminK" value="asparagus" data-level="moderate">
                                    <span>Asparagus (91 mcg/cup)</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="vitaminK" value="lettuce-romaine" data-level="moderate">
                                    <span>Romaine Lettuce (57 mcg/cup)</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="vitaminK" value="green-beans" data-level="moderate">
                                    <span>Green Beans (60 mcg/cup)</span>
                                </label>
                            </div>
                        </div>
                        <div style="margin-bottom:16px">
                            <div style="font-weight:600;color:var(--good);margin-bottom:8px">🟢 Moderate Vitamin K (15-50 mcg per serving)</div>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="vitaminK" value="lettuce-iceberg" data-level="low">
                                    <span>Iceberg Lettuce (17 mcg/cup)</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="vitaminK" value="celery" data-level="low">
                                    <span>Celery (30 mcg/cup)</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="vitaminK" value="peas" data-level="low">
                                    <span>Peas (41 mcg/cup)</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="vitaminK" value="kiwi" data-level="low">
                                    <span>Kiwi (28 mcg/fruit)</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="vitaminK" value="blueberries" data-level="low">
                                    <span>Blueberries (29 mcg/cup)</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="vitaminK" value="avocado" data-level="low">
                                    <span>Avocado (21 mcg/half)</span>
                                </label>
                            </div>
                        </div>
                        <div class="field">
                            <label for="vitaminKServings">Servings of High Vitamin K Foods Today</label>
                            <input type="number" id="vitaminKServings" min="0" placeholder="e.g., 2">
                            <span class="helper-text">Total servings of all high/very high Vitamin K foods</span>
                        </div>
                        <div class="field" style="margin-top:12px">
                            <label for="vitaminKSupplement">Vitamin K Supplement Use</label>
                            <select id="vitaminKSupplement">
                                <option value="">Select...</option>
                                <option value="none">None</option>
                                <option value="multivitamin">Multivitamin (contains Vitamin K)</option>
                                <option value="vitamin-k-supplement">Vitamin K supplement (DANGEROUS with Warfarin!)</option>
                                <option value="green-powder">Green powder/smoothie supplement</option>
                            </select>
                        </div>
                        <div class="field" style="margin-top:12px">
                            <label for="vitaminKNotes">Notes on Diet Changes or Vitamin K Intake</label>
                            <textarea id="vitaminKNotes" placeholder="e.g., Started new diet, ate more salads than usual, avoiding greens lately..."></textarea>
                        </div>
                    </div>
                    <!-- ACTIVITY WITH WALKING SESSIONS -->
                    <div class="section">
                        <div class="section-header">
                            <span class="section-icon">🚶</span>
                            <span>Activity & Exercise</span>
                        </div>
                        <div class="field" style="margin-bottom:16px">
                            <label>Walking Sessions Today</label>
                            <div id="walkingSessionsContainer"></div>
                            <button type="button" class="add-session-btn" id="addWalkingSession">+ Add Walking Session</button>
                        </div>
                        <div class="form-grid cols-3">
                            <div class="field">
                                <label for="steps">Total Steps Today</label>
                                <input type="number" id="steps" placeholder="e.g., 2500">
                            </div>
                            <div class="field">
                                <label for="cardiacRehab">Cardiac Rehab Session</label>
                                <select id="cardiacRehab">
                                    <option value="">Select...</option>
                                    <option value="no">Not today</option>
                                    <option value="yes-completed">Yes - completed</option>
                                    <option value="yes-partial">Yes - partial</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="activityTolerance">Activity Tolerance</label>
                                <select id="activityTolerance">
                                    <option value="">Select...</option>
                                    <option value="excellent">Excellent - no limitations</option>
                                    <option value="good">Good - minor limitations</option>
                                    <option value="fair">Fair - moderate limitations</option>
                                    <option value="poor">Poor - severe limitations</option>
                                    <option value="bedbound">Mostly bedbound</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="stairs">Stairs Climbed Today</label>
                                <input type="number" id="stairs" placeholder="Number of flights">
                            </div>
                            <div class="field">
                                <label for="exerciseSOB">Exercise-Related SOB</label>
                                <select id="exerciseSOB">
                                    <option value="">Select...</option>
                                    <option value="none">None</option>
                                    <option value="mild">Mild - expected</option>
                                    <option value="moderate">Moderate - concerning</option>
                                    <option value="severe">Severe - stopped activity</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <!-- EXERCISE PRESCRIPTION VS ACTUAL PERFORMANCE -->
                    <div class="section" id="exerciseSection">
                        <div class="section-header">
                            <span class="section-icon">🏃</span>
                            <span>Exercise Prescription vs Actual Performance</span>
                        </div>
                        <div style="color:var(--muted);font-size:0.9rem;margin-bottom:16px"> Compare your cardiac rehab targets with what you actually achieved. Track progress over time. </div>
                        <div class="exercise-comparison">
                            <div style="font-weight:600;color:var(--cyan);margin-bottom:12px">Walking Distance</div>
                            <div class="exercise-metric">
                                <span class="exercise-metric-name">Distance</span>
                                <div class="exercise-values">
                                    <div class="exercise-value">
                                        <div class="exercise-value-label">Target</div>
                                        <input type="number" id="walkTargetDistance" step="0.1" placeholder="e.g., 1.5" style="width:80px;text-align:center;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.12);color:var(--ink);padding:6px;border-radius:6px;font-size:1rem;font-weight:700">
                                        <div style="font-size:0.75rem;color:var(--muted);margin-top:2px">miles/km</div>
                                    </div>
                                    <div class="exercise-value">
                                        <div class="exercise-value-label">Achieved</div>
                                        <input type="number" id="walkActualDistance" step="0.1" placeholder="e.g., 1.2" style="width:80px;text-align:center;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.12);color:var(--ink);padding:6px;border-radius:6px;font-size:1rem;font-weight:700">
                                        <div style="font-size:0.75rem;color:var(--muted);margin-top:2px">miles/km</div>
                                    </div>
                                    <div class="exercise-achievement" id="walkDistanceStatus">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="exercise-comparison">
                            <div style="font-weight:600;color:var(--cyan);margin-bottom:12px">Exercise Duration</div>
                            <div class="exercise-metric">
                                <span class="exercise-metric-name">Duration</span>
                                <div class="exercise-values">
                                    <div class="exercise-value">
                                        <div class="exercise-value-label">Target</div>
                                        <input type="number" id="exerciseTargetDuration" placeholder="e.g., 30" style="width:80px;text-align:center;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.12);color:var(--ink);padding:6px;border-radius:6px;font-size:1rem;font-weight:700">
                                        <div style="font-size:0.75rem;color:var(--muted);margin-top:2px">minutes</div>
                                    </div>
                                    <div class="exercise-value">
                                        <div class="exercise-value-label">Achieved</div>
                                        <input type="number" id="exerciseActualDuration" placeholder="e.g., 25" style="width:80px;text-align:center;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.12);color:var(--ink);padding:6px;border-radius:6px;font-size:1rem;font-weight:700">
                                        <div style="font-size:0.75rem;color:var(--muted);margin-top:2px">minutes</div>
                                    </div>
                                    <div class="exercise-achievement" id="exerciseDurationStatus">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="exercise-comparison">
                            <div style="font-weight:600;color:var(--cyan);margin-bottom:12px">Heart Rate During Exercise</div>
                            <div class="exercise-metric">
                                <span class="exercise-metric-name">Average HR</span>
                                <div class="exercise-values">
                                    <div class="exercise-value">
                                        <div class="exercise-value-label">Target Zone</div>
                                        <input type="text" id="exerciseTargetHR" placeholder="e.g., 90-110" style="width:100px;text-align:center;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.12);color:var(--ink);padding:6px;border-radius:6px;font-size:0.95rem;font-weight:700">
                                        <div style="font-size:0.75rem;color:var(--muted);margin-top:2px">bpm range</div>
                                    </div>
                                    <div class="exercise-value">
                                        <div class="exercise-value-label">Actual Avg</div>
                                        <input type="number" id="exerciseActualHR" placeholder="e.g., 105" style="width:80px;text-align:center;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.12);color:var(--ink);padding:6px;border-radius:6px;font-size:1rem;font-weight:700">
                                        <div style="font-size:0.75rem;color:var(--muted);margin-top:2px">bpm</div>
                                    </div>
                                    <div class="exercise-achievement" id="exerciseHRStatus">--</div>
                                </div>
                            </div>
                            <div class="exercise-metric">
                                <span class="exercise-metric-name">Peak HR</span>
                                <div class="exercise-values">
                                    <div class="exercise-value">
                                        <div class="exercise-value-label">Max Allowed</div>
                                        <input type="number" id="exerciseMaxHR" placeholder="e.g., 120" style="width:80px;text-align:center;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.12);color:var(--ink);padding:6px;border-radius:6px;font-size:1rem;font-weight:700">
                                        <div style="font-size:0.75rem;color:var(--muted);margin-top:2px">bpm</div>
                                    </div>
                                    <div class="exercise-value">
                                        <div class="exercise-value-label">Peak Reached</div>
                                        <input type="number" id="exercisePeakHR" placeholder="e.g., 115" style="width:80px;text-align:center;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.12);color:var(--ink);padding:6px;border-radius:6px;font-size:1rem;font-weight:700">
                                        <div style="font-size:0.75rem;color:var(--muted);margin-top:2px">bpm</div>
                                    </div>
                                    <div class="exercise-achievement" id="exercisePeakHRStatus">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="field" style="margin-top:16px">
                            <label for="exerciseNotes">Exercise Notes & Adjustments</label>
                            <textarea id="exerciseNotes" placeholder="e.g., Stopped early due to fatigue, felt stronger today, therapist increased resistance..."></textarea>
                        </div>
                        <div style="margin-top:16px;padding:12px;background:rgba(96,165,250,0.1);border:1px solid rgba(96,165,250,0.3);border-radius:8px">
                            <div style="font-weight:600;margin-bottom:8px">Rehab Therapist Instructions:</div>
                            <div class="form-grid cols-2">
                                <div class="field">
                                    <label for="nextRehabDate">Next Session Date</label>
                                    <input type="date" id="nextRehabDate">
                                </div>
                                <div class="field">
                                    <label for="rehabFrequency">Frequency Per Week</label>
                                    <input type="number" id="rehabFrequency" min="1" max="7" placeholder="e.g., 3">
                                </div>
                                <div class="field">
                                    <label for="therapistNotes">Therapist Notes/Adjustments</label>
                                    <textarea id="therapistNotes" maxlength="300" rows="2" placeholder="Patient tolerated increased resistance well; monitor HR next session..." onfocus="this.rows=6" onblur="if(this.value.length<100)this.rows=2"></textarea>
                                    <span class="helper-text" id="therapistNotesLen">0/300 chars</span>
                                </div>
                            </div>
                        </div>
                        <span class="section-badge" id="exerciseBadge"></span>
                    </div>
                    <!-- MENSTRUAL CYCLE TRACKING -->
                    <div class="section">
                        <div class="section-header">
                            <span class="section-icon">🌸</span>
                            <span>Menstrual Cycle Tracking</span>
                        </div>
                        <div class="form-grid cols-3">
                            <div class="field">
                                <label for="cycleStatus">Cycle Status</label>
                                <select id="cycleStatus">
                                    <option value="">Select...</option>
                                    <option value="before">Before period (Follicular phase)</option>
                                    <option value="during">During period (Menstruation)</option>
                                    <option value="after">After period (Luteal phase)</option>
                                    <option value="ovulation">Ovulation</option>
                                    <option value="not-applicable">Not applicable</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="cycleDay">Cycle Day</label>
                                <input type="number" id="cycleDay" min="1" max="45" placeholder="Day 1-28+">
                                <span class="helper-text">Day 1 = first day of period</span>
                            </div>
                            <div class="field">
                                <label for="daysRelativeToPeriod">Days Until/Since Period</label>
                                <input type="text" id="daysRelativeToPeriod" placeholder="e.g., 5 days before, 2 days after">
                            </div>
                        </div>
                        <div class="form-grid cols-2" style="margin-top:12px">
                            <div class="field">
                                <label for="flowHeaviness">Flow Heaviness (if during period)</label>
                                <select id="flowHeaviness">
                                    <option value="">Select...</option>
                                    <option value="spotting">Spotting</option>
                                    <option value="light">Light</option>
                                    <option value="moderate">Moderate</option>
                                    <option value="heavy">Heavy</option>
                                    <option value="very-heavy">Very heavy (concerning)</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="hormonalSymptoms">Hormonal Symptoms</label>
                                <input type="text" id="hormonalSymptoms" placeholder="e.g., cramps, bloating, mood changes">
                            </div>
                        </div>
                    </div>
                    <!-- PATIENT WELLBEING ASSESSMENT -->
                    <div class="section" id="wellbeingSection">
                        <div class="section-header">
                            <span class="section-icon">😊</span>
                            <span>Patient Well-Being Self-Assessment</span>
                        </div>
                        <div class="field" style="margin-bottom:16px">
                            <label>Overall Well-Being Score (1 = Terrible, 10 = Excellent)</label>
                            <div class="wellbeing-scale" id="wellbeingScale" role="radiogroup" aria-label="Wellbeing scale"></div>
                        </div>
                        <div class="field">
                            <label for="wellbeingSummary">How I'm Feeling Today (Brief Summary)</label>
                            <textarea id="wellbeingSummary" placeholder="Describe how you're feeling overall, any concerns, wins, or observations about your recovery today..."></textarea>
                        </div>
                        <span class="section-badge" id="wellbeingBadge"></span>
                    </div>
                    <!-- DEPRESSION SCREENING (PHQ-9) -->
                    <div class="section" id="phqSection">
                        <div class="section-header">
                            <span class="section-icon">🧠</span>
                            <span>Depression Screening (PHQ-9)</span>
                        </div>
                        <div style="background:rgba(96,165,250,0.1);border:1px solid rgba(96,165,250,0.3);border-radius:8px;padding:16px;margin-bottom:16px">
                            <div style="font-weight:700;margin-bottom:8px">About This Screening:</div>
                            <div style="color:var(--muted);font-size:0.9rem;line-height:1.6"> The PHQ-9 is a validated screening tool for depression. This is NOT a diagnosis - it's a way to monitor your emotional health during recovery. Depression is common after cardiac surgery and can affect your recovery. Answer honestly about how you've felt <strong>over the last 2 weeks</strong>. Share results with your healthcare provider. </div>
                        </div>
                        <div style="color:var(--muted);font-size:0.9rem;margin-bottom:16px"> <strong>Over the last 2 weeks, how often have you been bothered by the following problems?</strong> </div>
                        <div class="phq9-question">
                            <div class="phq9-question-text">1. Little interest or pleasure in doing things</div>
                            <div class="phq9-options" data-question="q1" role="radiogroup" aria-label="PHQ-9 question 1">
                                <div class="phq9-option" data-value="0" role="radio" aria-checked="false">Not at all (0)</div>
                                <div class="phq9-option" data-value="1" role="radio" aria-checked="false">Several days (1)</div>
                                <div class="phq9-option" data-value="2" role="radio" aria-checked="false">More than half the days (2)</div>
                                <div class="phq9-option" data-value="3" role="radio" aria-checked="false">Nearly every day (3)</div>
                            </div>
                        </div>
                        <div class="phq9-question">
                            <div class="phq9-question-text">2. Feeling down, depressed, or hopeless</div>
                            <div class="phq9-options" data-question="q2" role="radiogroup" aria-label="PHQ-9 question 2">
                                <div class="phq9-option" data-value="0" role="radio" aria-checked="false">Not at all (0)</div>
                                <div class="phq9-option" data-value="1" role="radio" aria-checked="false">Several days (1)</div>
                                <div class="phq9-option" data-value="2" role="radio" aria-checked="false">More than half the days (2)</div>
                                <div class="phq9-option" data-value="3" role="radio" aria-checked="false">Nearly every day (3)</div>
                            </div>
                        </div>
                        <div class="phq9-question">
                            <div class="phq9-question-text">3. Trouble falling or staying asleep, or sleeping too much</div>
                            <div class="phq9-options" data-question="q3" role="radiogroup" aria-label="PHQ-9 question 3">
                                <div class="phq9-option" data-value="0" role="radio" aria-checked="false">Not at all (0)</div>
                                <div class="phq9-option" data-value="1" role="radio" aria-checked="false">Several days (1)</div>
                                <div class="phq9-option" data-value="2" role="radio" aria-checked="false">More than half the days (2)</div>
                                <div class="phq9-option" data-value="3" role="radio" aria-checked="false">Nearly every day (3)</div>
                            </div>
                        </div>
                        <div class="phq9-question">
                            <div class="phq9-question-text">4. Feeling tired or having little energy</div>
                            <div class="phq9-options" data-question="q4" role="radiogroup" aria-label="PHQ-9 question 4">
                                <div class="phq9-option" data-value="0" role="radio" aria-checked="false">Not at all (0)</div>
                                <div class="phq9-option" data-value="1" role="radio" aria-checked="false">Several days (1)</div>
                                <div class="phq9-option" data-value="2" role="radio" aria-checked="false">More than half the days (2)</div>
                                <div class="phq9-option" data-value="3" role="radio" aria-checked="false">Nearly every day (3)</div>
                            </div>
                        </div>
                        <div class="phq9-question">
                            <div class="phq9-question-text">5. Poor appetite or overeating</div>
                            <div class="phq9-options" data-question="q5" role="radiogroup" aria-label="PHQ-9 question 5">
                                <div class="phq9-option" data-value="0" role="radio" aria-checked="false">Not at all (0)</div>
                                <div class="phq9-option" data-value="1" role="radio" aria-checked="false">Several days (1)</div>
                                <div class="phq9-option" data-value="2" role="radio" aria-checked="false">More than half the days (2)</div>
                                <div class="phq9-option" data-value="3" role="radio" aria-checked="false">Nearly every day (3)</div>
                            </div>
                        </div>
                        <div class="phq9-question">
                            <div class="phq9-question-text">6. Feeling bad about yourself - or that you are a failure or have let yourself or your family down</div>
                            <div class="phq9-options" data-question="q6" role="radiogroup" aria-label="PHQ-9 question 6">
                                <div class="phq9-option" data-value="0" role="radio" aria-checked="false">Not at all (0)</div>
                                <div class="phq9-option" data-value="1" role="radio" aria-checked="false">Several days (1)</div>
                                <div class="phq9-option" data-value="2" role="radio" aria-checked="false">More than half the days (2)</div>
                                <div class="phq9-option" data-value="3" role="radio" aria-checked="false">Nearly every day (3)</div>
                            </div>
                        </div>
                        <div class="phq9-question">
                            <div class="phq9-question-text">7. Trouble concentrating on things, such as reading the newspaper or watching television</div>
                            <div class="phq9-options" data-question="q7" role="radiogroup" aria-label="PHQ-9 question 7">
                                <div class="phq9-option" data-value="0" role="radio" aria-checked="false">Not at all (0)</div>
                                <div class="phq9-option" data-value="1" role="radio" aria-checked="false">Several days (1)</div>
                                <div class="phq9-option" data-value="2" role="radio" aria-checked="false">More than half the days (2)</div>
                                <div class="phq9-option" data-value="3" role="radio" aria-checked="false">Nearly every day (3)</div>
                            </div>
                        </div>
                        <div class="phq9-question">
                            <div class="phq9-question-text">8. Moving or speaking so slowly that other people could have noticed. Or the opposite - being so fidgety or restless that you have been moving around a lot more than usual</div>
                            <div class="phq9-options" data-question="q8" role="radiogroup" aria-label="PHQ-9 question 8">
                                <div class="phq9-option" data-value="0" role="radio" aria-checked="false">Not at all (0)</div>
                                <div class="phq9-option" data-value="1" role="radio" aria-checked="false">Several days (1)</div>
                                <div class="phq9-option" data-value="2" role="radio" aria-checked="false">More than half the days (2)</div>
                                <div class="phq9-option" data-value="3" role="radio" aria-checked="false">Nearly every day (3)</div>
                            </div>
                        </div>
                        <div class="phq9-question">
                            <div class="phq9-question-text">9. Thoughts that you would be better off dead, or of hurting yourself in some way</div>
                            <div class="phq9-options" data-question="q9" role="radiogroup" aria-label="PHQ-9 question 9">
                                <div class="phq9-option" data-value="0" role="radio" aria-checked="false">Not at all (0)</div>
                                <div class="phq9-option" data-value="1" role="radio" aria-checked="false">Several days (1)</div>
                                <div class="phq9-option" data-value="2" role="radio" aria-checked="false">More than half the days (2)</div>
                                <div class="phq9-option" data-value="3" role="radio" aria-checked="false">Nearly every day (3)</div>
                            </div>
                        </div>
                        <div class="phq9-score-display" id="phq9ScoreDisplay" style="display:none" aria-live="polite">
                            <div>
                                <div class="phq9-score-number" id="phq9Score">0</div>
                                <div class="phq9-score-severity" id="phq9Severity">Not scored</div>
                            </div>
                        </div>
                        <div id="phq9CrisisBox" style="display:none" class="phq9-crisis-box" aria-live="assertive">
                            <div class="phq9-crisis-title">🚨 IMMEDIATE HELP AVAILABLE 🚨</div>
                            <div style="font-size:1rem;margin-bottom:12px"> You indicated thoughts of self-harm. <strong>Please reach out for help right now.</strong> </div>
                            <div class="phq9-crisis-number"> Call or Text 988 </div>
                            <div style="font-size:0.9rem;margin-top:12px"> <strong>988 Suicide & Crisis Lifeline</strong><br> Available 24/7 • Free & Confidential<br> You can also chat online at <strong>988lifeline.org</strong> </div>
                            <div style="margin-top:16px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.2)"> <strong>Other Crisis Resources:</strong><br> • Crisis Text Line: Text HOME to 741741<br> • Veterans Crisis Line: Call 988, Press 1<br> • Emergency: Call 911 </div>
                        </div>
                        <div style="background:rgba(96,165,250,0.1);border:1px solid rgba(96,165,250,0.3);border-radius:8px;padding:12px;margin-top:16px;font-size:0.85rem;color:var(--muted)"> <strong>Important:</strong> This screening tool helps identify symptoms but is NOT a diagnosis. Depression is treatable. If your score indicates depression symptoms, please discuss results with your doctor, therapist, or mental health provider. Cardiac surgery patients commonly experience depression, and treatment can significantly improve your recovery and quality of life. </div>
                        <span class="section-badge" id="phqBadge"></span>
                    </div>
                    <!-- ADDITIONAL SYMPTOMS TO REPORT -->
                    <div class="section">
                        <div class="section-header">
                            <span class="section-icon">⚠️</span>
                            <span>Critical Warning Symptoms (Check all that apply)</span>
                        </div>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="symptom" value="chest-pressure">
                                <span>New chest pressure/pain</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="symptom" value="jaw-pain">
                                <span>Jaw or arm pain</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="symptom" value="cold-sweats">
                                <span>Cold sweats</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="symptom" value="confusion">
                                <span>Confusion/disorientation</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="symptom" value="vision-changes">
                                <span>Vision changes</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="symptom" value="speech-difficulty">
                                <span>Speech difficulty</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="symptom" value="weakness">
                                <span>One-sided weakness</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="symptom" value="rapid-weight-gain">
                                <span>Rapid weight gain (2+ lbs/day)</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="symptom" value="fever">
                                <span>Fever over 100.4°F</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="symptom" value="bleeding">
                                <span>Unusual bleeding/bruising</span>
                            </label>
                        </div>
                    </div>
                    <!-- NOTES -->
                    <div class="section">
                        <div class="section-header">
                            <span class="section-icon">📝</span>
                            <span>Additional Notes & Observations</span>
                        </div>
                        <div class="field">
                            <label for="notes">Daily notes, concerns, questions for doctor</label>
                            <textarea id="notes" placeholder="Any other observations, questions for next appointment, things to discuss with care team..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="tab-panel" id="physician-review-panel" role="tabpanel" aria-labelledby="physician-review">
                    <div class="accordion" style="margin-bottom:24px">
                        <details>
                            <summary>Customize Scoring</summary>
                            <div style="padding:16px">
                                <p style="color:var(--muted);margin-bottom:16px">Adjust weights for patient-specific risks (e.g., boost Rhythm for AFib patients). Defaults based on ACC/AHA guidelines.</p>
                                <div class="form-grid cols-2">
                                    <div class="field">
                                        <label for="weightVitals">Vitals Weight (%)</label>
                                        <input type="range" id="weightVitals" min="0" max="30" value="20">
                                        <span id="valVitals">20%</span>
                                    </div>
                                    <div class="field">
                                        <label for="weightRhythm">Rhythm Weight (%)</label>
                                        <input type="range" id="weightRhythm" min="0" max="30" value="15">
                                        <span id="valRhythm">15%</span>
                                    </div>
                                    <div class="field">
                                        <label for="weightPain">Pain/Wound Weight (%)</label>
                                        <input type="range" id="weightPain" min="0" max="30" value="15">
                                        <span id="valPain">15%</span>
                                    </div>
                                    <div class="field">
                                        <label for="weightSymptoms">Symptoms Weight (%)</label>
                                        <input type="range" id="weightSymptoms" min="0" max="30" value="20">
                                        <span id="valSymptoms">20%</span>
                                    </div>
                                    <div class="field">
                                        <label for="weightLabs">Labs/Meds Weight (%)</label>
                                        <input type="range" id="weightLabs" min="0" max="20" value="10">
                                        <span id="valLabs">10%</span>
                                    </div>
                                    <div class="field">
                                        <label for="weightActivity">Activity/Wellbeing Weight (%)</label>
                                        <input type="range" id="weightActivity" min="0" max="20" value="10">
                                        <span id="valActivity">10%</span>
                                    </div>
                                    <div class="field">
                                        <label for="weightPhq">PHQ-9 Weight (%)</label>
                                        <input type="range" id="weightPhq" min="0" max="20" value="10">
                                        <span id="valPhq">10%</span>
                                    </div>
                                </div>
                                <button type="button" id="resetScoring" style="margin-top:16px;padding:8px 16px;background:var(--warn);color:#000;border:none;border-radius:8px">Reset to Defaults</button>
                                <div style="margin-top:8px;font-size:0.85rem;color:var(--muted)">Custom profile saved and applied. Audit trail logged in exports.</div>
                            </div>
                        </details>
                    </div>
                    <!-- HOME DEVICE READINGS -->
                    <div class="section">
                        <div class="section-header">
                            <span class="section-icon">📱</span>
                            <span>Home Device Readings</span>
                        </div>
                        <div style="color:var(--muted);font-size:0.9rem;margin-bottom:16px"> Record readings from your home monitoring devices. This ensures accuracy and tracks device compliance. </div>
                        <div class="device-reading">
                            <div class="device-header">
                                <span class="device-name">🩺 Blood Pressure Monitor</span>
                                <input type="time" id="bpDeviceTime" step="60" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.12);color:var(--ink);padding:6px 10px;border-radius:6px;font-size:0.85rem">
                            </div>
                            <div class="form-grid cols-3">
                                <div class="field">
                                    <label for="bpDeviceBrand">Device Brand/Model</label>
                                    <input type="text" id="bpDeviceBrand" placeholder="e.g., Omron Series 10">
                                </div>
                                <div class="field">
                                    <label for="bpDeviceReading">Systolic/Diastolic (mmHg)</label>
                                    <input type="text" id="bpDeviceReading" placeholder="e.g., 122/78" pattern="[0-9]{2,3}/[0-9]{2,3}">
                                </div>
                                <div class="field">
                                    <label for="bpDevicePulse">Pulse from BP Monitor (bpm)</label>
                                    <input type="number" id="bpDevicePulse" placeholder="e.g., 74">
                                </div>
                            </div>
                            <div class="form-grid cols-2" style="margin-top:8px">
                                <div class="field">
                                    <label for="bpArm">Measurement Arm</label>
                                    <select id="bpArm">
                                        <option value="">Select...</option>
                                        <option value="left">Left arm</option>
                                        <option value="right">Right arm</option>
                                    </select>
                                </div>
                                <div class="field">
                                    <label for="bpPosition">Position During Measurement</label>
                                    <select id="bpPosition">
                                        <option value="">Select...</option>
                                        <option value="seated-rest">Seated, after 5min rest</option>
                                        <option value="seated-immediate">Seated, immediate</option>
                                        <option value="lying">Lying down</option>
                                        <option value="standing">Standing</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="device-reading">
                            <div class="device-header">
                                <span class="device-name">🫁 Pulse Oximeter</span>
                                <input type="time" id="pulseOxTime" step="60" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.12);color:var(--ink);padding:6px 10px;border-radius:6px;font-size:0.85rem">
                            </div>
                            <div class="form-grid cols-3">
                                <div class="field">
                                    <label for="pulseOxBrand">Device Brand/Model</label>
                                    <input type="text" id="pulseOxBrand" placeholder="e.g., Nonin Onyx II">
                                </div>
                                <div class="field">
                                    <label for="pulseOxReading">SpO₂ Reading (%)</label>
                                    <input type="number" id="pulseOxReading" min="70" max="100" placeholder="e.g., 97">
                                </div>
                                <div class="field">
                                    <label for="pulseOxHR">Heart Rate (bpm)</label>
                                    <input type="number" id="pulseOxHR" placeholder="e.g., 72">
                                </div>
                            </div>
                            <div class="form-grid cols-2" style="margin-top:8px">
                                <div class="field">
                                    <label for="pulseOxFinger">Finger Used</label>
                                    <select id="pulseOxFinger">
                                        <option value="">Select...</option>
                                        <option value="index">Index finger</option>
                                        <option value="middle">Middle finger</option>
                                        <option value="ring">Ring finger</option>
                                    </select>
                                </div>
                                <div class="field">
                                    <label for="pulseOxQuality">Signal Quality</label>
                                    <select id="pulseOxQuality">
                                        <option value="">Select...</option>
                                        <option value="excellent">Excellent (strong signal)</option>
                                        <option value="good">Good</option>
                                        <option value="fair">Fair (weak signal)</option>
                                        <option value="poor">Poor (unreliable)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="device-reading">
                            <div class="device-header">
                                <span class="device-name">⚖️ Digital Scale</span>
                                <input type="time" id="scaleTime" step="60" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.12);color:var(--ink);padding:6px 10px;border-radius:6px;font-size:0.85rem">
                            </div>
                            <div class="form-grid cols-3">
                                <div class="field">
                                    <label for="scaleBrand">Device Brand/Model</label>
                                    <input type="text" id="scaleBrand" placeholder="e.g., Withings Body+">
                                </div>
                                <div class="field">
                                    <label for="scaleReading">Weight Reading (lbs or kg)</label>
                                    <input type="number" id="scaleReading" step="0.1" placeholder="e.g., 165.2">
                                </div>
                                <div class="field">
                                    <label for="scaleTimimg">Measurement Timing</label>
                                    <select id="scaleTimimg">
                                        <option value="">Select...</option>
                                        <option value="morning-empty">Morning, empty bladder</option>
                                        <option value="morning-after-eating">Morning, after eating</option>
                                        <option value="evening">Evening</option>
                                        <option value="after-exercise">After exercise</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="device-reading">
                            <div class="device-header">
                                <span class="device-name">⚡ Pacemaker Home Monitor</span>
                                <input type="time" id="pacemakerTime" step="60" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.12);color:var(--ink);padding:6px 10px;border-radius:6px;font-size:0.85rem">
                            </div>
                            <div class="form-grid cols-3">
                                <div class="field">
                                    <label for="pacemakerSystem">Device System</label>
                                    <input type="text" id="pacemakerSystem" placeholder="e.g., Medtronic CareLink">
                                </div>
                                <div class="field">
                                    <label for="pacemakerTransmission">Transmission Status</label>
                                    <select id="pacemakerTransmission">
                                        <option value="">Select...</option>
                                        <option value="successful">Successful transmission</option>
                                        <option value="failed">Failed transmission</option>
                                        <option value="not-transmitted">Not transmitted today</option>
                                        <option value="scheduled">Scheduled for later</option>
                                    </select>
                                </div>
                                <div class="field">
                                    <label for="pacemakerAlerts">Any Alerts from Device?</label>
                                    <select id="pacemakerAlerts">
                                        <option value="">Select...</option>
                                        <option value="none">No alerts</option>
                                        <option value="battery">Battery alert</option>
                                        <option value="lead">Lead impedance alert</option>
                                        <option value="arrhythmia">Arrhythmia detected</option>
                                        <option value="other">Other alert</option>
                                    </select>
                                </div>
                            </div>
                            <div style="margin-top:16px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.06)">
                                <div style="font-weight:600;color:var(--cyan);margin-bottom:12px">Pacemaker Interrogation Data</div>
                                <div class="form-grid cols-3">
                                    <div class="field">
                                        <label for="pacemakerAtrialPaced">% Atrial Paced</label>
                                        <input type="number" id="pacemakerAtrialPaced" min="0" max="100" placeholder="e.g., 45">
                                    </div>
                                    <div class="field">
                                        <label for="pacemakerVentricularPaced">% Ventricular Paced</label>
                                        <input type="number" id="pacemakerVentricularPaced" min="0" max="100" placeholder="e.g., 90">
                                    </div>
                                    <div class="field">
                                        <label for="pacemakerBattery">Battery Status (% or years remaining)</label>
                                        <input type="text" id="pacemakerBattery" placeholder="e.g., 85% or 2 years">
                                    </div>
                                    <div class="field">
                                        <label for="pacemakerAtrialImpedance">Atrial Lead Impedance (ohms)</label>
                                        <input type="number" id="pacemakerAtrialImpedance" placeholder="e.g., 550">
                                    </div>
                                    <div class="field">
                                        <label for="pacemakerVentricularImpedance">Ventricular Lead Impedance (ohms)</label>
                                        <input type="number" id="pacemakerVentricularImpedance" placeholder="e.g., 620">
                                    </div>
                                </div>
                            </div>
                            <div class="field" style="margin-top:8px">
                                <label for="pacemakerData">Pacemaker Data Summary (if available)</label>
                                <textarea id="pacemakerData" placeholder="e.g., % paced, battery level, any events captured..."></textarea>
                            </div>
                        </div>
                        <div class="field">
                            <label for="deviceNotes">Device Calibration Notes</label>
                            <textarea id="deviceNotes" placeholder="Note any device issues, calibration dates, battery replacements, troubleshooting..."></textarea>
                        </div>
                    </div>
                    <!-- ANTICOAGULATION MANAGEMENT -->
                    <div class="section" id="anticoagSection">
                        <div class="section-header">
                            <span class="section-icon">🩸</span>
                            <span>Anticoagulation Management</span>
                        </div>
                        <div style="color:var(--muted);font-size:0.9rem;margin-bottom:16px"> Track anticoagulant details and management over time. This creates a historical record for you and your providers. </div>
                        <div class="form-grid cols-3">
                            <div class="field">
                                <label>Anticoagulant Type</label>
                                <div class="form-grid cols-2" style="gap:8px">
                                    <select id="physAnticoagType">
                                        <option value="">Select Type...</option>
                                        <option value="warfarin">Warfarin</option>
                                        <option value="rivaroxaban">Rivaroxaban (Xarelto)</option>
                                        <option value="apixaban">Apixaban (Eliquis)</option>
                                        <option value="dabigatran">Dabigatran (Pradaxa)</option>
                                        <option value="edoxaban">Edoxaban (Savaysa)</option>
                                        <option value="other">Other</option>
                                    </select>
                                    <input type="text" id="physAnticoagDose" placeholder="Dose e.g., 20 mg">
                                </div>
                                <div id="physDoacNotes" style="display:none;font-size:0.85rem;color:var(--warn);margin-top:4px">Monitor for bleeding; no routine labs needed.</div>
                            </div>
                            <div class="field" id="warfarinFields" style="display:none">
                                <label for="inrProvider">INR Managing Provider</label>
                                <select id="inrProvider">
                                    <option value="">Select...</option>
                                    <option value="cardiologist">Cardiologist</option>
                                    <option value="pcp">Primary Care Physician</option>
                                    <option value="anticoag-clinic">Anticoagulation Clinic</option>
                                    <option value="cardiac-surgeon">Cardiac Surgeon</option>
                                    <option value="other">Other Specialist</option>
                                </select>
                            </div>
                            <div class="field" id="inrProviderNameField" style="display:none">
                                <label for="inrProviderName">Provider Name/Clinic</label>
                                <input type="text" id="inrProviderName" placeholder="e.g., Dr. Smith, City Anticoag Clinic">
                            </div>
                            <div class="field" id="inrProviderPhoneField" style="display:none">
                                <label for="inrProviderPhone">Provider Phone</label>
                                <input type="tel" id="inrProviderPhone" placeholder="e.g., (555) 123-4567">
                            </div>
                        </div>
                        <div id="warfarinManagement" style="display:none;margin-top:20px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.06)">
                            <div style="font-weight:600;color:var(--cyan);margin-bottom:12px">Today's INR & Warfarin Dose</div>
                            <div class="form-grid cols-3">
                                <div class="field">
                                    <label for="todayINR">Today's INR Result</label>
                                    <input type="number" id="todayINR" step="0.1" min="0" max="10" placeholder="e.g., 2.5">
                                    <span class="helper-text">Target: 2.0-3.0 (most valve patients)</span>
                                </div>
                                <div class="field">
                                    <label for="todayWarfarinDose">Current Warfarin Daily Dose (mg)</label>
                                    <input type="number" id="todayWarfarinDose" step="0.5" min="0" max="20" placeholder="e.g., 5">
                                </div>
                                <div class="field">
                                    <label for="warfarinDoseChange">Dose Change Instructions</label>
                                    <select id="warfarinDoseChange">
                                        <option value="">Select...</option>
                                        <option value="no-change">No change - continue same dose</option>
                                        <option value="increase">Increase dose</option>
                                        <option value="decrease">Decrease dose</option>
                                        <option value="hold-1-day">Hold 1 day, then restart</option>
                                        <option value="hold-2-days">Hold 2 days, then restart</option>
                                        <option value="complex">Complex dosing schedule</option>
                                    </select>
                                </div>
                            </div>
                            <div class="field" style="margin-top:12px">
                                <label for="warfarinNewDoseInstructions">New Dose Instructions (if changed)</label>
                                <textarea id="warfarinNewDoseInstructions" placeholder="e.g., Take 5mg Mon/Wed/Fri/Sun, 7.5mg Tue/Thu/Sat..."></textarea>
                            </div>
                            <div style="margin-top:20px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.06)">
                                <div style="font-weight:600;color:var(--cyan);margin-bottom:12px">Next INR Check Schedule</div>
                                <div class="form-grid cols-3">
                                    <div class="field">
                                        <label for="nextINRDate">Next INR Date</label>
                                        <input type="date" id="nextINRDate">
                                    </div>
                                    <div class="field">
                                        <label for="nextINRLocation">Check Location</label>
                                        <select id="nextINRLocation">
                                            <option value="">Select...</option>
                                            <option value="clinic">Clinic/Office</option>
                                            <option value="lab">Independent Lab</option>
                                            <option value="home-monitor">Home INR Monitor</option>
                                            <option value="hospital">Hospital Lab</option>
                                        </select>
                                    </div>
                                    <div class="field">
                                        <label for="nextINRTime">Appointment Time</label>
                                        <input type="time" id="nextINRTime">
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top:20px;padding-top:16px;border-top:1px solid rgba(255,255,255,0.06)">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                                    <div style="font-weight:600;color:var(--cyan)">Recent INR History</div>
                                    <button type="button" id="addINRHistory" style="padding:6px 12px;font-size:0.85rem">+ Add Past INR</button>
                                </div>
                                <div id="inrHistoryContainer"></div>
                            </div>
                        </div>
                        <div class="field" style="margin-top:16px">
                            <label for="anticoagNotes">Anticoagulation Notes</label>
                            <textarea id="anticoagNotes" placeholder="e.g., Dietary changes, missed doses, bleeding events, bruising..."></textarea>
                        </div>
                        <span class="section-badge" id="anticoagBadge"></span>
                    </div>
                    <!-- LAB VALUES - EXPANDED -->
                    <div class="section">
                        <div class="section-header">
                            <span class="section-icon">🧪</span>
                            <span>Lab Values (if checked today)</span>
                       </div>
                        <div class="form-grid cols-4">
                            <div class="field">
                                <label for="inr">INR (Warfarin monitoring)</label>
                                <input type="number" id="inr" step="0.1" min="0" max="10" placeholder="e.g., 2.5">
                                <span class="helper-text">Target: 2.0-3.0</span>
                                <span class="error-text" id="inrError" style="display:none"></span>
                            </div>
                            <div class="field">
                                <label for="potassiumLevel">Potassium (K+)</label>
                                <input type="number" id="potassiumLevel" step="0.1" min="0" max="10" placeholder="e.g., 4.2">
                                <span class="helper-text">Normal: 3.5-5.0</span>
                            </div>
                            <div class="field">
                                <label for="magnesiumLevel">Magnesium (Mg)</label>
                                <input type="number" id="magnesiumLevel" step="0.1" min="0" max="5" placeholder="e.g., 2.0">
                                <span class="helper-text">Normal: 1.7-2.2</span>
                            </div>
                            <div class="field">
                                <label for="bnp">BNP/NT-proBNP</label>
                                <input type="number" id="bnp" placeholder="e.g., 450">
                                <span class="helper-text">Heart failure marker</span>
                            </div>
                            <div class="field">
                                <label for="creatinine">Creatinine (kidney)</label>
                                <input type="number" id="creatinine" step="0.01" placeholder="e.g., 1.1">
                                <span class="helper-text">Normal: 0.6-1.2</span>
                            </div>
                            <div class="field">
                                <label for="hemoglobin">Hemoglobin (Hgb)</label>
                                <input type="number" id="hemoglobin" step="0.1" placeholder="e.g., 12.5">
                                <span class="helper-text">Normal: 12-16 g/dL</span>
                            </div>
                            <div class="field">
                                <label for="rbc">RBC (Red Blood Cells)</label>
                                <input type="number" id="rbc" step="0.1" placeholder="e.g., 4.5">
                                <span class="helper-text">Normal: 4.0-5.5 M/μL</span>
                            </div>
                            <div class="field">
                                <label for="wbc">WBC (White Blood Cells)</label>
                                <input type="number" id="wbc" step="0.1" placeholder="e.g., 7.5">
                                <span class="helper-text">Normal: 4.5-11.0 K/μL</span>
                            </div>
                            <div class="field">
                                <label for="crp">CRP (C-Reactive Protein)</label>
                                <input type="number" id="crp" step="0.1" placeholder="e.g., 5.0">
                                <span class="helper-text">Normal: <10 mg/L</span>
                            </div>
                            <div class="field">
                                <label for="fibrinogen">Fibrinogen</label>
                                <input type="number" id="fibrinogen" step="1" placeholder="e.g., 300">
                                <span class="helper-text">Normal: 200-400 mg/dL</span>
                            </div>
                            <div class="field">
                                <label for="nextLabDate">Next Lab Date</label>
                                <input type="date" id="nextLabDate">
                            </div>
                        </div>
                    </div>
                    <!-- PROVIDER CONTACT LOG & FOLLOW-UP SCHEDULE -->
                    <div class="section" id="providerSection">
                        <div class="section-header">
                            <span class="section-icon">👨‍⚕️</span>
                            <span>Provider Contact Log & Follow-Up Schedule</span>
                        </div>
                        <div style="color:var(--muted);font-size:0.9rem;margin-bottom:16px"> Track your healthcare team contacts and upcoming appointments. System alerts for overdue follow-ups. </div>
                        <div class="provider-card">
                            <div class="provider-header">
                                <span class="provider-name">💺 Primary Care Physician (PCP)</span>
                                <span class="provider-status current" id="pcpStatus">Current</span>
                            </div>
                            <div class="form-grid cols-3">
                                <div class="field">
                                    <label for="pcpName">Provider Name</label>
                                    <input type="text" id="pcpName" placeholder="Dr. Smith">
                                </div>
                                <div class="field">
                                    <label for="pcpPhone">Office Phone</label>
                                    <input type="tel" id="pcpPhone" placeholder="(555) 123-4567">
                                </div>
                                <div class="field">
                                    <label for="pcpLastContact">Last Contact Date</label>
                                    <input type="date" id="pcpLastContact">
                                </div>
                            </div>
                            <div class="form-grid cols-2" style="margin-top:8px">
                                <div class="field">
                                    <label for="pcpNextAppt">Next Scheduled Appointment</label>
                                    <input type="date" id="pcpNextAppt">
                                </div>
                                <div class="field">
                                    <label for="pcpInterval">Recommended Follow-Up Interval</label>
                                    <select id="pcpInterval">
                                        <option value="">Select...</option>
                                        <option value="1-week">1 week</option>
                                        <option value="2-weeks">2 weeks</option>
                                        <option value="1-month">1 month</option>
                                        <option value="3-months">3 months</option>
                                        <option value="6-months">6 months</option>
                                        <option value="annual">Annual</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="provider-card">
                            <div class="provider-header">
                                <span class="provider-name">❤️ Cardiologist</span>
                                <span class="provider-status current" id="cardioStatus">Current</span>
                            </div>
                            <div class="form-grid cols-3">
                                <div class="field">
                                    <label for="cardioName">Provider Name</label>
                                    <input type="text" id="cardioName" placeholder="Dr. Johnson">
                                </div>
                                <div class="field">
                                    <label for="cardioPhone">Office Phone</label>
                                    <input type="tel" id="cardioPhone" placeholder="(555) 234-5678">
                                </div>
                                <div class="field">
                                    <label for="cardioLastContact">Last Contact Date</label>
                                    <input type="date" id="cardioLastContact">
                                </div>
                            </div>
                            <div class="form-grid cols-2" style="margin-top:8px">
                                <div class="field">
                                    <label for="cardioNextAppt">Next Scheduled Appointment</label>
                                    <input type="date" id="cardioNextAppt">
                                </div>
                                <div class="field">
                                    <label for="cardioInterval">Recommended Follow-Up Interval</label>
                                    <select id="cardioInterval">
                                        <option value="">Select...</option>
                                        <option value="1-week">1 week</option>
                                        <option value="2-weeks">2 weeks</option>
                                        <option value="1-month">1 month</option>
                                        <option value="6-weeks">6 weeks</option>
                                        <option value="3-months">3 months</option>
                                        <option value="6-months">6 months</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="provider-card">
                            <div class="provider-header">
                                <span class="provider-name">🔪 Cardiac Surgeon</span>
                                <span class="provider-status current" id="surgeonStatus">Current</span>
                            </div>
                            <div class="form-grid cols-3">
                                <div class="field">
                                    <label for="surgeonName">Provider Name</label>
                                    <input type="text" id="surgeonName" placeholder="Dr. Williams">
                                </div>
                                <div class="field">
                                    <label for="surgeonPhone">Office Phone</label>
                                    <input type="tel" id="surgeonPhone" placeholder="(555) 345-6789">
                                </div>
                                <div class="field">
                                    <label for="surgeonLastContact">Last Contact Date</label>
                                    <input type="date" id="surgeonLastContact">
                                </div>
                            </div>
                            <div class="form-grid cols-2" style="margin-top:8px">
                                <div class="field">
                                    <label for="surgeonNextAppt">Next Scheduled Appointment</label>
                                    <input type="date" id="surgeonNextAppt">
                                </div>
                                <div class="field">
                                    <label for="surgeonInterval">Recommended Follow-Up Interval</label>
                                    <select id="surgeonInterval">
                                        <option value="">Select...</option>
                                        <option value="2-weeks">2 weeks</option>
                                        <option value="6-weeks">6 weeks</option>
                                        <option value="3-months">3 months</option>
                                        <option value="6-months">6 months</option>
                                        <option value="annual">Annual</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="provider-card">
                            <div class="provider-header">
                                <span class="provider-name">⚡ Electrophysiologist (EP)</span>
                                <span class="provider-status current" id="epStatus">Current</span>
                            </div>
                            <div class="form-grid cols-3">
                                <div class="field">
                                    <label for="epName">Provider Name</label>
                                    <input type="text" id="epName" placeholder="Dr. Brown">
                                </div>
                                <div class="field">
                                    <label for="epPhone">Office Phone</label>
                                    <input type="tel" id="epPhone" placeholder="(555) 456-7890">
                                </div>
                                <div class="field">
                                    <label for="epLastContact">Last Contact Date</label>
                                    <input type="date" id="epLastContact">
                                </div>
                            </div>
                            <div class="form-grid cols-2" style="margin-top:8px">
                                <div class="field">
                                    <label for="epNextAppt">Next Scheduled Appointment</label>
                                    <input type="date" id="epNextAppt">
                                </div>
                                <div class="field">
                                    <label for="epInterval">Recommended Follow-Up Interval</label>
                                    <select id="epInterval">
                                        <option value="">Select...</option>
                                        <option value="3-months">3 months (pacemaker check)</option>
                                        <option value="6-months">6 months</option>
                                        <option value="annual">Annual</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="provider-card">
                            <div class="provider-header">
                                <span class="provider-name">💪 Cardiac Rehab</span>
                                <span class="provider-status current" id="rehabStatus">Current</span>
                            </div>
                            <div class="form-grid cols-3">
                                <div class="field">
                                    <label for="rehabName">Facility/Therapist Name</label>
                                    <input type="text" id="rehabName" placeholder="City Cardiac Rehab Center">
                                </div>
                                <div class="field">
                                    <label for="rehabPhone">Phone</label>
                                    <input type="tel" id="rehabPhone" placeholder="(555) 567-8901">
                                </div>
                                <div class="field">
                                    <label for="rehabLastSession">Last Session Date</label>
                                    <input type="date" id="rehabLastSession">
                                </div>
                            </div>
                            <div class="form-grid cols-2" style="margin-top:8px">
                                <div class="field">
                                    <label for="rehabSessionsPerWeek">Sessions Per Week</label>
                                    <input type="number" id="rehabSessionsPerWeek" min="1" max="7" placeholder="e.g., 3">
                                </div>
                                <div class="field">
                                    <label for="rehabTotalSessions">Total Sessions Prescribed</label>
                                    <input type="number" id="rehabTotalSessions" placeholder="e.g., 36">
                                </div>
                            </div>
                            <div class="field" style="margin-top:8px">
                                <label for="rehabCompletedSessions">Sessions Completed</label>
                                <input type="number" id="rehabCompletedSessions" placeholder="e.g., 12">
                            </div>
                        </div>
                        <div id="overdueApptAlert" style="display:none;background:rgba(239,68,68,0.15);border:2px solid var(--bad);border-radius:10px;padding:16px;margin-top:16px;font-weight:600"> ⚠️ OVERDUE FOLLOW-UP: You have one or more overdue appointments or follow-ups. Please contact your providers to schedule. </div>
                    </div>
                    <!-- Post Surgical Recovery Summary -->
                    <div class="section post-surgical-collapsible" id="postSurgicalSection">
                        <div class="section-header">
                            <span class="section-icon">🏥</span>
                            <span>Post Surgical Recovery Summary <button type="button" class="toggle-collapse" onclick="togglePostSurgical(this)">+</button></span>
                        </div>
                        <div class="post-surgical-content" id="postSurgicalContent">
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="recoveryOutcome" value="uneventful">
                                    <span>Uneventful Recovery</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="recoveryOutcome" value="heart-block">
                                    <span>Heart Block</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="recoveryOutcome" value="new-onset-afib">
                                    <span>New-Onset AFib</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="recoveryOutcome" value="infection">
                                    <span>Infection</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="recoveryOutcome" value="bleeding">
                                    <span>Bleeding</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="recoveryOutcome" value="other">
                                    <span>Other</span>
                                </label>
                            </div>
                            <div class="form-grid cols-3" style="margin-top:16px">
                                <div class="field">
                                    <label for="eventDate">Date of Event</label>
                                    <input type="date" id="eventDate">
                                </div>
                                <div class="field">
                                    <label for="whatHappened">What Happened (100 chars)</label>
                                    <textarea id="whatHappened" maxlength="100" rows="2" placeholder="Developed 3rd-degree block POD#3"></textarea>
                                    <span id="whatLen">0/100 chars</span>
                                </div>
                                <div class="field">
                                    <label for="interventions">Interventions</label>
                                    <textarea id="interventions" rows="2" placeholder="Temporary pacemaker; started Amiodarone 200mg"></textarea>
                                </div>
                                <div class="field">
                                    <label for="patientResponse">Patient Response</label>
                                    <textarea id="patientResponse" rows="2" placeholder="Resolved in 48hrs; stable rhythm"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="submit-section">
                    <button type="button" id="clearForm">Clear Form</button>
                    <button type="submit" class="btn-primary">💾 Save Entry</button>
                </div>
            </form>
        </div>
        <div class="history">
            <div class="history-header">
                <h2>📊 Recovery History & Assessment</h2>
                <div class="dashboard-pills" id="dashboardPills">
                    <span class="dashboard-pill good" onclick="scrollToSection('vitalsSection')">Vitals: Green</span>
                    <span class="dashboard-pill good" onclick="scrollToSection('rhythmSection')">Rhythm: Green</span>
                    <span class="dashboard-pill good" onclick="scrollToSection('painSection')">Pain/Wound: Green</span>
                    <span class="dashboard-pill good" onclick="scrollToSection('symptomsSection')">Symptoms: Green</span>
                    <span class="dashboard-pill good" onclick="scrollToSection('medsSection')">Labs/Meds: Green</span>
                    <span class="dashboard-pill good" onclick="scrollToSection('activitySection')">Activity: Green</span>
                    <span class="dashboard-pill good" onclick="scrollToSection('phqSection')">PHQ-9: Green</span>
                </div>
                <div class="history-controls">
                    <div class="field">
                        <label for="historySearch" class="sr-only">Search Entries</label>
                        <input type="text" id="historySearch" placeholder="Search by keyword...">
                    </div>
                    <div class="field">
                        <label for="historyDateStart">From Date</label>
                        <input type="date" id="historyDateStart">
                    </div>
                    <div class="field">
                        <label for="historyDateEnd">To Date</label>
                        <input type="date" id="historyDateEnd">
                    </div>
                    <button id="clearHistory">Clear All History</button>
                </div>
            </div>
            <div class="why-status" id="whyStatus">
                <strong>Why this status?</strong><br>
                <div id="statusBreakdown"></div>
            </div>
            <div class="charts" id="chartsContainer" style="display:none">
                <canvas id="weightChart" style="max-height:300px;margin-bottom:24px"></canvas>
                <canvas id="painChart" style="max-height:300px;margin-bottom:24px"></canvas>
                <canvas id="phq9Chart" style="max-height:300px;margin-bottom:24px"></canvas>
            </div>
            <div class="entries" id="entriesContainer">
                <div class="empty-state">
                    <p style="font-size:3rem;margin-bottom:12px">💓</p>
                    <p>No entries yet. Create your first entry above!</p>
                </div>
            </div>
        </div>
        <div class="footer-brand">
            <div class="heart-icon" style="font-size:2rem;margin-bottom:8px">💓</div>
            <div class="brand-name">HEARTBEAT™</div>
            <div class="brand-tagline">Healing Evaluation & Assessment for Recovery Tracking</div>
            <div style="margin-top:12px;font-size:0.9rem"> Powered by <strong style="color:var(--pink)">John E. Desautels & Associates</strong> </div>
            <div style="margin-top:8px;font-size:0.8rem;color:#6b7280"> Advanced Cardiac Recovery Analytics & Patient Monitoring Solutions </div>
            <div style="margin-top:16px;font-size:0.85rem;color:var(--cyan);font-weight:600;cursor:pointer" onclick="openWhatsNewModal()"> ✨ Enhanced Features: Pain Trends • Real-Time Validation • Pacemaker Data • Backend Integration (Beta) </div>
        </div>
        <div style="background:rgba(239,68,68,0.15);border:2px solid var(--bad);border-radius:12px;padding:24px;margin-top:32px;text-align:center">
            <div style="font-size:1.8rem;margin-bottom:12px">⚠️ IMPORTANT MEDICAL DISCLAIMER ⚠️</div>
            <div style="font-size:1rem;line-height:1.7;max-width:900px;margin:0 auto">
                <p style="margin-bottom:16px"><strong style="font-size:1.1rem">This application is for tracking and monitoring purposes ONLY.</strong></p>
                <p style="margin-bottom:16px"><strong>DO NOT rely on this data, reference ranges, or recovery scores to make medical decisions.</strong> All reference ranges and alert thresholds are general guidelines and may not apply to your specific medical situation.</p>
                <p style="margin-bottom:16px"><strong>You MUST consult with your physician, cardiologist, or healthcare provider</strong> for proper medical advice, diagnosis, treatment decisions, and interpretation of your health data.</p>
                <p style="margin-bottom:0"><strong>In case of emergency or concerning symptoms, call 911 or go to the nearest emergency room immediately.</strong> Do not wait for your next scheduled appointment.</p>
            </div>
        </div>
    </div>
    <!-- Scoring Guide Modal -->
    <div id="scoringModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeScoringModal()">&times;</span>
            <h2>Scoring Guide</h2>
            <p>Overall Score = 100 - Risk Points. Based on ACC/AHA post-op guidelines + clinical validation.</p>
            <table class="scoring-table">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Max Points</th>
                        <th>Examples</th>
                        <th>Sources</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Vitals</td>
                        <td>20</td>
                        <td>HR >110 (+5), O2 <92 (+5)</td>
                        <td>ACC/AHA Guidelines</td>
                    </tr>
                    <tr>
                        <td>Rhythm</td>
                        <td>15</td>
                        <td>AFib (+8), Frequent palpitations (+4)</td>
                        <td>ACC/AHA AFib</td>
                    </tr>
                    <tr>
                        <td>Pain/Wound</td>
                        <td>15</td>
                        <td>Pain ≥7 (+10), Dehiscence (+10)</td>
                        <td>Surgical Site Infection Guidelines</td>
                    </tr>
                    <tr>
                        <td>Symptoms</td>
                        <td>20</td>
                        <td>Severe SOB (+8), Syncope (+6)</td>
                        <td>Post-Op Symptom Tracking</td>
                    </tr>
                    <tr>
                        <td>Labs/Meds</td>
                        <td>10</td>
                        <td>INR out of range (+5), Missed doses (+3-10)</td>
                        <td>Anticoag Guidelines</td>
                    </tr>
                    <tr>
                        <td>Activity/Wellbeing</td>
                        <td>10</td>
                        <td>Bedbound (+5), Low ADL avg (+5)</td>
                        <td>Rehab Protocols</td>
                    </tr>
                    <tr>
                        <td>PHQ-9</td>
                        <td>10</td>
                        <td>≥20 (+10), ≥15 (+7)</td>
                        <td>PHQ-9 Validation Studies</td>
                    </tr>
                </tbody>
            </table>
            <p>Suggest periodic review with cardiologist. Weights customizable in Physician tab.</p>
        </div>
    </div>
    <!-- What's New Modal -->
    <div id="whatsNewModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeWhatsNewModal()">&times;</span>
            <h2>What's New</h2>
            <ul style="color:var(--ink);line-height:1.6">
                <li><strong>Pain Trends:</strong> Track changes vs. yesterday with visual comparisons.</li>
                <li><strong>Real-Time Validation:</strong> Instant feedback on vitals, labs, and inputs.</li>
                <li><strong>Pacemaker Data:</strong> Log interrogation results and alerts.</li>
                <li><strong>Backend Integration (Beta):</strong> Secure sync with Firebase for multi-device access.</li>
            </ul>
        </div>
    </div>
    <script>
        // HIPAA Compliance: Encrypt localStorage
        const SECRET_KEY = 'heartbeat-hipaa-2025-xai';
        function encryptData(data) {
            return CryptoJS.AES.encrypt(JSON.stringify(data), SECRET_KEY).toString();
        }
        function decryptData(encrypted) {
            try {
                const decrypted = CryptoJS.AES.decrypt(encrypted, SECRET_KEY);
                return JSON.parse(decrypted.toString(CryptoJS.enc.Utf8));
            } catch (e) {
                console.warn('Decryption failed:', e);
                return null;
            }
        }
        function getEncryptedStorage(key, defaultValue = null) {
            const encrypted = localStorage.getItem(key);
            return encrypted ? decryptData(encrypted) : defaultValue;
        }
        function setEncryptedStorage(key, data) {
            localStorage.setItem(key, encryptData(data));
        }
        // Physician Tab Access Control (simple PIN)
        let physicianUnlocked = sessionStorage.getItem('physicianUnlocked') === 'true';
        function unlockPhysicianTab(pin = null) {
            if (!physicianUnlocked) {
                const enteredPin = pin || prompt('Physician Access PIN (default: 1234)');
                if (enteredPin === '1234') {
                    physicianUnlocked = true;
                    sessionStorage.setItem('physicianUnlocked', 'true');
                    document.querySelector('[data-tab="physician-review"]').click();
                } else {
                    alert('Invalid PIN. Patient access only.');
                    return false;
                }
            }
            return true;
        }
        // Audit Log
        function logAudit(action, details = {}) {
            const audit = getEncryptedStorage('auditLog', []);
            audit.unshift({ action, timestamp: new Date().toISOString(), details, user: physicianUnlocked ? 'Physician' : 'Patient' });
            setEncryptedStorage('auditLog', audit.slice(0, 100)); // Limit to 100 entries
        }
        // Mock backend sync for local testing
        function syncToBackend(entry) {
            return new Promise((resolve, reject) => {
                console.log('Mock syncing to backend:', entry);
                setTimeout(() => {
                    resolve('Mock sync successful');
                }, 1000);
            });
        }
        // Initialize custom condition
        const savedCondition = getEncryptedStorage('patientCondition');
        if (savedCondition) {
            document.getElementById('patientInfo').textContent = savedCondition;
            document.getElementById('customCondition').value = savedCondition;
        }
        document.getElementById('customCondition').addEventListener('change', function () {
            const condition = this.value.trim() || 'Cardiac Surgery Recovery Tracker';
            document.getElementById('patientInfo').textContent = condition;
            setEncryptedStorage('patientCondition', condition);
            logAudit('update-condition', { condition });
        });
        // Initialize date
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('entryDate').valueAsDate = new Date();
        document.getElementById('entryTime').value = new Date().toTimeString().slice(0, 5);
        // Load saved surgery date and baseline weight from encrypted storage
        const savedSurgeryDate = getEncryptedStorage('surgeryDate');
        const savedBaselineWeight = getEncryptedStorage('baselineWeight');
        if (savedSurgeryDate) {
            document.getElementById('surgeryDate').value = savedSurgeryDate;
        }
        if (savedBaselineWeight) {
            document.getElementById('baselineWeight').value = savedBaselineWeight;
        }
        // Auto-calculate days post-op when entry date or surgery date changes
        function calculateDaysPostOp() {
            const surgeryDate = document.getElementById('surgeryDate').value;
            const entryDate = document.getElementById('entryDate').value;
            if (surgeryDate && entryDate) {
                const surgery = new Date(surgeryDate);
                const entry = new Date(entryDate);
                const diffTime = entry - surgery;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                document.getElementById('daysPostOp').value = diffDays >= 0 ? diffDays : 0;
            }
        }
        document.getElementById('surgeryDate').addEventListener('change', function () {
            setEncryptedStorage('surgeryDate', this.value);
            calculateDaysPostOp();
            logAudit('update-surgery-date', { date: this.value });
        });
        document.getElementById('entryDate').addEventListener('change', calculateDaysPostOp);
        calculateDaysPostOp();
        // Auto-calculate weight deviation
        function calculateWeightDeviation() {
            const baseline = parseFloat(document.getElementById('baselineWeight').value);
            const current = parseFloat(document.getElementById('weight').value);
            if (!isNaN(baseline) && !isNaN(current)) {
                const deviation = current - baseline;
                const sign = deviation >= 0 ? '+' : '';
                document.getElementById('weightDeviation').value = sign + deviation.toFixed(1) + ' lbs/kg';
                // Flag if gaining more than 2 lbs
                if (deviation > 2) {
                    document.getElementById('weightDeviation').style.color = 'var(--bad)';
                    document.getElementById('weightDeviation').style.fontWeight = '700';
                } else {
                    document.getElementById('weightDeviation').style.color = 'var(--ink)';
                    document.getElementById('weightDeviation').style.fontWeight = '600';
                }
            } else {
                document.getElementById('weightDeviation').value = '';
            }
        }
        document.getElementById('baselineWeight').addEventListener('input', function () {
            setEncryptedStorage('baselineWeight', this.value);
            calculateWeightDeviation();
            logAudit('update-baseline-weight', { weight: this.value });
        });
        document.getElementById('weight').addEventListener('input', calculateWeightDeviation);
        // Auto-calculate fluid balance
        function calculateFluidBalance() {
            const restriction = parseFloat(document.getElementById('fluidRestriction').value);
            const intake = parseFloat(document.getElementById('fluidIntake').value);
            if (!isNaN(restriction) && !isNaN(intake)) {
                const balance = intake - restriction;
                const sign = balance >= 0 ? '+' : '';
                document.getElementById('fluidBalance').value = sign + balance + ' mL/oz';
                // Flag if over restriction
                if (balance > 0) {
                    document.getElementById('fluidBalance').style.color = 'var(--warn)';
                    document.getElementById('fluidBalance').style.fontWeight = '700';
                } else {
                    document.getElementById('fluidBalance').style.color = 'var(--good)';
                    document.getElementById('fluidBalance').style.fontWeight = '600';
                }
            } else {
                document.getElementById('fluidBalance').value = '';
            }
        }
        document.getElementById('fluidRestriction').addEventListener('input', calculateFluidBalance);
        document.getElementById('fluidIntake').addEventListener('input', calculateFluidBalance);
        // Helper functions for safe parsing
        function safeParseFloat(value, defaultValue = NaN) {
            try {
                const parsed = parseFloat(value);
                return isNaN(parsed) ? defaultValue : parsed;
            } catch {
                return defaultValue;
            }
        }
        const safeParseInt = (value, defaultValue = NaN) => {
            try {
                const parsed = parseInt(value);
                return isNaN(parsed) ? defaultValue : parsed;
            } catch {
                return defaultValue;
            }
        };
        // Generate pain scales with ARIA
        function createPainScale(containerId, fieldName) {
            const container = document.getElementById(containerId);
            container.setAttribute('role', 'radiogroup');
            container.setAttribute('aria-label', `${fieldName} scale`);
            for (let i = 0; i <= 10; i++) {
                const btn = document.createElement('div');
                btn.className = 'pain-btn';
                btn.textContent = i;
                btn.dataset.value = i;
                btn.dataset.field = fieldName;
                btn.setAttribute('role', 'radio');
                btn.setAttribute('aria-checked', 'false');
                btn.tabIndex = i === 0 ? 0 : -1;
                btn.addEventListener('click', function () {
                    container.querySelectorAll('.pain-btn').forEach(b => {
                        b.classList.remove('selected', 'high');
                        b.setAttribute('aria-checked', 'false');
                        b.tabIndex = -1;
                    });
                    this.classList.add('selected');
                    this.setAttribute('aria-checked', 'true');
                    this.tabIndex = 0;
                    if (i >= 7) this.classList.add('high');
                });
                btn.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        btn.click();
                    }
                });
                container.appendChild(btn);
            }
        }
        createPainScale('chestPainScale', 'chestPain');
        createPainScale('bodyPainScale', 'bodyPain');
        // Generate wellbeing scale with ARIA
        function createWellbeingScale() {
            const container = document.getElementById('wellbeingScale');
            container.setAttribute('role', 'radiogroup');
            container.setAttribute('aria-label', 'Wellbeing scale');
            for (let i = 1; i <= 10; i++) {
                const btn = document.createElement('div');
                btn.className = 'wellbeing-btn';
                btn.textContent = i;
                btn.dataset.value = i;
                btn.setAttribute('role', 'radio');
                btn.setAttribute('aria-checked', 'false');
                btn.tabIndex = i === 1 ? 0 : -1;
                btn.addEventListener('click', function () {
                    container.querySelectorAll('.wellbeing-btn').forEach(b => {
                        b.classList.remove('selected', 'high', 'low');
                        b.setAttribute('aria-checked', 'false');
                        b.tabIndex = -1;
                    });
                    this.classList.add('selected');
                    this.setAttribute('aria-checked', 'true');
                    this.tabIndex = 0;
                    if (i >= 8) this.classList.add('high');
                    if (i <= 3) this.classList.add('low');
                });
                btn.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        btn.click();
                    }
                });
                container.appendChild(btn);
            }
        }
        createWellbeingScale();
        // Generate ADL scales with ARIA
        function createADLScales() {
            document.querySelectorAll('.adl-scale').forEach(container => {
                const adlName = container.dataset.adl;
                container.setAttribute('role', 'radiogroup');
                container.setAttribute('aria-label', `${adlName} ADL scale`);
                for (let i = 1; i <= 10; i++) {
                    const btn = document.createElement('div');
                    btn.className = 'adl-btn';
                    btn.textContent = i;
                    btn.dataset.value = i;
                    btn.dataset.adl = adlName;
                    btn.setAttribute('role', 'radio');
                    btn.setAttribute('aria-checked', 'false');
                    btn.tabIndex = i === 1 ? 0 : -1;
                    btn.addEventListener('click', function () {
                        container.querySelectorAll('.adl-btn').forEach(b => {
                            b.classList.remove('selected', 'high', 'low');
                            b.setAttribute('aria-checked', 'false');
                            b.tabIndex = -1;
                        });
                        this.classList.add('selected');
                        this.setAttribute('aria-checked', 'true');
                        this.tabIndex = 0;
                        if (i >= 8) this.classList.add('high');
                        if (i <= 3) this.classList.add('low');
                    });
                    btn.addEventListener('keydown', function (e) {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            btn.click();
                        }
                    });
                    container.appendChild(btn);
                }
            });
        }
        createADLScales();
        // Walking sessions management
        let walkingSessionCount = 0;
        function addWalkingSession() {
            walkingSessionCount++;
            const container = document.getElementById('walkingSessionsContainer');
            const sessionDiv = document.createElement('div');
            sessionDiv.className = 'walking-session';
            const inputId = 'walkingSession' + walkingSessionCount;
            sessionDiv.innerHTML = `
                <label for="${inputId}" class="sr-only">Session ${walkingSessionCount} minutes</label>
                <input type="number" id="${inputId}" placeholder="Session ${walkingSessionCount} minutes" data-session="${walkingSessionCount}">
                <button type="button" onclick="this.parentElement.remove()">Remove</button>
            `;
            container.appendChild(sessionDiv);
        }
        document.getElementById('addWalkingSession').addEventListener('click', addWalkingSession);
        addWalkingSession();
        // Handle checkbox styling
        document.querySelectorAll('.checkbox-item input').forEach(cb => {
            cb.addEventListener('change', function () {
                if (this.checked) {
                    this.closest('.checkbox-item').classList.add('checked');
                } else {
                    this.closest('.checkbox-item').classList.remove('checked');
                }
            });
        });
        // Original Symptoms Persistence
        document.getElementById('originalSymptomsGroup').addEventListener('change', function (e) {
            const checked = Array.from(this.querySelectorAll('input:checked')).map(cb => cb.value);
            setEncryptedStorage('originalSymptoms', checked);
            document.getElementById('symptomsSaved').textContent = '✓ Saved';
            setTimeout(() => document.getElementById('symptomsSaved').textContent = '', 2000);
            logAudit('update-symptoms', { symptoms: checked });
        });
        const savedSymptoms = getEncryptedStorage('originalSymptoms', []);
        savedSymptoms.forEach(symptom => {
            const cb = document.querySelector(`#originalSymptomsGroup input[value="${symptom}"]`);
            if (cb) cb.checked = true;
            cb?.closest('.checkbox-item').classList.add('checked');
        });
        // Review Context Button
        document.getElementById('reviewContextBtn').addEventListener('click', function () {
            const checked = Array.from(document.querySelectorAll('#originalSymptomsGroup input:checked')).map(cb => cb.nextElementSibling.textContent);
            const summary = document.getElementById('contextSummary');
            if (checked.length > 0) {
                summary.innerHTML = '<strong>Selected:</strong> ' + checked.map(c => `<span class="context-pill">${c}</span>`).join(' ');
            } else {
                summary.innerHTML = '<span style="color:var(--warn)">No symptoms selected</span>';
            }
            summary.style.display = 'block';
        });
        // Medication Adherence Dose Trackers
        function createDoseTracker(containerSelector, medName, defaultDoses = 2) {
            const container = document.querySelector(containerSelector);
            const doseInput = document.getElementById(medName + 'Doses');
            const statusEl = document.getElementById(medName + 'AdherenceStatus');
            function updateTracker() {
                let numDoses = parseInt(doseInput.value);
                if (isNaN(numDoses) || numDoses < 1) numDoses = defaultDoses;
                if (numDoses > 4) numDoses = 4;
                container.innerHTML = '';
                for (let i = 1; i <= numDoses; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'dose-slot';
                    slot.textContent = `Dose ${i}`;
                    slot.dataset.dose = i;
                    slot.dataset.status = 'pending';
                    slot.role = 'button';
                    slot.tabindex = '0';
                    slot.addEventListener('click', function () {
                        if (this.dataset.status === 'pending') {
                            this.dataset.status = 'taken';
                            this.classList.add('taken');
                            this.textContent = `Dose ${i} ✓`;
                        } else if (this.dataset.status === 'taken') {
                            this.dataset.status = 'missed';
                            this.classList.remove('taken');
                            this.classList.add('missed');
                            this.textContent = `Dose ${i} ✗`;
                        } else {
                            this.dataset.status = 'pending';
                            this.classList.remove('missed');
                            this.textContent = `Dose ${i}`;
                        }
                        updateAdherenceStatus();
                    });
                    slot.addEventListener('keydown', function (e) {
                        if (e.key === 'Enter' || e.key === ' ') {
                            slot.click();
                        }
                    });
                    container.appendChild(slot);
                }
                updateAdherenceStatus();
            }
            function updateAdherenceStatus() {
                const slots = container.querySelectorAll('.dose-slot');
                const taken = Array.from(slots).filter(s => s.dataset.status === 'taken').length;
                const missed = Array.from(slots).filter(s => s.dataset.status === 'missed').length;
                const total = slots.length;
                if (taken === total) {
                    statusEl.textContent = 'Fully Compliant';
                    statusEl.className = 'adherence-status compliant';
                } else if (missed > 0) {
                    statusEl.textContent = `${missed} Dose(s) Missed`;
                    statusEl.className = 'adherence-status skipped';
                } else if (taken > 0) {
                    statusEl.textContent = `${taken}/${total} Taken`;
                    statusEl.className = 'adherence-status missed';
                } else {
                    statusEl.textContent = 'Not Set';
                    statusEl.className = 'adherence-status';
                }
            }
            doseInput.addEventListener('change', updateTracker);
            updateTracker();
        }
        createDoseTracker('#betaBlockerDoseTracker', 'betaBlocker', 2);
        createDoseTracker('#diureticDoseTracker', 'diuretic', 2);
        createDoseTracker('#anticoagulantDoseTracker', 'anticoagulant', 1);
        createDoseTracker('#antiarrhythmicDoseTracker', 'antiarrhythmic', 1);
        // Sync Anticoagulant Across Tabs
        function syncAnticoag() {
            const type = document.getElementById('anticoagType').value;
            const dose = document.getElementById('anticoagDose').value;
            document.getElementById('physAnticoagType').value = type;
            document.getElementById('physAnticoagDose').value = dose;
            const warFields = document.getElementById('warfarinFields');
            const warMgmt = document.getElementById('warfarinManagement');
            const inrName = document.getElementById('inrProviderNameField');
            const inrPhone = document.getElementById('inrProviderPhoneField');
            const doacNotes = document.getElementById('doacNotes');
            const physDoacNotes = document.getElementById('physDoacNotes');
            if (type === 'warfarin') {
                warFields.style.display = 'block';
                warMgmt.style.display = 'block';
                inrName.style.display = 'block';
                inrPhone.style.display = 'block';
                doacNotes.style.display = 'none';
                physDoacNotes.style.display = 'none';
            } else {
                warFields.style.display = 'none';
                warMgmt.style.display = 'none';
                inrName.style.display = 'none';
                inrPhone.style.display = 'none';
                if (type && type !== 'other') {
                    doacNotes.style.display = 'block';
                    physDoacNotes.style.display = 'block';
                } else {
                    doacNotes.style.display = 'none';
                    physDoacNotes.style.display = 'none';
                }
            }
        }
        document.getElementById('anticoagType').addEventListener('change', syncAnticoag);
        document.getElementById('anticoagDose').addEventListener('input', syncAnticoag);
        document.getElementById('physAnticoagType').addEventListener('change', syncAnticoag);
        document.getElementById('physAnticoagDose').addEventListener('input', syncAnticoag);
        // Side Effect Severity Buttons with ARIA
        document.querySelectorAll('.severity-scale').forEach(scale => {
            scale.setAttribute('role', 'radiogroup');
            const effectName = scale.dataset.effect;
            scale.setAttribute('aria-label', `${effectName} severity scale`);
            scale.querySelectorAll('.severity-btn').forEach(btn => {
                btn.setAttribute('role', 'radio');
                btn.setAttribute('aria-checked', 'false');
                btn.tabIndex = 0;
                btn.addEventListener('click', function () {
                    scale.querySelectorAll('.severity-btn').forEach(b => {
                        b.classList.remove('selected');
                        b.setAttribute('aria-checked', 'false');
                    });
                    this.classList.add('selected');
                    this.setAttribute('aria-checked', 'true');
                });
                btn.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        btn.click();
                    }
                });
            });
        });
        // Wound Photo Upload Handler with base64
        document.getElementById('woundPhotos').addEventListener('change', function (e) {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';
            const photos = [];
            const files = Array.from(e.target.files);
            if (files.length > 5) {
                alert('Warning: Uploading more than 5 photos may increase storage usage significantly. Consider compressing images.');
            }
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    photos.push(e.target.result);
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.alt = `Wound photo ${index + 1}`;
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
            window.woundPhotosData = photos;
            logAudit('upload-photos', { count: photos.length });
        });
        // Post-Op Complication Alert
        document.querySelectorAll('input[name="pericardiotomy"], input[name="pleural"], input[name="pericardial"], input[name="tamponade"]').forEach(cb => {
            cb.addEventListener('change', function () {
                const anyChecked = document.querySelectorAll('input[name="pericardiotomy"]:checked').length > 0 ||
                    document.querySelectorAll('input[name="pleural"]:checked').length > 0 ||
                    document.querySelectorAll('input[name="pericardial"]:checked').length > 0 ||
                    document.querySelectorAll('input[name="tamponade"]:checked').length > 0;
                document.getElementById('complicationAlert').style.display = anyChecked ? 'block' : 'none';
            });
        });
        // PHQ-9 Depression Screening with ARIA
        function initPHQ9() {
            const questions = document.querySelectorAll('.phq9-options');
            const scoreDisplay = document.getElementById('phq9ScoreDisplay');
            const scoreNumber = document.getElementById('phq9Score');
            const scoreSeverity = document.getElementById('phq9Severity');
            const crisisBox = document.getElementById('phq9CrisisBox');
            questions.forEach(questionGroup => {
                questionGroup.setAttribute('role', 'radiogroup');
                const questionNum = questionGroup.dataset.question;
                questionGroup.setAttribute('aria-label', `PHQ-9 question ${questionNum}`);
                questionGroup.querySelectorAll('.phq9-option').forEach(option => {
                    option.setAttribute('role', 'radio');
                    option.setAttribute('aria-checked', 'false');
                    option.tabIndex = 0;
                    option.addEventListener('click', function () {
                        questionGroup.querySelectorAll('.phq9-option').forEach(opt => {
                            opt.classList.remove('selected');
                            opt.setAttribute('aria-checked', 'false');
                        });
                        this.classList.add('selected');
                        this.setAttribute('aria-checked', 'true');
                        calculatePHQ9Score();
                    });
                    option.addEventListener('keydown', function (e) {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            option.click();
                        }
                    });
                });
            });
            function calculatePHQ9Score() {
                let totalScore = 0;
                let allAnswered = true;
                let q9Value = 0;
                questions.forEach((questionGroup, index) => {
                    const selected = questionGroup.querySelector('.phq9-option.selected');
                    if (selected) {
                        const value = parseInt(selected.dataset.value);
                        totalScore += value;
                        if (index === 8) q9Value = value;
                    } else {
                        allAnswered = false;
                    }
                });
                if (allAnswered) {
                    scoreDisplay.style.display = 'block';
                    scoreNumber.textContent = totalScore;
                    if (q9Value > 0) {
                        crisisBox.style.display = 'block';
                    } else {
                        crisisBox.style.display = 'none';
                    }
                    let severity, className;
                    if (totalScore <= 4) {
                        severity = 'Minimal Depression';
                        className = 'minimal';
                    } else if (totalScore <= 9) {
                        severity = 'Mild Depression';
                        className = 'mild';
                    } else if (totalScore <= 14) {
                        severity = 'Moderate Depression';
                        className = 'moderate';
                    } else if (totalScore <= 19) {
                        severity = 'Moderately Severe Depression';
                        className = 'moderately-severe';
                    } else {
                        severity = 'Severe Depression';
                        className = 'severe';
                    }
                    scoreSeverity.textContent = severity;
                    scoreDisplay.className = `phq9-score-display ${className}`;
                } else {
                    scoreDisplay.style.display = 'none';
                    crisisBox.style.display = 'none';
                }
            }
        }
        initPHQ9();
        // Exercise Prescription vs Actual Comparison
        function updateExerciseComparisons() {
            const walkTarget = safeParseFloat(document.getElementById('walkTargetDistance').value);
            const walkActual = safeParseFloat(document.getElementById('walkActualDistance').value);
            const walkStatus = document.getElementById('walkDistanceStatus');
            if (!isNaN(walkTarget) && !isNaN(walkActual)) {
                const percentage = (walkActual / walkTarget) * 100;
                if (percentage >= 100) {
                    walkStatus.textContent = '✓ Exceeded';
                    walkStatus.className = 'exercise-achievement exceeded';
                } else if (percentage >= 80) {
                    walkStatus.textContent = '✓ Met Goal';
                    walkStatus.className = 'exercise-achievement met';
                } else {
                    walkStatus.textContent = `${percentage.toFixed(0)}% of goal`;
                    walkStatus.className = 'exercise-achievement below';
                }
            } else {
                walkStatus.textContent = '--';
                walkStatus.className = 'exercise-achievement';
            }
            const durationTarget = safeParseFloat(document.getElementById('exerciseTargetDuration').value);
            const durationActual = safeParseFloat(document.getElementById('exerciseActualDuration').value);
            const durationStatus = document.getElementById('exerciseDurationStatus');
            if (!isNaN(durationTarget) && !isNaN(durationActual)) {
                const percentage = (durationActual / durationTarget) * 100;
                if (percentage >= 100) {
                    durationStatus.textContent = '✓ Exceeded';
                    durationStatus.className = 'exercise-achievement exceeded';
                } else if (percentage >= 80) {
                    durationStatus.textContent = '✓ Met Goal';
                    durationStatus.className = 'exercise-achievement met';
                } else {
                    durationStatus.textContent = `${percentage.toFixed(0)}% of goal`;
                    durationStatus.className = 'exercise-achievement below';
                }
            } else {
                durationStatus.textContent = '--';
                durationStatus.className = 'exercise-achievement';
            }
            const hrTarget = document.getElementById('exerciseTargetHR').value.trim();
            const hrActual = safeParseFloat(document.getElementById('exerciseActualHR').value);
            const hrStatus = document.getElementById('exerciseHRStatus');
            if (hrTarget && !isNaN(hrActual)) {
                const range = hrTarget.split('-').map(v => parseInt(v.trim()));
                if (range.length === 2 && !isNaN(range[0]) && !isNaN(range[1])) {
                    if (hrActual >= range[0] && hrActual <= range[1]) {
                        hrStatus.textContent = '✓ In Zone';
                        hrStatus.className = 'exercise-achievement met';
                    } else if (hrActual < range[0]) {
                        hrStatus.textContent = 'Below Zone';
                        hrStatus.className = 'exercise-achievement below';
                    } else {
                        hrStatus.textContent = 'Above Zone';
                        hrStatus.className = 'exercise-achievement below';
                    }
                } else {
                    hrStatus.textContent = '--';
                    hrStatus.className = 'exercise-achievement';
                }
            } else {
                hrStatus.textContent = '--';
                hrStatus.className = 'exercise-achievement';
            }
            const maxHR = safeParseFloat(document.getElementById('exerciseMaxHR').value);
            const peakHR = safeParseFloat(document.getElementById('exercisePeakHR').value);
            const peakStatus = document.getElementById('exercisePeakHRStatus');
            if (!isNaN(maxHR) && !isNaN(peakHR)) {
                if (peakHR <= maxHR) {
                    peakStatus.textContent = '✓ Safe';
                    peakStatus.className = 'exercise-achievement met';
                } else {
                    peakStatus.textContent = 'Exceeded Max';
                    peakStatus.className = 'exercise-achievement below';
                }
            } else {
                peakStatus.textContent = '--';
                peakStatus.className = 'exercise-achievement';
            }
        }
        ['walkTargetDistance', 'walkActualDistance', 'exerciseTargetDuration', 'exerciseActualDuration', 'exerciseTargetHR', 'exerciseActualHR', 'exerciseMaxHR', 'exercisePeakHR'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateExerciseComparisons);
        });
        // Therapist Notes Char Count
        document.getElementById('therapistNotes').addEventListener('input', function () {
            document.getElementById('therapistNotesLen').textContent = this.value.length + '/300 chars';
        });
        // What Happened Char Count
        document.getElementById('whatHappened').addEventListener('input', function () {
            document.getElementById('whatLen').textContent = this.value.length + '/100 chars';
        });
        // INR History Management
        let inrHistoryCount = 0;
        function addINRHistoryItem() {
            inrHistoryCount++;
            const container = document.getElementById('inrHistoryContainer');
            const item = document.createElement('div');
            item.className = 'inr-history-item';
            const dateId = 'inrDate' + inrHistoryCount;
            const inrId = 'inrValue' + inrHistoryCount;
            const doseId = 'inrDose' + inrHistoryCount;
            item.innerHTML = `
                <div class="inr-details">
                    <label for="${dateId}" class="sr-only">Date</label>
                    <input type="date" id="${dateId}" placeholder="Date" style="width:140px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.12);color:var(--ink);padding:6px;border-radius:6px;font-size:0.9rem">
                    <label for="${inrId}" class="sr-only">INR</label>
                    <input type="number" id="${inrId}" step="0.1" placeholder="INR" style="width:80px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.12);color:var(--ink);padding:6px;border-radius:6px;font-size:0.9rem">
                    <label for="${doseId}" class="sr-only">Dose (mg)</label>
                    <input type="number" id="${doseId}" step="0.5" placeholder="Dose (mg)" style="width:100px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.12);color:var(--ink);padding:6px;border-radius:6px;font-size:0.9rem">
                </div>
                <button type="button" onclick="this.parentElement.remove()" style="padding:6px 12px;font-size:0.85rem">Remove</button>
            `;
            container.appendChild(item);
        }
        document.getElementById('addINRHistory').addEventListener('click', addINRHistoryItem);
        // Provider Contact Status Checking
        function checkProviderStatuses() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const providers = ['pcp', 'cardio', 'surgeon', 'ep', 'rehab'];
            let anyOverdue = false;
            providers.forEach(provider => {
                const nextApptInput = document.getElementById(provider + 'NextAppt');
                const statusEl = document.getElementById(provider + 'Status');
                if (nextApptInput && nextApptInput.value) {
                    const apptDate = new Date(nextApptInput.value);
                    apptDate.setHours(0, 0, 0, 0);
                    const diffTime = apptDate - today;
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    if (diffDays < 0) {
                        statusEl.textContent = 'Overdue';
                        statusEl.className = 'provider-status overdue';
                        anyOverdue = true;
                    } else if (diffDays <= 7) {
                        statusEl.textContent = 'Upcoming';
                        statusEl.className = 'provider-status upcoming';
                    } else {
                        statusEl.textContent = 'Current';
                        statusEl.className = 'provider-status current';
                    }
                } else {
                    statusEl.textContent = 'Current';
                    statusEl.className = 'provider-status current';
                }
            });
            document.getElementById('overdueApptAlert').style.display = anyOverdue ? 'block' : 'none';
        }
        ['pcpNextAppt', 'cardioNextAppt', 'surgeonNextAppt', 'epNextAppt', 'rehabLastSession'].forEach(id => {
            const elem = document.getElementById(id);
            if (elem) {
                elem.addEventListener('change', checkProviderStatuses);
            }
        });
        checkProviderStatuses();
        // Post Surgical Toggle
        function togglePostSurgical(btn) {
            const content = document.getElementById('postSurgicalContent');
            content.classList.toggle('open');
            btn.textContent = content.classList.contains('open') ? '-' : '+';
        }
        // Local storage for entries (encrypted)
        let entries = getEncryptedStorage('cardiacEntries', []);
        // Default Weights
        const defaultWeights = { vitals: 20, rhythm: 15, pain: 15, symptoms: 20, labs: 10, activity: 10, phq: 10 };
        let customWeights = getEncryptedStorage('customWeights', defaultWeights);
        // Update Weight Sliders
        function updateWeightSliders() {
            ['vitals', 'rhythm', 'pain', 'symptoms', 'labs', 'activity', 'phq'].forEach(w => {
                const slider = document.getElementById(`weight${w.charAt(0).toUpperCase() + w.slice(1)}`);
                if (slider) {
                    slider.value = customWeights[w];
                    document.getElementById(`val${w.charAt(0).toUpperCase() + w.slice(1)}`).textContent = customWeights[w] + '%';
                    slider.addEventListener('input', function () {
                        customWeights[w] = parseInt(this.value);
                        document.getElementById(`val${w.charAt(0).toUpperCase() + w.slice(1)}`).textContent = this.value + '%';
                        setEncryptedStorage('customWeights', customWeights);
                        logAudit('customize-weights', { weights: customWeights });
                    });
                }
            });
        }
        document.getElementById('resetScoring')?.addEventListener('click', function () {
            customWeights = { ...defaultWeights };
            setEncryptedStorage('customWeights', customWeights);
            updateWeightSliders();
            logAudit('reset-weights');
            alert('Reset to defaults.');
        });
        updateWeightSliders();
        // RECOVERY SCORE ALGORITHM with custom weights
        function calculateRecoveryScore(entry) {
            console.log('Calculating recovery score for entry:', entry);
            let riskPoints = 0;
            const weights = physicianUnlocked ? customWeights : defaultWeights;
            // VITAL SIGNS (weights.vitals points)
            if (entry.heartRate) {
                const hr = safeParseInt(entry.heartRate);
                if (!isNaN(hr)) {
                    if (hr > 110 || hr < 50) riskPoints += weights.vitals * 0.25;
                    else if (hr > 100 || hr < 55) riskPoints += weights.vitals * 0.15;
                    console.log(`HR: ${hr}, riskPoints: +${riskPoints}`);
                }
            }
            if (entry.oxygenSat) {
                const ox = safeParseInt(entry.oxygenSat);
                if (!isNaN(ox)) {
                    if (ox < 90) riskPoints += weights.vitals * 0.35;
                    else if (ox < 92) riskPoints += weights.vitals * 0.25;
                    else if (ox < 94) riskPoints += weights.vitals * 0.1;
                    console.log(`O2: ${ox}, riskPoints: +${riskPoints}`);
                }
            }
            if (entry.temperature) {
                const temp = safeParseFloat(entry.temperature);
                if (!isNaN(temp)) {
                    if (temp > 100.4) riskPoints += weights.vitals * 0.25;
                    else if (temp > 99.5) riskPoints += weights.vitals * 0.1;
                    console.log(`Temp: ${temp}, riskPoints: +${riskPoints}`);
                }
            }
            if (entry.bloodPressure) {
                const bpParts = entry.bloodPressure.split('/');
                if (bpParts.length === 2) {
                    const sys = safeParseInt(bpParts[0].trim());
                    const dia = safeParseInt(bpParts[1].trim());
                    if (!isNaN(sys) && !isNaN(dia)) {
                        if (sys < 90 || sys > 160 || dia < 50 || dia > 100) riskPoints += weights.vitals * 0.15;
                        console.log(`BP: ${sys}/${dia}, riskPoints: +${riskPoints}`);
                    }
                }
            }
            const vitalsRisk = riskPoints;
            // CARDIAC RHYTHM (weights.rhythm points)
            if (entry.rhythm === 'irregular') riskPoints += weights.rhythm * 0.53;
            if (entry.rhythm === 'intermittent-afib') riskPoints += weights.rhythm * 0.33;
            if (entry.palpitations === 'frequent' || entry.palpitations === 'constant') riskPoints += weights.rhythm * 0.27;
            if (entry.pacemakerIssues && entry.pacemakerIssues !== 'none') riskPoints += weights.rhythm * 0.2;
            const rhythmRisk = riskPoints - vitalsRisk;
            // PAIN (weights.pain points)
            const chestPain = parseInt(entry.chestPain || 0);
            const bodyPain = parseInt(entry.bodyPain || 0);
            if (chestPain >= 7) riskPoints += weights.pain * 0.4;
            else if (chestPain >= 4) riskPoints += weights.pain * 0.2;
            if (bodyPain >= 7) riskPoints += weights.pain * 0.3;
            else if (bodyPain >= 4) riskPoints += weights.pain * 0.15;
            if (entry.chestPainTrend === 'worse') riskPoints += weights.pain * 0.1;
            if (entry.bodyPainTrend === 'worse') riskPoints += weights.pain * 0.1;
            if (entry.incisionStatus === 'concerning' || entry.incisionStatus === 'separation') riskPoints += weights.pain * 0.3;
            const painRisk = riskPoints - vitalsRisk - rhythmRisk;
            // SYMPTOMS (weights.symptoms points)
            if (entry.shortnessOfBreath === 'at-rest' || entry.shortnessOfBreath === 'night') riskPoints += weights.symptoms * 0.3;
            if (entry.fatigue === 'severe' || entry.fatigue === 'extreme') riskPoints += weights.symptoms * 0.2;
            if (entry.dizziness === 'severe' || entry.dizziness === 'syncope') riskPoints += weights.symptoms * 0.25;
            if (entry.swelling === 'generalized' || entry.swelling === 'abdomen') riskPoints += weights.symptoms * 0.2;
            const symptomsRisk = riskPoints - vitalsRisk - rhythmRisk - painRisk;
            // LABS/MEDS (weights.labs points)
            if (entry.inr) {
                const inr = safeParseFloat(entry.inr);
                if (!isNaN(inr) && (inr < 2.0 || inr > 3.0)) riskPoints += weights.labs * 0.3;
            }
            // Add more for other labs
            const labsRisk = riskPoints - vitalsRisk - rhythmRisk - painRisk - symptomsRisk;
            // ACTIVITY (weights.activity points)
            let adlAvg = 0;
            let adlCount = 0;
            for (let key in entry.adlScores) {
                adlAvg += parseInt(entry.adlScores[key]);
                adlCount++;
            }
            adlAvg = adlAvg / adlCount;
            if (adlAvg < 5) riskPoints += weights.activity * 0.4;
            else if (adlAvg < 7) riskPoints += weights.activity * 0.2;
            const activityRisk = riskPoints - vitalsRisk - rhythmRisk - painRisk - symptomsRisk - labsRisk;
            // PHQ-9 (weights.phq points)
            if (entry.phq9Score >= 20) riskPoints += weights.phq * 1.0;
            else if (entry.phq9Score >= 15) riskPoints += weights.phq * 0.7;
            else if (entry.phq9Score >= 10) riskPoints += weights.phq * 0.5;
            else if (entry.phq9Score >= 5) riskPoints += weights.phq * 0.3;
            const phqRisk = riskPoints - vitalsRisk - rhythmRisk - painRisk - symptomsRisk - labsRisk - activityRisk;
            // Total
            const totalWeight = Object.values(weights).reduce((a, b) => a + b, 0);
            const recoveryScore = Math.max(0, totalWeight - riskPoints);
            let grade, status, className, message;
            if (recoveryScore >= 85) {
                grade = 'A';
                status = 'Excellent Recovery';
                className = 'excellent';
                message = '🎉 Outstanding progress! Recovery is going excellently.';
            } else if (recoveryScore >= 70) {
                grade = 'B';
                status = 'Good Recovery';
                className = 'good';
                message = '👍 Good progress. Continue with current care plan.';
            } else if (recoveryScore >= 50) {
                grade = 'C';
                status = 'Fair - Monitor Closely';
                className = 'fair';
                message = '⚠️ Some concerning signs. Discuss with care team at next appointment.';
            } else if (recoveryScore >= 30) {
                grade = 'D';
                status = 'Poor - Contact Doctor';
                className = 'poor';
                message = '🚨 Multiple concerning symptoms. Contact your care team today.';
            } else {
                grade = 'F';
                status = 'Critical - Seek Immediate Care';
                className = 'critical';
                message = '🚨🚨 CRITICAL: Multiple severe symptoms detected. Call doctor immediately or go to ER.';
            }
            console.log(`Final recovery score: ${recoveryScore}, Grade: ${grade}, Status: ${status}`);
            return {
                recoveryScore, grade, status, className, message,
                subScores: { vitals: weights.vitals - vitalsRisk, rhythm: weights.rhythm - rhythmRisk, pain: weights.pain - painRisk, symptoms: weights.symptoms - symptomsRisk, labs: weights.labs - labsRisk, activity: weights.activity - activityRisk, phq: weights.phq - phqRisk }
            };
        }
        // Section Badges and Dashboard
        function updateSectionBadges(entry) {
            const assessment = calculateRecoveryScore(entry);
            const subs = assessment.subScores;
            const maxes = customWeights;
            ['vitals', 'rhythm', 'pain', 'symptoms', 'meds', 'activity', 'phq'].forEach(sec => {
                const badge = document.getElementById(`${sec}Badge`);
                if (badge) {
                    const sub = subs[sec] || 0;
                    const max = maxes[sec] || 10;
                    const pct = (sub / max) * 100;
                    let color = 'good';
                    if (pct < 50) color = 'bad';
                    else if (pct < 80) color = 'warn';
                    badge.textContent = `${sec.charAt(0).toUpperCase() + sec.slice(1)}: ${color.toUpperCase()}`;
                    badge.className = `section-badge ${color}`;
                }
                const dashPill = document.querySelector(`[onclick="scrollToSection('${sec}Section')"]`);
                if (dashPill) dashPill.className = `dashboard-pill ${color}`;
            });
        }
        function scrollToSection(sectionId) {
            document.getElementById(sectionId)?.scrollIntoView({ behavior: 'smooth' });
        }
        // Tab navigation with unlock
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                if (this.dataset.tab === 'physician-review' && !unlockPhysicianTab()) return;
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('active');
                    b.setAttribute('aria-selected', 'false');
                });
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                this.classList.add('active');
                this.setAttribute('aria-selected', 'true');
                document.getElementById(this.dataset.tab + '-panel').classList.add('active');
            });
            btn.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    btn.click();
                }
            });
        });
        // Auto-save form state (encrypted)
        function saveFormDraft() {
            const formData = {};
            document.querySelectorAll('#dataForm input:not([type="file"]), #dataForm select, #dataForm textarea').forEach(input => {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    formData[input.id] = input.checked;
                } else if (input.multiple) {
                    formData[input.id] = Array.from(input.selectedOptions).map(opt => opt.value);
                } else {
                    formData[input.id] = input.value;
                }
            });
            document.querySelectorAll('.pain-btn.selected, .wellbeing-btn.selected, .adl-btn.selected, .severity-btn.selected, .phq9-option.selected').forEach(btn => {
                formData[btn.dataset.field || btn.dataset.adl || btn.dataset.effect || btn.dataset.question] = btn.dataset.value;
            });
            document.querySelectorAll('.dose-slot').forEach(slot => {
                formData[`${slot.closest('.dose-tracker').id}_${slot.dataset.dose}`] = slot.dataset.status;
            });
            setEncryptedStorage('formDraft', formData);
            logAudit('draft-save');
        }
        // Restore form draft
        function restoreFormDraft() {
            const draft = getEncryptedStorage('formDraft', {});
            Object.keys(draft).forEach(key => {
                const input = document.getElementById(key);
                if (input) {
                    if (input.type === 'checkbox' || input.type === 'radio') {
                        input.checked = draft[key];
                        if (input.checked) input.closest('.checkbox-item')?.classList.add('checked');
                    } else if (input.multiple) {
                        Array.from(input.options).forEach(opt => {
                            opt.selected = draft[key].includes(opt.value);
                        });
                    } else {
                        input.value = draft[key];
                    }
                }
                // Restore scale buttons
                document.querySelectorAll(`[data-field="${key}"], [data-adl="${key}"], [data-effect="${key}"], [data-question="${key}"]`).forEach(btn => {
                    if (btn.dataset.value === draft[key]) {
                        btn.classList.add('selected');
                        if (parseInt(draft[key]) >= 7 && btn.classList.contains('pain-btn')) btn.classList.add('high');
                        if (parseInt(draft[key]) >= 8 && btn.classList.contains('wellbeing-btn')) btn.classList.add('high');
                        if (parseInt(draft[key]) <= 3 && btn.classList.contains('wellbeing-btn')) btn.classList.add('low');
                    }
                });
                // Restore dose trackers
                const [trackerId, dose] = key.split('_');
                if (dose) {
                    const slot = document.querySelector(`#${trackerId} .dose-slot[data-dose="${dose}"]`);
                    if (slot) {
                        slot.dataset.status = draft[key];
                        slot.classList.toggle('taken', draft[key] === 'taken');
                        slot.classList.toggle('missed', draft[key] === 'missed');
                        slot.textContent = `Dose ${dose}${draft[key] === 'taken' ? ' ✓' : draft[key] === 'missed' ? ' ✗' : ''}`;
                    }
                }
            });
            calculateDaysPostOp();
            calculateWeightDeviation();
            calculateFluidBalance();
            checkProviderStatuses();
            updateExerciseComparisons();
            initPHQ9();
            syncAnticoag();
            updateSectionBadges({});
            // Dummy for init
        }
        // Add event listeners for auto-save
        document.querySelectorAll('#dataForm input, #dataForm select, #dataForm textarea, .pain-btn, .wellbeing-btn, .adl-btn, .severity-btn, .phq9-option, .dose-slot').forEach(elem => {
            elem.addEventListener('change', saveFormDraft);
            if (elem.tagName === 'INPUT' || elem.tagName === 'TEXTAREA') {
                elem.addEventListener('input', saveFormDraft);
            }
        });
        // Clear draft on submit or clear
        document.getElementById('dataForm').addEventListener('submit', function (e) {
            localStorage.removeItem('formDraft'); // Clear unencrypted too for safety
            setEncryptedStorage('formDraft', {});
        });
        document.getElementById('clearForm').addEventListener('click', function () {
            if (confirm('Clear all form fields?')) {
                setEncryptedStorage('formDraft', {});
            }
        });
        // Restore draft on load
        document.addEventListener('DOMContentLoaded', restoreFormDraft);
        // Initialize saved context
        const savedProcedures = getEncryptedStorage('procedures', []);
        const savedHospitalStay = getEncryptedStorage('hospitalStay');
        const savedHospitalComplications = getEncryptedStorage('hospitalComplications');
        if (savedProcedures.length) {
            document.querySelectorAll('#procedures option').forEach(opt => {
                if (savedProcedures.includes(opt.value)) opt.selected = true;
            });
        }
        if (savedHospitalStay) document.getElementById('hospitalStay').value = savedHospitalStay;
        if (savedHospitalComplications) document.getElementById('hospitalComplications').value = savedHospitalComplications;
        // Save context to encrypted storage
        document.getElementById('procedures').addEventListener('change', function () {
            const selected = Array.from(this.selectedOptions).map(opt => opt.value);
            setEncryptedStorage('procedures', selected);
            logAudit('update-procedures', { procedures: selected });
        });
        document.getElementById('hospitalStay').addEventListener('change', function () {
            setEncryptedStorage('hospitalStay', this.value);
            logAudit('update-hospital-stay', { days: this.value });
        });
        document.getElementById('hospitalComplications').addEventListener('change', function () {
            setEncryptedStorage('hospitalComplications', this.value);
            logAudit('update-hospital-complications', { complication: this.value });
        });
        // Modals
        function openScoringModal() {
            document.getElementById('scoringModal').style.display = 'block';
            logAudit('view-scoring-guide');
        }
        function closeScoringModal() {
            document.getElementById('scoringModal').style.display = 'none';
        }
        function openWhatsNewModal() {
            document.getElementById('whatsNewModal').style.display = 'block';
        }
        function closeWhatsNewModal() {
            document.getElementById('whatsNewModal').style.display = 'none';
        }
        window.onclick = function (event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
        // Form submission with validation, toast, pinned, etc.
        document.getElementById('dataForm').addEventListener('submit', function (e) {
            e.preventDefault();
            // Validate required fields
            const requiredFields = ['entryDate', 'entryTime'];
            let isValid = true;
            requiredFields.forEach(id => {
                const field = document.getElementById(id);
                if (!field.value) {
                    field.style.borderColor = 'var(--bad)';
                    isValid = false;
                }
            });
            if (!isValid) {
                alert('Please fill in all required fields (Date, Time).');
                return;
            }
            // Collect data
            const formData = {
                date: document.getElementById('entryDate').value,
                time: document.getElementById('entryTime').value,
                originalSymptoms: Array.from(document.querySelectorAll('#originalSymptomsGroup input:checked')).map(cb => cb.value),
                procedures: Array.from(document.getElementById('procedures').selectedOptions).map(opt => opt.value),
                hospitalStay: document.getElementById('hospitalStay').value,
                hospitalComplications: document.getElementById('hospitalComplications').value,
                weight: document.getElementById('weight').value,
                bloodPressure: document.getElementById('bloodPressure').value,
                heartRate: document.getElementById('heartRate').value,
                oxygenSat: document.getElementById('oxygenSat').value,
                temperature: document.getElementById('temperature').value,
                respRate: document.getElementById('respRate').value,
                rhythm: document.getElementById('rhythm').value,
                palpitations: document.getElementById('palpitations').value,
                pacemakerIssues: document.getElementById('pacemakerIssues').value,
                chestPain: document.querySelector('#chestPainScale .selected')?.dataset.value,
                bodyPain: document.querySelector('#bodyPainScale .selected')?.dataset.value,
                chestPainTrend: document.getElementById('chestPainTrend').value,
                bodyPainTrend: document.getElementById('bodyPainTrend').value,
                painLocation: document.getElementById('painLocation').value,
                painType: document.getElementById('painType').value,
                incisionStatus: document.getElementById('incisionStatus').value,
                painPosition: document.getElementById('painPosition').value,
                painTrigger: document.getElementById('painTrigger').value,
                painActivity: document.getElementById('painActivity').value,
                drainageAmount: document.getElementById('drainageAmount').value,
                drainageColor: document.getElementById('drainageColor').value,
                woundWarmth: document.getElementById('woundWarmth').value,
                rednessExtent: document.getElementById('rednessExtent').value,
                woundEdges: document.getElementById('woundEdges').value,
                surroundingSkin: document.getElementById('surroundingSkin').value,
                woundPhotos: window.woundPhotosData || [],
                shortnessOfBreath: document.getElementById('shortnessOfBreath').value,
                fatigue: document.getElementById('fatigue').value,
                dizziness: document.getElementById('dizziness').value,
                swelling: document.getElementById('swelling').value,
                nausea: document.getElementById('nausea').value,
                sleepHours: document.getElementById('sleepHours').value,
                sleepPosition: document.getElementById('sleepPosition').value,
                wakingSOB: document.getElementById('wakingSOB').value,
                cough: document.getElementById('cough').value,
                mood: document.getElementById('mood').value,
                sternumClicking: document.getElementById('sternumClicking').value,
                bowelMovement: document.getElementById('bowelMovement').value,
                stoolConsistency: document.getElementById('stoolConsistency').value,
                bmStraining: document.getElementById('bmStraining').value,
                complicationSymptoms: Array.from(document.querySelectorAll('input[name="pericardiotomy"]:checked, input[name="pleural"]:checked, input[name="pericardial"]:checked, input[name="tamponade"]:checked')).map(cb => cb.value),
                liftingCompliance: document.getElementById('liftingCompliance').value,
                pushPullCompliance: document.getElementById('pushPullCompliance').value,
                armMovement: document.getElementById('armMovement').value,
                drivingStatus: document.getElementById('drivingStatus').value,
                coughSplinting: document.getElementById('coughSplinting').value,
                sternumShift: document.getElementById('sternumShift').value,
                adlScores: {},
                fluidRestriction: document.getElementById('fluidRestriction').value,
                fluidIntake: document.getElementById('fluidIntake').value,
                urineOutput: document.getElementById('urineOutput').value,
                urineColor: document.getElementById('urineColor').value,
                diuretic: document.getElementById('diuretic').value,
                diureticFreq: document.getElementById('diureticFreq').value,
                anticoagType: document.getElementById('anticoagType').value,
                anticoagDose: document.getElementById('anticoagDose').value,
                anticoagulantFreq: document.getElementById('anticoagulantFreq').value,
                betaBlocker: document.getElementById('betaBlocker').value,
                betaBlockerFreq: document.getElementById('betaBlockerFreq').value,
                antiarrhythmic: document.getElementById('antiarrhythmic').value,
                antiarrhythmicFreq: document.getElementById('antiarrhythmicFreq').value,
                aceInhibitor: document.getElementById('aceInhibitor').value,
                aceInhibitorFreq: document.getElementById('aceInhibitorFreq').value,
                painMed: document.getElementById('painMed').value,
                painMedFreq: document.getElementById('painMedFreq').value,
                potassium: document.getElementById('potassium').value,
                potassiumFreq: document.getElementById('potassiumFreq').value,
                otherCardiacMeds: document.getElementById('otherCardiacMeds').value,
                otherCardiacMedsFreq: document.getElementById('otherCardiacMedsFreq').value,
                missedDoseReasons: document.getElementById('missedDoseReasons').value,
                sideEffects: {},
                onWarfarin: document.getElementById('onWarfarin').value,
                vitaminKConsistency: document.getElementById('vitaminKConsistency').value,
                vitaminKFoods: Array.from(document.querySelectorAll('input[name="vitaminK"]:checked')).map(cb => cb.value),
                vitaminKServings: document.getElementById('vitaminKServings').value,
                vitaminKSupplement: document.getElementById('vitaminKSupplement').value,
                vitaminKNotes: document.getElementById('vitaminKNotes').value,
                walkingSessions: Array.from(document.querySelectorAll('#walkingSessionsContainer input')).map(inp => inp.value),
                steps: document.getElementById('steps').value,
                cardiacRehab: document.getElementById('cardiacRehab').value,
                activityTolerance: document.getElementById('activityTolerance').value,
                stairs: document.getElementById('stairs').value,
                exerciseSOB: document.getElementById('exerciseSOB').value,
                walkTargetDistance: document.getElementById('walkTargetDistance').value,
                walkActualDistance: document.getElementById('walkActualDistance').value,
                exerciseTargetDuration: document.getElementById('exerciseTargetDuration').value,
                exerciseActualDuration: document.getElementById('exerciseActualDuration').value,
                exerciseTargetHR: document.getElementById('exerciseTargetHR').value,
                exerciseActualHR: document.getElementById('exerciseActualHR').value,
                exerciseMaxHR: document.getElementById('exerciseMaxHR').value,
                exercisePeakHR: document.getElementById('exercisePeakHR').value,
                exerciseNotes: document.getElementById('exerciseNotes').value,
                nextRehabDate: document.getElementById('nextRehabDate').value,
                rehabFrequency: document.getElementById('rehabFrequency').value,
                therapistNotes: document.getElementById('therapistNotes').value,
                cycleStatus: document.getElementById('cycleStatus').value,
                cycleDay: document.getElementById('cycleDay').value,
                daysRelativeToPeriod: document.getElementById('daysRelativeToPeriod').value,
                flowHeaviness: document.getElementById('flowHeaviness').value,
                hormonalSymptoms: document.getElementById('hormonalSymptoms').value,
                wellbeingScore: document.querySelector('#wellbeingScale .selected')?.dataset.value,
                wellbeingSummary: document.getElementById('wellbeingSummary').value,
                phq9Score: parseInt(document.getElementById('phq9Score').textContent) || 0,
                phq9Severity: document.getElementById('phq9Severity').textContent,
                warningSymptoms: Array.from(document.querySelectorAll('input[name="symptom"]:checked')).map(cb => cb.value),
                notes: document.getElementById('notes').value,
                bpDeviceBrand: document.getElementById('bpDeviceBrand').value,
                bpDeviceReading: document.getElementById('bpDeviceReading').value,
                bpDevicePulse: document.getElementById('bpDevicePulse').value,
                bpArm: document.getElementById('bpArm').value,
                bpPosition: document.getElementById('bpPosition').value,
                pulseOxBrand: document.getElementById('pulseOxBrand').value,
                pulseOxReading: document.getElementById('pulseOxReading').value,
                pulseOxHR: document.getElementById('pulseOxHR').value,
                pulseOxFinger: document.getElementById('pulseOxFinger').value,
                pulseOxQuality: document.getElementById('pulseOxQuality').value,
                scaleBrand: document.getElementById('scaleBrand').value,
                scaleReading: document.getElementById('scaleReading').value,
                scaleTimimg: document.getElementById('scaleTimimg').value,
                pacemakerSystem: document.getElementById('pacemakerSystem').value,
                pacemakerTransmission: document.getElementById('pacemakerTransmission').value,
                pacemakerAlerts: document.getElementById('pacemakerAlerts').value,
                pacemakerAtrialPaced: document.getElementById('pacemakerAtrialPaced').value,
                pacemakerVentricularPaced: document.getElementById('pacemakerVentricularPaced').value,
                pacemakerBattery: document.getElementById('pacemakerBattery').value,
                pacemakerAtrialImpedance: document.getElementById('pacemakerAtrialImpedance').value,
                pacemakerVentricularImpedance: document.getElementById('pacemakerVentricularImpedance').value,
                pacemakerData: document.getElementById('pacemakerData').value,
                deviceNotes: document.getElementById('deviceNotes').value,
                physAnticoagType: document.getElementById('physAnticoagType').value,
                physAnticoagDose: document.getElementById('physAnticoagDose').value,
                inrProvider: document.getElementById('inrProvider').value,
                inrProviderName: document.getElementById('inrProviderName').value,
                inrProviderPhone: document.getElementById('inrProviderPhone').value,
                todayINR: document.getElementById('todayINR').value,
                todayWarfarinDose: document.getElementById('todayWarfarinDose').value,
                warfarinDoseChange: document.getElementById('warfarinDoseChange').value,
                warfarinNewDoseInstructions: document.getElementById('warfarinNewDoseInstructions').value,
                nextINRDate: document.getElementById('nextINRDate').value,
                nextINRLocation: document.getElementById('nextINRLocation').value,
                nextINRTime: document.getElementById('nextINRTime').value,
                inrHistory: Array.from(document.querySelectorAll('#inrHistoryContainer .inr-history-item')).map(item => {
                    const inputs = item.querySelectorAll('input');
                    return { date: inputs[0].value, inr: inputs[1].value, dose: inputs[2].value };
                }),
                anticoagNotes: document.getElementById('anticoagNotes').value,
                inr: document.getElementById('inr').value,
                potassiumLevel: document.getElementById('potassiumLevel').value,
                magnesiumLevel: document.getElementById('magnesiumLevel').value,
                bnp: document.getElementById('bnp').value,
                creatinine: document.getElementById('creatinine').value,
                hemoglobin: document.getElementById('hemoglobin').value,
                rbc: document.getElementById('rbc').value,
                wbc: document.getElementById('wbc').value,
                crp: document.getElementById('crp').value,
                fibrinogen: document.getElementById('fibrinogen').value,
                nextLabDate: document.getElementById('nextLabDate').value,
                pcpName: document.getElementById('pcpName').value,
                pcpPhone: document.getElementById('pcpPhone').value,
                pcpLastContact: document.getElementById('pcpLastContact').value,
                pcpNextAppt: document.getElementById('pcpNextAppt').value,
                pcpInterval: document.getElementById('pcpInterval').value,
                cardioName: document.getElementById('cardioName').value,
                cardioPhone: document.getElementById('cardioPhone').value,
                cardioLastContact: document.getElementById('cardioLastContact').value,
                cardioNextAppt: document.getElementById('cardioNextAppt').value,
                cardioInterval: document.getElementById('cardioInterval').value,
                surgeonName: document.getElementById('surgeonName').value,
                surgeonPhone: document.getElementById('surgeonPhone').value,
                surgeonLastContact: document.getElementById('surgeonLastContact').value,
                surgeonNextAppt: document.getElementById('surgeonNextAppt').value,
                surgeonInterval: document.getElementById('surgeonInterval').value,
                epName: document.getElementById('epName').value,
                epPhone: document.getElementById('epPhone').value,
                epLastContact: document.getElementById('epLastContact').value,
                epNextAppt: document.getElementById('epNextAppt').value,
                epInterval: document.getElementById('epInterval').value,
                rehabName: document.getElementById('rehabName').value,
                rehabPhone: document.getElementById('rehabPhone').value,
                rehabLastSession: document.getElementById('rehabLastSession').value,
                rehabSessionsPerWeek: document.getElementById('rehabSessionsPerWeek').value,
                rehabTotalSessions: document.getElementById('rehabTotalSessions').value,
                rehabCompletedSessions: document.getElementById('rehabCompletedSessions').value,
                recoveryOutcomes: Array.from(document.querySelectorAll('input[name="recoveryOutcome"]:checked')).map(cb => cb.value),
                eventDate: document.getElementById('eventDate').value,
                whatHappened: document.getElementById('whatHappened').value,
                interventions: document.getElementById('interventions').value,
                patientResponse: document.getElementById('patientResponse').value
            };
            document.querySelectorAll('.adl-scale').forEach(scale => {
                const selected = scale.querySelector('.adl-btn.selected');
                if (selected) formData.adlScores[scale.dataset.adl] = parseInt(selected.dataset.value);
            });
            document.querySelectorAll('.severity-scale').forEach(scale => {
                const selected = scale.querySelector('.severity-btn.selected');
                if (selected) formData.sideEffects[scale.dataset.effect] = parseInt(selected.dataset.value);
            });
            const oldLength = entries.length;
            const recoveryAssessment = calculateRecoveryScore(formData);
            formData.recoveryAssessment = recoveryAssessment;
            formData.usedCustom = physicianUnlocked;
            entries.unshift(formData);
            setEncryptedStorage('cardiacEntries', entries);
            syncToBackend(formData)
                .then(() => console.log('Entry synced successfully'))
                .catch(error => console.error('Sync error:', error));
            logAudit('save-entry', { score: recoveryAssessment.recoveryScore });
            // Update legend and why-status
            document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
            const pillMap = { excellent: 'normalPill', good: 'normalPill', fair: 'watchPill', poor: 'alertPill', critical: 'alertPill' };
            document.getElementById(pillMap[recoveryAssessment.className]).classList.add('active');
            let breakdown = '';
            for (let [k, v] of Object.entries(recoveryAssessment.subScores)) {
                breakdown += `${k}: ${v}/${weights[k]}<br>`;
            }
            document.getElementById('statusBreakdown').innerHTML = breakdown;
            document.getElementById('whyStatus').classList.add('open');
            // Toast
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = `Logged: ${formData.date} - Score ${recoveryAssessment.recoveryScore}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
            // Alert
            if (recoveryAssessment.className === 'critical') {
                alert('🚨 CRITICAL RECOVERY SCORE!\n\n' + recoveryAssessment.message + '\n\nPlease contact your medical provider immediately.');
            } else {
                alert('✅ Entry saved successfully!\n\nRecovery Score: ' + recoveryAssessment.recoveryScore + '/100 (Grade ' + recoveryAssessment.grade + ')\n' + recoveryAssessment.status);
            }
            // Re-render and scroll
            renderEntries(true);
            document.getElementById('entriesContainer').scrollIntoView({ behavior: 'smooth' });
            // Post-save check
            if (entries.length !== oldLength + 1) {
                alert('Save may have failed. Please retry.');
                entries = getEncryptedStorage('cardiacEntries', []);
            }
            // Clear form
            document.getElementById('clearForm').click();
        });
        // Filter entries
        function filterEntries() {
            const searchTerm = document.getElementById('historySearch').value.toLowerCase();
            const dateStart = document.getElementById('historyDateStart').value;
            const dateEnd = document.getElementById('historyDateEnd').value;
            const filterFn = entry => {
                let matchesSearch = true;
                let matchesDate = true;
                if (searchTerm) {
                    matchesSearch = (
                        (entry.notes || '').toLowerCase().includes(searchTerm) ||
                        (entry.wellbeingSummary || '').toLowerCase().includes(searchTerm) ||
                        (entry.recoveryAssessment?.status || '').toLowerCase().includes(searchTerm) ||
                        (entry.therapistNotes || '').toLowerCase().includes(searchTerm)
                    );
                }
                if (dateStart || dateEnd) {
                    const entryDate = new Date(entry.date);
                    if (dateStart) {
                        const start = new Date(dateStart);
                        matchesDate = matchesDate && entryDate >= start;
                    }
                    if (dateEnd) {
                        const end = new Date(dateEnd);
                        matchesDate = matchesDate && entryDate <= end;
                    }
                }
                return matchesSearch && matchesDate;
            };
            renderEntries(false, filterFn);
        }
        document.getElementById('historySearch').addEventListener('input', filterEntries);
        document.getElementById('historyDateStart').addEventListener('change', filterEntries);
        document.getElementById('historyDateEnd').addEventListener('change', filterEntries);
        // Render entries with pinned, incremental
        function renderEntries(incremental = false, filterFn = null) {
            const container = document.getElementById('entriesContainer');
            const filteredEntries = filterFn ? entries.filter(filterFn) : entries;
            if (filteredEntries.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty-state';
                emptyDiv.innerHTML = `
                    <p style="font-size:3rem;margin-bottom:12px">💓</p>
                    <p>No entries yet. Create your first entry above!</p>
                `;
                container.innerHTML = '';
                container.appendChild(emptyDiv);
                document.getElementById('chartsContainer').style.display = 'none';
                return;
            }
            document.getElementById('chartsContainer').style.display = 'block';
            if (!incremental) {
                container.innerHTML = '';
            }
            const entriesToRender = incremental ? [filteredEntries[0]] : filteredEntries;
            entriesToRender.forEach((entry, index) => {
                const entryCard = document.createElement('div');
                entryCard.className = `entry-card ${index === 0 ? 'pinned' : ''}`;
                const assessment = entry.recoveryAssessment;
                entryCard.innerHTML = `
                    <div class="entry-header">
                        <span class="entry-date">${entry.date}</span>
                        <span class="entry-time">${entry.time}</span>
                    </div>
                    <div class="recovery-score-display ${assessment.className}">
                        <div>
                            <div class="score-number">${assessment.recoveryScore}</div>
                            <div class="score-grade">${assessment.grade}</div>
                        </div>
                        <div class="score-label">${assessment.status}</div>
                    </div>
                    <div class="entry-data">
                        <div class="data-point">
                            <div class="data-label">Heart Rate</div>
                            <div class="data-value">${entry.heartRate || 'N/A'} bpm</div>
                        </div>
                        <div class="data-point">
                            <div class="data-label">O₂ Sat</div>
                            <div class="data-value">${entry.oxygenSat || 'N/A'}%</div>
                        </div>
                        <div class="data-point">
                            <div class="data-label">Weight</div>
                            <div class="data-value">${entry.weight || 'N/A'}</div>
                        </div>
                        <!-- Add more data points as needed -->
                    </div>
                `;
                if (incremental) {
                    container.insertBefore(entryCard, container.firstChild);
                } else {
                    container.appendChild(entryCard);
                }
            });
            // Update charts
            updateCharts(filteredEntries);
            // Update analytics
            updateAnalytics(filteredEntries);
        }
        // Update Charts with Chart.js
        function updateCharts(filteredEntries) {
            const ctxWeight = document.getElementById('weightChart').getContext('2d');
            const ctxPain = document.getElementById('painChart').getContext('2d');
            const ctxPhq = document.getElementById('phq9Chart').getContext('2d');
            const dates = filteredEntries.map(e => e.date).reverse();
            const weights = filteredEntries.map(e => e.weight).reverse();
            const chestPains = filteredEntries.map(e => e.chestPain).reverse();
            const phqScores = filteredEntries.map(e => e.phq9Score).reverse();
            new Chart(ctxWeight, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Weight',
                        data: weights,
                        borderColor: var(--accent),
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: false }
                    }
                }
            });
            new Chart(ctxPain, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Chest Pain',
                        data: chestPains,
                        borderColor: var(--pink),
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { min: 0, max: 10 }
                    }
                }
            });
            new Chart(ctxPhq, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'PHQ-9 Score',
                        data: phqScores,
                        borderColor: var(--cyan),
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { min: 0, max: 27 }
                    }
                }
            });
        }
        // Enhanced Analytics
        function updateAnalytics(filteredEntries) {
            if (filteredEntries.length < 2) return;
            // Correlation matrix
            const vars = ['heartRate', 'oxygenSat', 'weight', 'chestPain', 'phq9Score'];
            const data = vars.map(v => filteredEntries.map(e => parseFloat(e[v]) || 0));
            const correlationMatrix = math.correlation(data);
            console.log('Correlation Matrix:', correlationMatrix);
            // Predictive trend - simple linear regression for weight
            const x = Array.from({length: filteredEntries.length}, (_, i) => i);
            const y = data[2]; // weight
            const slope = math.lsReg(x, y).slope;
            if (slope > 0.5) {
                alert('Trend Alert: Weight increasing rapidly. Monitor fluid intake.');
            }
            // Recovery trajectory - assume typical is linear decrease in pain
            const typicalPain = [8, 6, 4, 2, 1]; // example
            // Pattern recognition for complications
            if (filteredEntries[0].shortnessOfBreath === 'at-rest' && filteredEntries[0].oxygenSat < 92) {
                alert('Pattern Alert: Possible pulmonary complication.');
            }
        }
        // Device Integration - Web Bluetooth
        async function connectBPDevice() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [0x1810] }] // Blood Pressure service UUID
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(0x1810);
                const characteristic = await service.getCharacteristic(0x2A35); // Blood Pressure Measurement
                const value = await characteristic.readValue();
                const bp = parseIEEE11073Float(value); // Implement parser
                document.getElementById('bloodPressure').value = bp.sys + '/' + bp.dia;
                document.getElementById('heartRate').value = bp.pulse;
            } catch (error) {
                console.error('BP connect error:', error);
                alert('Failed to connect to BP device.');
            }
        }
        async function connectPulseOxDevice() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [0x1822] }] // Pulse Oximeter service UUID
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(0x1822);
                const characteristic = await service.getCharacteristic(0x2A5F); // PLX Spot-Check Measurement
                const value = await characteristic.readValue();
                const ox = parseIEEE11073Float(value); // Implement parser
                document.getElementById('oxygenSat').value = ox.spO2;
                document.getElementById('heartRate').value = ox.pulse;
            } catch (error) {
                console.error('Pulse Ox connect error:', error);
                alert('Failed to connect to Pulse Ox device.');
            }
        }
        // IEEE 11073 Parser (32-bit FLOAT)
        function parseIEEE11073Float(dataview) {
            const exponent = dataview.getInt8(3);
            let mantissa = dataview.getInt32(0, true) & 0x00ffffff;
            if (mantissa >= Math.pow(2, 23)) mantissa -= Math.pow(2, 24);
            return mantissa * Math.pow(10, exponent);
        }
        // Real-time validation
        function addRealTimeValidation() {
            const validations = [
                {
                    id: 'heartRate',
                    validate: val => {
                        const num = parseInt(val);
                        if (isNaN(num)) return { valid: false, message: 'Please enter a valid number' };
                        if (num < 50 || num > 110) return { valid: false, message: 'Heart rate is outside safe range (50-110 bpm)' };
                        if (num < 55 || num > 100) return { valid: false, message: 'Heart rate is outside target range (55-100 bpm)', warn: true };
                        return { valid: true };
                    }
                },
                {
                    id: 'oxygenSat',
                    validate: val => {
                        const num = parseInt(val);
                        if (isNaN(num)) return { valid: false, message: 'Please enter a valid number' };
                        if (num < 90) return { valid: false, message: 'O2 saturation critically low (<90%)' };
                        if (num < 92) return { valid: false, message: 'O2 saturation low (<92%)', warn: true };
                        return { valid: true };
                    }
                },
                // Add more validations for other fields
            ];
            validations.forEach(({ id, validate }) => {
                const input = document.getElementById(id);
                const errorEl = document.getElementById(`${id}Error`);
                if (input && errorEl) {
                    input.addEventListener('input', function () {
                        const result = validate(this.value);
                        if (!result.valid) {
                            errorEl.textContent = result.message;
                            errorEl.style.display = 'block';
                            this.style.borderColor = result.warn ? 'var(--warn)' : 'var(--bad)';
                        } else {
                            errorEl.style.display = 'none';
                            this.style.borderColor = 'rgba(255,255,255,0.12)';
                        }
                    });
                }
            });
        }
        addRealTimeValidation();
        // Initial render
        renderEntries();
    </script>
</body>

</html>